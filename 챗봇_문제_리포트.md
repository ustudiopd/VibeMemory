# 챗봇 기능 문제 리포트

## 문제 개요
프로젝트 상세 페이지의 챗봇 탭에서 질문을 입력하고 전송하면, AI 응답이 표시되지 않고 콘솔에 에러가 발생합니다.

## 에러 메시지
```
Invalid prompt: The messages must be a ModelMessage[]. If you have passed a UIMessage[], you can use convertToModelMessages to convert them.
```

## 발생 위치
- **프론트엔드**: `components/ChatInterface.tsx`
- **백엔드**: `app/api/projects/[id]/chat/route.ts`

## 문제 분석

### 1. 메시지 형식 불일치
- `useChat` 훅이 보내는 메시지는 `UIMessage[]` 형식입니다.
- `streamText` 함수는 `ModelMessage[]` 형식을 기대합니다.
- 현재 코드에서 `convertToModelMessages()`를 사용하여 변환을 시도했지만, 여전히 에러가 발생합니다.

### 2. 스트리밍 응답 형식 문제
- `toTextStreamResponse()`를 사용하여 응답을 반환하고 있습니다.
- `useChat` 훅이 기대하는 스트리밍 형식과 일치하지 않을 수 있습니다.
- `DefaultChatTransport`가 어떤 형식을 기대하는지 명확하지 않습니다.

### 3. 현재 코드 상태

#### `app/api/projects/[id]/chat/route.ts`
```typescript
// useChat이 보낸 UIMessage[]를 ModelMessage[]로 변환
const modelMessages = convertToModelMessages(messages);

const messagesWithContext = [
  { role: 'system' as const, content: systemPrompt },
  ...modelMessages.slice(0, -1), // Previous messages
  {
    role: 'user' as const,
    content: userPrompt,
  },
];

// Stream response
const result = await streamText({
  model: openai(MODEL),
  messages: messagesWithContext,
  temperature: 0.7,
});

return result.toTextStreamResponse();
```

#### `components/ChatInterface.tsx`
```typescript
const { messages, sendMessage, status, error } = useChat({
  transport: new DefaultChatTransport({
    api: apiEndpoint,
    body: {
      projectId: projectId || null,
    },
  }),
  onError: (error) => {
    console.error('[ChatInterface] Error:', error);
  },
});
```

## 시도한 해결 방법

1. ✅ `convertToModelMessages()` import 및 사용
   - `ai` 패키지에서 `convertToModelMessages` 함수를 import하여 사용했습니다.
   - 하지만 여전히 에러가 발생합니다.

2. ❌ `toUIMessageStreamResponse()` 사용 시도
   - `toUIMessageStreamResponse()`를 사용하려고 했지만, 이 함수는 `UIMessage[]`를 기대하는데, 우리는 `ModelMessage[]`를 전달하고 있어서 에러가 발생했습니다.

3. ❌ `toDataStreamResponse()` 사용 시도
   - `toDataStreamResponse()` 함수가 존재하지 않습니다.

## 근본 원인 추정

1. **메시지 변환 타이밍 문제**
   - `convertToModelMessages()`가 제대로 작동하지 않거나, 변환된 메시지가 `streamText`에 전달되기 전에 형식이 손상될 수 있습니다.

2. **스트리밍 응답 파싱 문제**
   - `toTextStreamResponse()`가 반환하는 형식이 `DefaultChatTransport`가 기대하는 형식과 일치하지 않을 수 있습니다.
   - `useChat` 훅이 스트리밍 응답을 파싱할 때 문제가 발생할 수 있습니다.

3. **AI SDK 버전 호환성 문제**
   - `@ai-sdk/react`의 `useChat` 훅과 `ai` 패키지의 `streamText` 함수 간의 버전 호환성 문제가 있을 수 있습니다.

## 권장 해결 방법

### 방법 1: `toUIMessageStreamResponse()` 사용 (권장)
```typescript
// messages를 그대로 전달 (변환하지 않음)
const messagesWithContext = [
  { role: 'system' as const, content: systemPrompt },
  ...messages.slice(0, -1), // Previous messages
  {
    role: 'user' as const,
    content: userPrompt,
  },
];

const result = await streamText({
  model: openai(MODEL),
  messages: convertToModelMessages(messagesWithContext), // 여기서만 변환
  temperature: 0.7,
});

// UIMessage 형식으로 반환
return result.toUIMessageStreamResponse();
```

### 방법 2: `DefaultChatTransport` 대신 직접 fetch 사용
```typescript
// ChatInterface.tsx에서
const sendMessage = async (message: string) => {
  const response = await fetch(apiEndpoint, {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({
      messages: [...messages, { role: 'user', content: message }],
      projectId,
    }),
  });

  const reader = response.body?.getReader();
  const decoder = new TextDecoder();
  
  // 스트리밍 응답 처리
  // ...
};
```

### 방법 3: AI SDK 문서 확인 및 예제 참조
- `@ai-sdk/react` 공식 문서에서 `useChat`과 `streamText`를 함께 사용하는 예제를 확인
- 특히 `DefaultChatTransport`와 `toTextStreamResponse()`의 호환성 확인

## 필요한 추가 조사

1. **AI SDK 버전 확인**
   - `package.json`에서 `ai`와 `@ai-sdk/react` 버전 확인
   - 최신 버전으로 업데이트 필요 여부 확인

2. **공식 문서 및 예제 확인**
   - Vercel AI SDK 공식 문서에서 `useChat`과 `streamText` 사용 예제 확인
   - 특히 프로젝트별 챗봇 구현 예제 확인

3. **네트워크 요청/응답 로깅**
   - 브라우저 개발자 도구에서 실제 네트워크 요청/응답 형식 확인
   - 서버 로그에서 받은 메시지 형식 확인

## 현재 상태
- ❌ 챗봇 기능이 작동하지 않음
- ✅ 메시지 전송은 성공 (프론트엔드 → 백엔드)
- ❌ AI 응답 수신 실패 (백엔드 → 프론트엔드)
- ❌ 스트리밍 응답 파싱 실패

## 우선순위
**높음** - 챗봇은 프로젝트의 핵심 기능 중 하나이므로 빠른 해결이 필요합니다.

## 참고 자료
- [Vercel AI SDK Documentation](https://sdk.vercel.ai/docs)
- [useChat Hook Documentation](https://sdk.vercel.ai/docs/reference/ai-sdk-ui/use-chat)
- [streamText Function Documentation](https://sdk.vercel.ai/docs/reference/ai-sdk-core/stream-text)

