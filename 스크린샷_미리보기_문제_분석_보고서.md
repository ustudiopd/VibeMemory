# 스크린샷 미리보기 검은색 표시 문제 분석 보고서

## 📋 문제 개요

**증상**: 스크린샷 업로드는 성공하지만, 미리보기에서 이미지가 검은색으로 표시됨
- 업로드: ✅ 성공
- Storage 저장: ✅ 성공
- Signed URL 생성: ✅ 성공
- 미리보기 표시: ❌ 검은색으로 표시
- 모달 확대: ✅ 정상 작동 (클릭 시 이미지 표시)
- 새로고침 후: 잠깐 보였다가 검은색으로 변함

## 🔍 현재 상태 분석

### 1. 네트워크 요청 상태
- ✅ `/api/projects/[id]/screenshots` - 스크린샷 목록 조회 성공
- ✅ `/api/projects/[id]/screenshots/[id]/url` - Signed URL 생성 성공
- ✅ Supabase Storage Signed URL 요청 성공
- ✅ 이미지 파일 다운로드 성공 (네트워크 탭 확인)

### 2. DOM 구조 분석
```
<div class="aspect-[4/3] bg-gray-100 ...">
  <div class="absolute inset-0 bg-gray-100 z-0"></div>  <!-- 배경 -->
  <img src="[signed-url]" class="... z-10" />           <!-- 이미지 -->
  <div class="absolute inset-0 bg-black bg-opacity-0 ... z-20"></div>  <!-- 호버 오버레이 -->
</div>
```

### 3. 이미지 로딩 상태
- `imageLoading`: 초기 `true` → URL 가져온 후에도 `true` 유지 → `onLoad`에서 `false`
- `imageUrl`: Signed URL이 정상적으로 설정됨
- `imageError`: `false` (에러 없음)

## 🐛 문제 원인 분석

### 가설 1: 이미지 로딩 타이밍 문제
**증상**: 새로고침 시 잠깐 보였다가 검은색으로 변함
**원인 추정**:
- 이미지가 로드되기 전에 `imageLoading`이 `false`로 변경되어 조건부 렌더링이 변경됨
- 또는 이미지가 로드된 후 상태 업데이트로 인한 재렌더링

**검증 필요**:
- `onLoad` 이벤트가 실제로 발생하는지 확인
- 상태 변경 시점과 이미지 렌더링 시점의 동기화 문제

### 가설 2: CSS z-index 및 레이어링 문제
**증상**: 검은색 배경이 이미지 위에 표시됨
**원인 추정**:
- 호버 오버레이(`bg-black`)가 이미지 위에 올라옴
- `bg-opacity-0`이 제대로 적용되지 않음
- 또는 다른 검은색 요소가 이미지를 가림

**검증 필요**:
- 실제 렌더링된 DOM의 z-index 값 확인
- 호버 오버레이의 실제 opacity 값 확인
- 브라우저 개발자 도구로 레이어 구조 확인

### 가설 3: 이미지 자체의 문제
**증상**: 이미지가 검은색으로 표시됨
**원인 추정**:
- 이미지 파일이 실제로 검은색 이미지일 수 있음
- 이미지가 손상되었을 수 있음
- 이미지 형식 문제 (투명도, 색상 프로파일 등)

**검증 필요**:
- Storage에서 직접 이미지 다운로드하여 확인
- 이미지 메타데이터 확인
- 다른 이미지로 테스트

### 가설 4: Signed URL 만료 또는 권한 문제
**증상**: 이미지가 로드되지 않음
**원인 추정**:
- Signed URL이 만료됨 (1시간 유효기간)
- RLS 정책 문제
- CORS 문제

**검증 필요**:
- Signed URL을 직접 브라우저에서 열어보기
- 네트워크 탭에서 이미지 요청 상태 코드 확인
- 콘솔 에러 메시지 확인

### 가설 5: React 상태 관리 및 리렌더링 문제
**증상**: 새로고침 시 잠깐 보였다가 사라짐
**원인 추정**:
- 상태 업데이트로 인한 불필요한 리렌더링
- 조건부 렌더링 로직의 경쟁 조건(race condition)
- `useEffect` 의존성 배열 문제

**검증 필요**:
- React DevTools로 상태 변경 추적
- 리렌더링 횟수 및 시점 확인
- `useEffect` 실행 순서 확인

## 🔧 시도한 해결책

### 1. Signed URL 유효기간 연장
- **변경**: 60초 → 3600초 (1시간)
- **결과**: ❌ 문제 지속

### 2. 배경색 변경
- **변경**: `bg-gray-100` → `bg-gray-200` → 다시 `bg-gray-100`
- **결과**: ❌ 문제 지속

### 3. 이미지 로딩 상태 관리 개선
- **변경**: `imageLoading` 상태를 이미지 `onLoad`에서만 `false`로 설정
- **결과**: ❌ 문제 지속

### 4. 호버 오버레이 조건부 렌더링 제거
- **변경**: 호버 오버레이를 항상 렌더링하되 `bg-opacity-0`로 투명하게 유지
- **결과**: ❌ 문제 지속

### 5. 이미지 배경색 명시
- **변경**: `style={{ backgroundColor: 'transparent' }}` 추가
- **결과**: ❌ 문제 지속

## 🎯 근본 원인 추정

**가장 유력한 원인**: **이미지 로딩 완료 후 상태 업데이트로 인한 재렌더링 문제**

1. 초기 렌더링: `imageLoading = true`, `imageUrl = null` → "로딩 중..." 표시
2. URL 가져옴: `imageUrl = "[signed-url]"` → 이미지 렌더링 시작
3. 이미지 로드 중: 이미지가 표시되기 시작 (잠깐 보임)
4. `onLoad` 발생: `imageLoading = false` → 상태 업데이트로 재렌더링
5. 재렌더링 시: 조건부 렌더링 로직이 변경되어 검은색 배경이 표시됨

**또는**: 호버 오버레이의 `bg-black`이 어떤 이유로 `opacity-0`이 적용되지 않아 검은색으로 표시됨

## 💡 해결 방안 제안

### 방안 1: 이미지 로딩 상태 완전 제거
- `imageLoading` 상태를 제거하고 `imageUrl` 존재 여부만으로 렌더링
- 이미지가 로드되지 않으면 `onError`에서만 처리

```typescript
// imageLoading 상태 제거
// imageUrl이 있으면 무조건 이미지 렌더링
{imageUrl ? (
  <img src={imageUrl} ... />
) : (
  <div>로딩 중...</div>
)}
```

### 방안 2: 호버 오버레이 완전 제거 또는 재설계
- 호버 오버레이를 제거하고 다른 방식으로 "클릭하여 확대" 표시
- 또는 `bg-black` 대신 다른 색상 사용

```typescript
// 호버 오버레이 제거
// 또는 bg-black 대신 반투명 흰색 사용
<div className="absolute inset-0 bg-white bg-opacity-0 group-hover:bg-opacity-10 ...">
```

### 방안 3: 이미지 로딩 완료 후에도 상태 유지
- 이미지가 로드된 후에도 `imageLoading`을 `true`로 유지하거나
- 별도의 `imageLoaded` 상태 추가

```typescript
const [imageLoaded, setImageLoaded] = useState(false);

<img
  onLoad={() => setImageLoaded(true)}
  style={{ display: imageLoaded ? 'block' : 'none' }}
/>
```

### 방안 4: CSS로 검은색 배경 완전 차단
- 이미지 컨테이너에 `background-color: #f3f4f6 !important` 강제 적용
- 모든 자식 요소의 검은색 배경 제거

```css
.aspect-\[4\/3\] {
  background-color: #f3f4f6 !important;
}

.aspect-\[4\/3\] * {
  background-color: transparent !important;
}
```

### 방안 5: 이미지 프리로딩 및 캐싱
- 이미지 URL을 가져온 후 프리로딩
- 로드 완료 후에만 렌더링

```typescript
useEffect(() => {
  if (imageUrl) {
    const img = new Image();
    img.onload = () => {
      setImageLoaded(true);
    };
    img.src = imageUrl;
  }
}, [imageUrl]);
```

## 🔬 디버깅 체크리스트

### 즉시 확인 필요
- [ ] 브라우저 개발자 도구에서 실제 렌더링된 DOM 확인
- [ ] Computed Styles에서 각 요소의 실제 `background-color` 확인
- [ ] Network 탭에서 이미지 요청 상태 코드 확인 (200인지)
- [ ] Console에서 이미지 로드 에러 확인
- [ ] React DevTools로 상태 변경 추적
- [ ] Storage에서 직접 이미지 다운로드하여 확인

### 추가 확인 필요
- [ ] 다른 브라우저에서 테스트 (Chrome, Firefox, Safari)
- [ ] 다른 이미지 파일로 테스트
- [ ] Signed URL을 직접 브라우저 주소창에 입력하여 확인
- [ ] 이미지 메타데이터 확인 (크기, 형식, 색상 프로파일)
- [ ] CORS 헤더 확인

## 📝 권장 조치 사항

### 우선순위 1: 근본 원인 확인
1. 브라우저 개발자 도구로 실제 DOM 및 스타일 확인
2. React DevTools로 상태 변경 추적
3. Network 탭에서 이미지 요청 상세 확인

### 우선순위 2: 간단한 해결책 시도
1. 호버 오버레이 완전 제거
2. `imageLoading` 상태 제거
3. CSS로 검은색 배경 강제 차단

### 우선순위 3: 근본적인 해결
1. 이미지 로딩 로직 재설계
2. 상태 관리 최적화
3. 에러 처리 강화

## 📊 예상 소요 시간

- **원인 확인**: 30분 - 1시간
- **간단한 해결책 적용**: 15분 - 30분
- **근본적인 해결**: 1시간 - 2시간

## 🎯 다음 단계

1. **즉시**: 브라우저 개발자 도구로 실제 DOM 및 스타일 확인
2. **단기**: 호버 오버레이 제거 및 `imageLoading` 상태 제거 시도
3. **중기**: 이미지 로딩 로직 재설계
4. **장기**: 이미지 프리로딩 및 캐싱 구현

---

**작성일**: 2025-11-17
**작성자**: AI Assistant
**상태**: 분석 완료, 해결 대기 중

