# 테스트 결과 분석 및 해결 방안

> **테스트 일시**: 2025-11-21T16:31:30  
> **프로젝트 ID**: `8b41ab13-d3b0-46e7-a54f-eef2b89df2b3`  
> **상태**: 🔴 **문제 원인 확인됨**

---

## 🔍 핵심 문제 발견

### 에러 코드: `PGRST106`

```
"The schema must be one of the following: public, hdd"
```

**의미**: PostgREST가 `vibememory` 스키마를 인식하지 못하고 있습니다.

PostgREST는 기본적으로 특정 스키마만 노출하며, 현재는 `public`과 `hdd`만 허용되고 있습니다.

---

## ✅ 테스트 결과 요약

### 성공한 방법들

1. ✅ **Public 뷰로 조회** (owner 필터 없음)
   - 프로젝트 정상 조회됨
   - Owner ID 일치 확인

2. ✅ **Public 뷰로 조회** (owner 필터 적용)
   - 프로젝트 정상 조회됨
   - Owner ID 일치 확인

3. ✅ **get_user_projects RPC**
   - 프로젝트 목록에 포함됨
   - 총 12개 프로젝트 중 하나

### 실패한 방법들

1. ❌ **Vibememory 테이블 직접 접근** (owner 필터 없음)
   - 에러: `PGRST106` - 스키마를 인식하지 못함

2. ❌ **Vibememory 테이블 직접 접근** (owner 필터 적용)
   - 에러: `PGRST106` - 스키마를 인식하지 못함

---

## 💡 해결 방안

### 방안 1: Public 뷰로 전환 (즉시 해결) ⭐ **권장**

**이유:**
- Public 뷰는 이미 정상 작동 중
- 코드 수정 최소화
- 즉시 적용 가능

**수정 내용:**

```typescript
// lib/supabase.ts
export const supabaseAdmin = createClient(
  supabaseUrl || 'https://placeholder.supabase.co',
  supabaseServiceRoleKey || 'placeholder-service-role-key',
  {
    auth: {
      autoRefreshToken: false,
      persistSession: false,
    },
    db: {
      schema: 'public',  // vibememory → public으로 변경
    },
  }
);
```

**장점:**
- ✅ 즉시 작동
- ✅ 코드 수정 최소화
- ✅ 기존 동작과 일치

**단점:**
- ⚠️ 다른 프로젝트(hdd 등)와 테이블 이름 충돌 가능성
- ⚠️ 하지만 현재는 문제 없음 (뷰 이름이 다름)

### 방안 2: Supabase 설정에서 vibememory 스키마 노출 (근본 해결)

**Supabase Dashboard에서 설정:**

1. **Settings** → **API** → **Schema Settings**
2. `vibememory` 스키마를 추가
3. 또는 `db.schema` 설정에서 `vibememory` 추가

**또는 SQL로 설정:**

```sql
-- PostgREST가 vibememory 스키마를 노출하도록 설정
ALTER DATABASE postgres SET pgrst.db_schemas = 'public, hdd, vibememory';
```

**장점:**
- ✅ 근본적인 해결
- ✅ 스키마 격리 유지

**단점:**
- ⚠️ Supabase 설정 변경 필요
- ⚠️ 재시작 필요할 수 있음

---

## 🎯 권장 실행 순서

### 즉시 실행 (방안 1)

1. **`lib/supabase.ts` 수정**
   - 기본 스키마를 `public`으로 변경

2. **모든 `.schema('vibememory')` 호출 제거**
   - 기본 스키마가 `public`이므로 명시 불필요
   - 단, RPC 호출은 `.schema('public')` 유지 (필요한 경우)

3. **테스트**
   - 프로젝트 상세 페이지 접근 확인
   - 스크린샷, 분석 데이터 조회 확인

### 장기 해결 (방안 2)

1. **Supabase Dashboard에서 스키마 노출 설정**
2. **기본 스키마를 다시 `vibememory`로 변경**
3. **모든 쿼리에서 `.schema('vibememory')` 명시**

---

## 📊 현재 상태

### 작동하는 것들
- ✅ 프로젝트 목록 조회
- ✅ Public 뷰를 통한 프로젝트 조회
- ✅ Owner ID 일치 확인

### 작동하지 않는 것들
- ❌ Vibememory 테이블 직접 접근
- ❌ 스키마 명시적 사용 (`.schema('vibememory')`)

---

## ✅ 결론

**즉시 해결책**: Public 뷰로 전환

테스트 결과가 명확하게 보여주듯이, Public 뷰는 완벽하게 작동하고 있습니다. 반면 `vibememory` 스키마 직접 접근은 PostgREST 설정 문제로 불가능합니다.

**다음 단계**: `lib/supabase.ts`에서 기본 스키마를 `public`으로 변경하고, 모든 `.schema('vibememory')` 호출을 제거하면 즉시 문제가 해결됩니다.

---

**분석 완료일**: 2025-11-21  
**권장 조치**: 방안 1 (Public 뷰로 전환) 즉시 실행

