# 현재 작업 상황 (Active Context)

## 1. 현재 집중하고 있는 작업  
- **작업명**: 챗봇 세션 관리 UI 구현
- **목표**: 
  - 세션 목록 UI (SessionSidebar) 구현
  - 세션 선택 및 로드 기능 구현
  - 기존 대화 이어가기 기능
- **상태**: ✅ 구현 완료
- **다음 단계**: 테스트 및 검증

## 2. 최근 완료된 작업 (2025-01-16)

### Citations 테이블 전환
- ✅ `chat_message_citations` 테이블 생성 및 마이그레이션
- ✅ 메시지 저장 시 Citations 테이블에 저장
- ✅ 메시지 조회 시 Citations JOIN하여 조회
- ✅ 청크 조회 API 추가 (`/api/projects/[id]/chunks/[chunkId]`)
- ✅ 출처 클릭 시 청크 미리보기 기능 추가
- ✅ `ChunkPreview` 컴포넌트 생성

### Cron Worker 인증 수정
- ✅ Vercel Cron 인증 방식 수정 (`x-vercel-cron` 헤더 지원)
- ✅ 401 에러 해결

### 이전 작업 (2025-11-15)

### 성능 최적화 및 코드 품질 개선
- ✅ **병렬 처리 구현**
  - `lib/runInitialScan.ts`에 `Promise.allSettled()` 사용
  - 3개 파일씩 동시 처리 (배치 단위)
  - 예상 성능 개선: 60-70% 시간 단축
- ✅ **Storage 버킷 확인 최적화**
  - `lib/storage.ts`에 캐싱 로직 추가
  - 한 번만 확인하고 결과 저장
  - 예상 성능 개선: 약 10% 시간 단축
- ✅ **진행 상태 업데이트 빈도 조정**
  - 각 파일마다 → 3개 파일마다 한 번씩 업데이트
  - DB 쿼리 수 감소
- ✅ **에러 로깅 개선**
  - `lib/utils/logger.ts` 생성 (구조화된 로깅)
  - JSON 형식 로그, 컨텍스트 정보 포함
  - 에러 레벨 분류 (DEBUG, INFO, WARN, ERROR)
- ✅ **재시도 메커니즘 강화**
  - `lib/utils/retry.ts` 생성 (지수 백오프 재시도)
  - `getFileContent`, `embedChunks`, `getRepositoryTree`에 적용
  - 최대 3회 재시도, 자동 복구
- ✅ **프로젝트 만들기 기능 플랜 작성**
  - `프로젝트_만들기_기능_플랜.md` 생성
  - 데이터베이스 스키마 변경 계획
  - 백엔드/프론트엔드 구현 계획

### 배포 및 인프라
- ✅ **빌드 성공 확인**
  - Next.js 빌드 오류 없음
  - middleware.ts 삭제로 deprecated 경고 해결
- ✅ **GitHub 리포지토리 생성 및 푸시**
  - 리포지토리: `ustudiopd/VibeMemory`
  - 초기 커밋 완료 (84개 파일, 16,559줄)
- ✅ **Vercel 배포 가이드 작성**
  - `VERCEL_DEPLOYMENT.md` 생성
  - 환경 변수 설정 가이드 포함
  - 웹훅 URL 설정 방법 설명
- ✅ **파일 스캔 최적화**
  - 메모리뱅크 전용 스캔으로 변경 (`memory_bank/` 디렉토리만)
  - 파일 타입(`blob`) 확인 추가
  - 디버깅 로그 추가
  - 중복 필터링 제거
  - 96개 파일 → 약 6개 파일로 감소 (타임아웃 문제 해결)
- ✅ **프로젝트 임포트 버그 수정**
  - 삭제된 프로젝트 재임포트 시 잠금 문제 해결
  - 프로젝트가 존재하지 않을 때 잠금 강제 삭제 로직 추가

### 이전 작업 (2025-11-15)
- ✅ **프로젝트 삭제 기능 구현** (API + UI)
  - `DELETE /api/projects/[id]` 엔드포인트 완성
  - 대시보드 UI에 삭제 버튼 및 확인 다이얼로그 추가
  - GitHub Webhook 자동 삭제 포함
  - JSX 구조 오류 수정 완료
- ✅ **프로젝트 임포트 파이프라인 리포트 작성** 
  - `PROJECT_IMPORT_PIPELINE_REPORT.md` 생성
  - 현재 구현 상태 상세 분석
  - 문제점 식별 및 해결 방안 제시
  - 우선순위별 작업 계획 수립
- ✅ **Vector 타입 삽입을 위한 RPC 함수 생성**
  - `insert_repo_file_chunks` RPC 함수 생성
  - 벡터 변환 로직 포함 (개선 필요)
  - `lib/runInitialScan.ts`에서 RPC 함수 사용하도록 수정
- ✅ **데이터베이스 접근 문제 해결**
  - public 스키마 뷰 생성 (`projects`, `repo_files`, `repo_file_chunks`, `project_analysis`)
  - RLS 및 권한 설정 개선
  - `get_user_projects` RPC 함수 생성
  - `get_project_progress` RPC 함수를 public 스키마로 이동
- ✅ **에러 핸들링 개선**
  - 프로젝트 임포트 시 중복 체크 로직 개선
  - 에러 메시지 개선 및 리다이렉션 처리
  - `single()` 사용 문제 수정 (`limit(1)` 사용)

## 3. 발견된 주요 문제점

### 🔴 긴급 (Critical)
1. ✅ **파일 스캔 최적화** (해결됨)
   - **문제**: 96개 파일 스캔 시 Vercel 타임아웃 발생 (300초 제한)
   - **해결**: 메모리뱅크 디렉토리만 스캔하도록 변경
   - **결과**: 약 6개 파일만 스캔하여 타임아웃 문제 해결
   - **상태**: 완료

2. **P2 임베딩 단계 실패** (이전 이슈)
   - **문제**: Vector 타입을 Supabase JS 클라이언트로 직접 삽입 시 타입 변환 실패
   - **현황**: 0개 청크 저장됨 (임베딩이 완전히 실패)
   - **해결 방안**: RPC 함수 `insert_repo_file_chunks` 생성 완료
   - **우선순위**: 높음

### 🟡 중요 (High)
3. ✅ **에러 추적 불가** (해결됨)
   - **문제**: 비동기 실행으로 인한 에러 추적 어려움
   - **해결**: 구조화된 로깅 시스템 구현 (`lib/utils/logger.ts`)
   - **상태**: 완료

4. ✅ **진행 상태 피드백 없음** (해결됨)
   - **문제**: 사용자가 프로젝트 임포트 진행 상황을 알 수 없음
   - **해결**: SSE 스트리밍 구현 (`/api/projects/[id]/progress/stream`)
   - **상태**: 완료

5. ✅ **재시도 메커니즘 없음** (해결됨)
   - **문제**: 일시적 실패 시 수동 재실행 필요
   - **해결**: 지수 백오프 재시도 로직 구현 (`lib/utils/retry.ts`)
   - **상태**: 완료

## 4. 다음 예정 작업 (우선순위 순)

### Phase 1: 프로젝트 만들기 기능 구현 (7-10시간)
1. **데이터베이스 스키마 변경**
   - `project_type` ENUM 추가 (`'github' | 'idea'`)
   - GitHub 관련 필드 nullable 변경
   - 제약 조건 추가
   - 인덱스 추가

2. **백엔드 API 구현**
   - `POST /api/projects/create` API 생성
   - 프로젝트 목록/상세 API 수정
   - 프로젝트 타입 검증 로직 추가

3. **프론트엔드 UI 구현**
   - `/dashboard/create` 페이지 생성
   - 대시보드에 만들기 버튼 추가
   - 프로젝트 상세 페이지 조건부 렌더링
   - 모바일 탭바 수정 (선택적)

4. **테스트 및 검증**
   - 아이디어 프로젝트 생성 테스트
   - 프로젝트 목록/상세 페이지 테스트
   - 챗봇/댓글 기능 테스트

### Phase 2: 추가 개선 (향후)
- 아이디어 프로젝트 챗봇 기능 (간단한 프롬프트 기반)
- 아이디어 프로젝트 문서 추가 기능
- 프로젝트 타입별 통계 및 분석

## 5. 주요 이슈 및 블로커  
- **해결된 이슈**: 
  - ✅ 파일 스캔 타임아웃 문제 (메모리뱅크 전용 스캔으로 해결)
  - ✅ P2 임베딩 단계 실패 (RPC 함수로 해결 완료)
  - ✅ 성능 최적화 (병렬 처리, Storage 최적화, 진행 상태 업데이트 빈도 조정)
  - ✅ 에러 로깅 개선 (구조화된 로깅 시스템)
  - ✅ 재시도 메커니즘 강화 (지수 백오프 재시도)
- **현재 상태**: 
  - 메모리뱅크 파일만 스캔하여 타임아웃 없이 정상 작동
  - 성능 최적화 완료 (60-70% 시간 단축 예상)
  - 코드 품질 개선 완료 (로깅, 재시도 메커니즘)

## 6. 참고 문서
- `VERCEL_DEPLOYMENT.md`: Vercel 배포 가이드 및 환경 변수 설정
- `PROJECT_IMPORT_PIPELINE_REPORT.md`: 프로젝트 임포트 파이프라인 상세 분석 리포트
- `프로젝트_만들기_기능_플랜.md`: 프로젝트 만들기(아이디어 생성) 기능 구현 플랜
- `코드_리뷰_구현_확인.md`: 코드 리뷰 및 구현 여부 확인 리포트
- `남은_작업_목록.md`: 남은 작업 목록 및 우선순위
- `plan.md`: 전체 프로젝트 명세서
- `ENV_SETUP.md`: 로컬 개발 환경 변수 설정 가이드
- `GITHUB_OAUTH_SETUP.md`: GitHub OAuth 설정 가이드

## 7. 배포 정보
- **GitHub 리포지토리**: https://github.com/ustudiopd/VibeMemory
- **Vercel 배포 URL**: https://vibe-memory.vercel.app
- **배포 상태**: 성공 (빌드 오류 없음)

