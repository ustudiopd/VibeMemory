# 비즈니스 로직 및 기능 동작 (Product Context)

## 1. 핵심 비즈니스 로직  

### 1.1 프로젝트 관리
- **시스템 사용자 모드**: 모든 프로젝트는 시스템 사용자(`ustudiopd`) 소유
- **중복 방지**: 동일한 리포지토리 URL은 한 번만 임포트 가능
- **동시성 제어**: 동일 리포지토리의 동시 임포트/스캔 방지 (`job_locks` 테이블)
- **CASCADE 삭제**: 프로젝트 삭제 시 관련 데이터(파일, 청크, 분석) 자동 삭제

### 1.2 지식 자산 변환 프로세스
- **P1 인덱싱**: GitHub 리포지토리의 모든 `.md` 파일 메타데이터 수집
- **P2 임베딩**: 파일 내용을 청킹하여 벡터 임베딩 생성 (1536차원)
- **P3 AI 리뷰**: 핵심 파일(`projectbrief.md`, `techContext.md` 등) 분석하여 자동 리뷰 생성
- **P4 신선도**: GitHub push 이벤트를 통해 변경 사항 자동 동기화
- **P5 릴리즈 노트**: 커밋 메시지를 기반으로 릴리즈 노트 자동 생성

### 1.3 RAG (Retrieval Augmented Generation)
- **하이브리드 검색**: FTS(키워드) + Vector(의미) 검색을 RRF로 결합
- **청킹 전략**: 1000자 청크, 200자 오버랩
- **임베딩 모델**: OpenAI `text-embedding-3-small` (1536차원)

## 2. 주요 기능별 동작 시나리오  

### 2.1 프로젝트 가져오기 (Import)
1. **사용자 액션**: 대시보드에서 "프로젝트 가져오기" 클릭
2. **리포지토리 선택**: GitHub 리포지토리 목록에서 선택
3. **중복 확인**: 이미 임포트된 프로젝트인지 확인
4. **동시성 제어**: `claim_job` RPC로 작업 잠금 획득
5. **프로젝트 생성**: 데이터베이스에 프로젝트 레코드 생성
6. **Webhook 등록**: GitHub에 push 이벤트 Webhook 등록
7. **초기 스캔 시작**: `runInitialScan` 비동기 실행
8. **응답**: 프로젝트 상세 페이지로 리다이렉션

### 2.2 초기 스캔 프로세스 (Initial Scan)
1. **P1 인덱싱**:
   - GitHub API로 리포지토리 트리 수집
   - `.md` 파일만 필터링
   - 파일 메타데이터(경로, SHA, 크기)를 `repo_files` 테이블에 저장
2. **P2 임베딩** (현재 실패):
   - 각 파일 내용을 GitHub API로 가져오기
   - 텍스트를 청킹 (1000자, 200자 오버랩)
   - OpenAI Embeddings API로 벡터 생성
   - `repo_file_chunks` 테이블에 저장 (현재 실패)
3. **P3 AI 리뷰** (P2 실패로 미실행):
   - 핵심 파일 수집 (`projectbrief.md`, `techContext.md` 등)
   - OpenAI GPT로 아이디어 리뷰, 기술 리뷰, 특허 분석 생성
   - `project_analysis` 테이블에 저장

### 2.3 프로젝트 삭제
1. **사용자 액션**: 대시보드에서 프로젝트 카드의 "삭제" 버튼 클릭
2. **확인 다이얼로그**: 삭제 확인 모달 표시
3. **소유권 확인**: API에서 프로젝트 소유권 검증
4. **Webhook 삭제**: GitHub Webhook 삭제 (있는 경우)
5. **프로젝트 삭제**: 데이터베이스에서 프로젝트 삭제 (CASCADE로 관련 데이터 자동 삭제)
6. **UI 업데이트**: 목록에서 프로젝트 제거

### 2.4 프로젝트 챗봇
1. **사용자 질문**: 프로젝트 상세 페이지에서 질문 입력
2. **하이브리드 검색**: RRF를 사용하여 관련 청크 검색
3. **컨텍스트 구성**: 검색된 청크를 프롬프트에 포함
4. **AI 응답**: OpenAI GPT로 답변 생성 및 스트리밍
5. **응답 표시**: 실시간으로 스트리밍된 답변 표시

### 2.5 GitHub Push 동기화 (Webhook)
1. **GitHub 이벤트**: 사용자가 리포지토리에 push
2. **Webhook 수신**: `/api/github/webhook` 엔드포인트로 이벤트 수신
3. **서명 검증**: HMAC 서명으로 이벤트 검증
4. **변경 파일 감지**: push 이벤트에서 변경된 `.md` 파일 추출
5. **업데이트**: 변경된 파일만 재인덱싱 및 재임베딩
6. **AI 분석 갱신**: 변경 사항 반영하여 AI 리뷰 재생성

## 3. 데이터 흐름

### 3.1 프로젝트 임포트 흐름
```
사용자 → 대시보드 → 리포지토리 선택 → API 호출
  → 중복 확인 → 작업 잠금 → 프로젝트 생성 → Webhook 등록
  → 비동기 스캔 시작 → P1 인덱싱 → P2 임베딩 → P3 AI 리뷰
```

### 3.2 챗봇 질문-답변 흐름
```
사용자 질문 → API 호출 → 하이브리드 검색 (RRF)
  → 관련 청크 검색 → 컨텍스트 구성 → OpenAI GPT 호출
  → 스트리밍 응답 → 실시간 표시
```

## 4. 주요 제약사항 및 규칙
- **파일 형식**: `.md` 파일만 처리
- **임베딩 모델**: `text-embedding-3-small` (1536차원) 고정
- **청킹 크기**: 1000자, 200자 오버랩 고정
- **LLM 모델**: `gpt-4.1-mini` (환경 변수로 변경 가능)
- **시스템 사용자**: `ustudiopd` GitHub 계정 사용 (환경 변수 설정)

