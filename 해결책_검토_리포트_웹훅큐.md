# ì›¹í›… í PGRST205 ì—ëŸ¬ í•´ê²°ì±… ê²€í†  ë¦¬í¬íŠ¸

## ğŸ“‹ ê²€í†  ê°œìš”

`í•´ê²°ì±….md`ì—ì„œ ì œì‹œí•œ ì›¹í›… ì‘ì—… í `PGRST205` ì—ëŸ¬ í•´ê²° ë°©ì•ˆì„ í˜„ì¬ ì½”ë“œë² ì´ìŠ¤ì™€ ë¹„êµí•˜ì—¬ ê²€í† í–ˆìŠµë‹ˆë‹¤.

## âœ… í˜„ì¬ ìƒíƒœ

### 1. í…Œì´ë¸” ìƒì„± ìƒíƒœ
- âœ… **`public.webhook_deliveries`**: ìƒì„± ì™„ë£Œ (ë°©ê¸ˆ ë§ˆì´ê·¸ë ˆì´ì…˜)
- âœ… **`public.webhook_jobs`**: ìƒì„± ì™„ë£Œ (ë°©ê¸ˆ ë§ˆì´ê·¸ë ˆì´ì…˜)
- âš ï¸ **ìŠ¤í‚¤ë§ˆ ë¶ˆì¼ì¹˜**: `í•´ê²°ì±….md`ëŠ” `vibememory` ìŠ¤í‚¤ë§ˆ ê¶Œì¥, í˜„ì¬ëŠ” `public` ìŠ¤í‚¤ë§ˆì— ìƒì„±

### 2. ì½”ë“œ ìƒíƒœ
- âŒ **ìŠ¤í‚¤ë§ˆ ëª…ì‹œ ì—†ìŒ**: `supabaseAdmin.from('webhook_jobs')` ì‚¬ìš© (ê¸°ë³¸ `public` ìŠ¤í‚¤ë§ˆ)
- âŒ **ì›ìì  í´ë ˆì„ ì—†ìŒ**: ë‹¨ìˆœ SELECT â†’ UPDATE ë°©ì‹ (ê²½í•© ì¡°ê±´ ê°€ëŠ¥)
- âš ï¸ **CRON_SECRET ê²€ì¦**: `authorization` í—¤ë”ë§Œ í™•ì¸ (`x-cron-secret` ë¯¸ì§€ì›)

## ğŸ” í•´ê²°ì±….md ì œì•ˆì‚¬í•­ ê²€í† 

### âœ… 1. í…Œì´ë¸” ìƒì„± (ë¶€ë¶„ ì™„ë£Œ)

**ì œì•ˆ**: `vibememory.webhook_jobs` í…Œì´ë¸” ìƒì„±

**í˜„ì¬ ìƒíƒœ**:
- âœ… í…Œì´ë¸”ì€ ìƒì„±ë¨ (`public` ìŠ¤í‚¤ë§ˆ)
- âš ï¸ ìŠ¤í‚¤ë§ˆê°€ ë‹¤ë¦„ (`public` vs `vibememory`)

**ê¶Œì¥ ì¡°ì¹˜**:
- ì˜µì…˜ A: `public` ìŠ¤í‚¤ë§ˆ ìœ ì§€ (í˜„ì¬ ìƒíƒœ) â†’ ì½”ë“œ ìˆ˜ì • ë¶ˆí•„ìš”
- ì˜µì…˜ B: `vibememory` ìŠ¤í‚¤ë§ˆë¡œ ì´ë™ â†’ ì½”ë“œì— ìŠ¤í‚¤ë§ˆ ëª…ì‹œ í•„ìš”

**ê²°ë¡ **: í˜„ì¬ `public` ìŠ¤í‚¤ë§ˆì— í…Œì´ë¸”ì´ ìˆìœ¼ë¯€ë¡œ, ì½”ë“œ ìˆ˜ì • ì—†ì´ ì‘ë™ ê°€ëŠ¥í•©ë‹ˆë‹¤. í•˜ì§€ë§Œ `í•´ê²°ì±….md`ì˜ ê¶Œì¥ì‚¬í•­ì„ ë”°ë¥´ë ¤ë©´ `vibememory` ìŠ¤í‚¤ë§ˆë¡œ ì´ë™í•˜ëŠ” ê²ƒì´ ì¢‹ìŠµë‹ˆë‹¤.

---

### âŒ 2. ìŠ¤í‚¤ë§ˆ ëª…ì‹œ (ë¯¸ì ìš©)

**ì œì•ˆ**: ì›Œì»¤ì—ì„œ `.schema('vibememory')` ë˜ëŠ” `{ db: { schema: 'vibememory' } }` ì‚¬ìš©

**í˜„ì¬ ì½”ë“œ**:
```typescript
// app/api/cron/process-webhook-jobs/route.ts
const { data: jobs, error: fetchError } = await supabaseAdmin
  .from('webhook_jobs')  // âŒ ìŠ¤í‚¤ë§ˆ ëª…ì‹œ ì—†ìŒ
  .select('*')
  .eq('status', 'pending')
```

**ë¬¸ì œì **:
- ê¸°ë³¸ ìŠ¤í‚¤ë§ˆ(`public`)ë¥¼ ì‚¬ìš©í•˜ë¯€ë¡œ, `vibememory` ìŠ¤í‚¤ë§ˆë¡œ ì´ë™ ì‹œ ì—ëŸ¬ ë°œìƒ
- ë‹¤ë¥¸ í…Œì´ë¸”ë“¤(`job_locks` ë“±)ê³¼ ì¼ê´€ì„± ë¶€ì¡±

**ê¶Œì¥ ìˆ˜ì •**:
```typescript
// ì˜µì…˜ A: ì²´ì´ë‹ìœ¼ë¡œ ìŠ¤í‚¤ë§ˆ ì§€ì •
const { data: jobs, error: fetchError } = await supabaseAdmin
  .schema('vibememory')  // âœ… ì¶”ê°€
  .from('webhook_jobs')
  .select('*')
  .eq('status', 'pending')

// ì˜µì…˜ B: ì „ì—­ ê¸°ë³¸ ìŠ¤í‚¤ë§ˆ ì§€ì • (lib/supabase.ts)
export const supabaseAdmin = createClient(
  supabaseUrl || 'https://placeholder.supabase.co',
  supabaseServiceRoleKey || 'placeholder-service-role-key',
  {
    db: { schema: 'vibememory' },  // âœ… ì¶”ê°€
    auth: {
      autoRefreshToken: false,
      persistSession: false,
    },
  }
);
```

**ìš°ì„ ìˆœìœ„**: ğŸ”´ ë†’ìŒ (ìŠ¤í‚¤ë§ˆ ì¼ê´€ì„± ë° í–¥í›„ í™•ì¥ì„±)

---

### âŒ 3. ì›ìì  í´ë ˆì„ RPC í•¨ìˆ˜ (ë¯¸êµ¬í˜„)

**ì œì•ˆ**: `vibememory.claim_webhook_jobs()` RPC í•¨ìˆ˜ë¡œ ì›ìì  í´ë ˆì„

**í˜„ì¬ ì½”ë“œ**:
```typescript
// app/api/cron/process-webhook-jobs/route.ts
// 1. SELECTë¡œ pending ì‘ì—… ì¡°íšŒ
const { data: jobs } = await supabaseAdmin
  .from('webhook_jobs')
  .select('*')
  .eq('status', 'pending')
  .order('created_at', { ascending: true })
  .limit(BATCH_SIZE);

// 2. ê° ì‘ì—…ì„ runningìœ¼ë¡œ ë³€ê²½
await supabaseAdmin
  .from('webhook_jobs')
  .update({ status: 'running' })
  .eq('id', job.id);
```

**ë¬¸ì œì **:
- âŒ **ê²½í•© ì¡°ê±´**: ì—¬ëŸ¬ ì›Œì»¤ê°€ ë™ì‹œì— ê°™ì€ ì‘ì—…ì„ ì„ íƒí•  ìˆ˜ ìˆìŒ
- âŒ **ë¹„ì›ìì **: SELECTì™€ UPDATE ì‚¬ì´ì— ë‹¤ë¥¸ ì›Œì»¤ê°€ ê°œì… ê°€ëŠ¥
- âŒ **ì„±ëŠ¥**: ì—¬ëŸ¬ UPDATE ì¿¼ë¦¬ ì‹¤í–‰

**ì œì•ˆëœ RPC í•¨ìˆ˜**:
```sql
CREATE OR REPLACE FUNCTION vibememory.claim_webhook_jobs(p_limit int DEFAULT 10)
RETURNS SETOF vibememory.webhook_jobs
LANGUAGE sql
SECURITY DEFINER
AS $$
  WITH cte AS (
    SELECT id
    FROM vibememory.webhook_jobs
    WHERE status = 'pending'
    ORDER BY created_at ASC
    LIMIT p_limit
    FOR UPDATE SKIP LOCKED  -- âœ… ì›ìì  ë½
  )
  UPDATE vibememory.webhook_jobs j
  SET status = 'running', tries = j.tries + 1, updated_at = now()
  WHERE j.id IN (SELECT id FROM cte)
  RETURNING j.*;
$$;
```

**ìˆ˜ì •ëœ ì›Œì»¤ ì½”ë“œ**:
```typescript
// ì›ìì  í´ë ˆì„
const { data: jobs, error } = await supabaseAdmin
  .rpc('claim_webhook_jobs', { p_limit: BATCH_SIZE });

// ê° job ì²˜ë¦¬ í›„ ìƒíƒœ ì—…ë°ì´íŠ¸
await supabaseAdmin
  .schema('vibememory')
  .from('webhook_jobs')
  .update({ status: 'done', updated_at: new Date().toISOString() })
  .eq('id', job.id);
```

**ìš°ì„ ìˆœìœ„**: ğŸŸ¡ ì¤‘ê°„ (í˜„ì¬ëŠ” ë‹¨ì¼ ì›Œì»¤ì´ì§€ë§Œ, í–¥í›„ í™•ì¥ ì‹œ í•„ìˆ˜)

---

### âš ï¸ 4. CRON_SECRET ê²€ì¦ ê°•í™” (ë¶€ë¶„ ì ìš©)

**ì œì•ˆ**: `x-cron-secret` í—¤ë” ì§€ì› ë° ê³µí†µ í—¬í¼ í•¨ìˆ˜

**í˜„ì¬ ì½”ë“œ**:
```typescript
// app/api/cron/process-webhook-jobs/route.ts
if (CRON_SECRET) {
  const authHeader = request.headers.get('authorization');
  if (authHeader !== `Bearer ${CRON_SECRET}`) {
    return NextResponse.json({ error: 'Unauthorized' }, { status: 401 });
  }
}
```

**ë¬¸ì œì **:
- âš ï¸ `authorization` í—¤ë”ë§Œ í™•ì¸ (`x-cron-secret` ë¯¸ì§€ì›)
- âš ï¸ ë‹¤ë¥¸ í¬ë¡  ì‘ì—…(`scan-worker`, `cleanup-old-chunks`)ê³¼ ì¼ê´€ì„± ë¶€ì¡±

**ì œì•ˆëœ ê³µí†µ í—¬í¼**:
```typescript
// lib/utils/cron-auth.ts
export function assertCronSecret(req: Request): Response | null {
  const cronSecret = process.env.CRON_SECRET;
  if (!cronSecret) {
    console.warn('[CRON] CRON_SECRET not set, allowing request (development mode)');
    return null; // ê°œë°œ ëª¨ë“œ í—ˆìš©
  }

  const authHeader = req.headers.get('authorization');
  const cronHeader = req.headers.get('x-cron-secret');
  const vercelHeader = req.headers.get('x-vercel-cron'); // Vercel ìë™ í—¤ë”

  // Vercel Cronì€ ìë™ìœ¼ë¡œ x-vercel-cron í—¤ë”ë¥¼ ë³´ëƒ„
  if (vercelHeader === '1') {
    return null; // Vercel Cron í—ˆìš©
  }

  // ìˆ˜ë™ í˜¸ì¶œ ì‹œ CRON_SECRET ê²€ì¦
  if (authHeader === `Bearer ${cronSecret}` || cronHeader === cronSecret) {
    return null; // ì¸ì¦ ì„±ê³µ
  }

  return new Response('Forbidden', { status: 403 });
}
```

**ìš°ì„ ìˆœìœ„**: ğŸŸ¡ ì¤‘ê°„ (ë³´ì•ˆ ê°•í™”, í•˜ì§€ë§Œ í˜„ì¬ë„ ì‘ë™ ì¤‘)

---

## ğŸ“Š ìš°ì„ ìˆœìœ„ë³„ ì ìš© ê³„íš

### ğŸ”´ ë†’ì€ ìš°ì„ ìˆœìœ„ (ì¦‰ì‹œ ì ìš©)

1. **ìŠ¤í‚¤ë§ˆ ëª…ì‹œ ì¶”ê°€**
   - `app/api/cron/process-webhook-jobs/route.ts`
   - `app/api/github/webhook/route.ts`
   - ëª¨ë“  `webhook_jobs`, `webhook_deliveries` ì ‘ê·¼ì— `.schema('vibememory')` ì¶”ê°€
   - ë˜ëŠ” `lib/supabase.ts`ì—ì„œ ì „ì—­ ê¸°ë³¸ ìŠ¤í‚¤ë§ˆ ì„¤ì •

2. **í…Œì´ë¸” ìŠ¤í‚¤ë§ˆ í†µì¼**
   - ì˜µì…˜ A: `public` ìŠ¤í‚¤ë§ˆ ìœ ì§€ (ì½”ë“œ ìˆ˜ì • ë¶ˆí•„ìš”, í˜„ì¬ ì‘ë™)
   - ì˜µì…˜ B: `vibememory` ìŠ¤í‚¤ë§ˆë¡œ ì´ë™ (ì¼ê´€ì„± í–¥ìƒ, ì½”ë“œ ìˆ˜ì • í•„ìš”)

### ğŸŸ¡ ì¤‘ê°„ ìš°ì„ ìˆœìœ„ (í–¥í›„ ê°œì„ )

3. **ì›ìì  í´ë ˆì„ RPC í•¨ìˆ˜ êµ¬í˜„**
   - `vibememory.claim_webhook_jobs()` RPC í•¨ìˆ˜ ìƒì„±
   - ì›Œì»¤ ì½”ë“œì—ì„œ RPC ì‚¬ìš©í•˜ë„ë¡ ìˆ˜ì •
   - `FOR UPDATE SKIP LOCKED`ë¡œ ê²½í•© ì¡°ê±´ ë°©ì§€

4. **CRON_SECRET ê²€ì¦ ê°•í™”**
   - ê³µí†µ í—¬í¼ í•¨ìˆ˜ ìƒì„± (`lib/utils/cron-auth.ts`)
   - `x-cron-secret` í—¤ë” ì§€ì›
   - ëª¨ë“  í¬ë¡  ì‘ì—…ì— ì ìš©

## ğŸ¯ ê¶Œì¥ ì¡°ì¹˜

### ì¦‰ì‹œ ì ìš© (PGRST205 í•´ê²°)

í˜„ì¬ `public` ìŠ¤í‚¤ë§ˆì— í…Œì´ë¸”ì´ ìƒì„±ë˜ì–´ ìˆìœ¼ë¯€ë¡œ, ì½”ë“œëŠ” ê·¸ëŒ€ë¡œ ì‘ë™í•©ë‹ˆë‹¤. í•˜ì§€ë§Œ `í•´ê²°ì±….md`ì˜ ê¶Œì¥ì‚¬í•­ì„ ë”°ë¥´ë ¤ë©´:

1. **í…Œì´ë¸”ì„ `vibememory` ìŠ¤í‚¤ë§ˆë¡œ ì´ë™** (ë˜ëŠ” `public` ìœ ì§€)
2. **ì½”ë“œì— ìŠ¤í‚¤ë§ˆ ëª…ì‹œ ì¶”ê°€**:
   ```typescript
   await supabaseAdmin
     .schema('vibememory')  // ë˜ëŠ” 'public'
     .from('webhook_jobs')
     .select('*')
   ```

### í–¥í›„ ê°œì„ 

1. **ì›ìì  í´ë ˆì„ RPC í•¨ìˆ˜ êµ¬í˜„** (ë‹¤ì¤‘ ì›Œì»¤ ì§€ì›)
2. **CRON_SECRET ê²€ì¦ ê°•í™”** (ë³´ì•ˆ í–¥ìƒ)

## ğŸ“ ê²°ë¡ 

`í•´ê²°ì±….md`ì˜ ì œì•ˆì‚¬í•­ì€ ëª¨ë‘ íƒ€ë‹¹í•˜ë©°, íŠ¹íˆ **ìŠ¤í‚¤ë§ˆ ëª…ì‹œ**ì™€ **ì›ìì  í´ë ˆì„**ì€ ìš´ì˜ ì•ˆì •ì„±ì— ì¤‘ìš”í•©ë‹ˆë‹¤. í˜„ì¬ëŠ” `public` ìŠ¤í‚¤ë§ˆì— í…Œì´ë¸”ì´ ìˆì–´ ì‘ë™í•˜ì§€ë§Œ, ì¼ê´€ì„±ê³¼ í™•ì¥ì„±ì„ ìœ„í•´ `vibememory` ìŠ¤í‚¤ë§ˆë¡œ í†µì¼í•˜ëŠ” ê²ƒì„ ê¶Œì¥í•©ë‹ˆë‹¤.

