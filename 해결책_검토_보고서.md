# 해결책.md 검토 보고서

> **검토일**: 2025-01-XX  
> **검토 대상**: `해결책.md`  
> **상태**: ✅ **대부분 정확, 일부 수정 필요**

---

## ✅ 정확한 분석

### 1. 문제 진단이 정확함

해결책.md의 문제 진단이 실제 코드베이스와 일치합니다:

- ✅ **리스트는 정상 작동**: `public.get_user_projects` RPC 사용
- ✅ **상세는 실패**: `vibememory.projects` 직접 조회 시 실패
- ✅ **원인 후보 1번이 가장 유력**: owner_id 필터링 불일치 가능성

### 2. 실제 코드 상태 확인

```30:36:app/api/projects/[id]/screenshots/route.ts
    // 프로젝트 소유 확인 (vibememory 스키마 명시)
    const { data: project, error: projectError } = await supabaseAdmin
      .schema('vibememory')
      .from('projects')
      .select('id')
      .eq('id', projectId)
      .eq('owner_id', user.id)
      .single();
```

현재 코드는 이미 `.schema('vibememory')`를 명시적으로 사용하고 있지만, 여전히 실패하고 있습니다.

---

## ⚠️ 수정이 필요한 부분

### 1. Import 경로 오류

**해결책.md (140번째 줄):**
```typescript
import { getSystemUserFromSupabase } from '@/lib/systemUser'; // 가정
```

**실제 경로:**
```typescript
import { getSystemUserFromSupabase } from '@/lib/system-user'; // 실제 경로
```

**수정 필요:**
- `@/lib/systemUser` → `@/lib/system-user`
- 해결책.md의 모든 예제 코드에서 수정 필요

### 2. Public 뷰 존재 확인

해결책.md는 public 뷰가 존재한다고 가정하고 있는데, 실제로 확인됨:

```559:569:DATABASE_SCHEMA.md
## Public 스키마 뷰

PostgREST 호환성을 위해 `public` 스키마에 뷰를 생성합니다:

- `public.projects` → `vibememory.projects`
- `public.chat_sessions` → `vibememory.chat_sessions`
- `public.chat_messages` → `vibememory.chat_messages`
- `public.chat_message_citations` → `vibememory.chat_message_citations`
- `public.project_screenshots` → `vibememory.project_screenshots`
- `public.screenshot_comments` → `vibememory.screenshot_comments`
- `public.idea_project_files` → `vibememory.idea_project_files`
```

✅ Public 뷰가 실제로 존재하므로 해결책 1 (Public 뷰로 전환)이 실행 가능합니다.

---

## 💡 해결책 검증

### 해결책 1: Public 뷰로 전환 ✅ **실행 가능**

**제안된 코드:**
```typescript
// lib/supabase.ts
export const supabaseAdmin = createClient(
  process.env.NEXT_PUBLIC_SUPABASE_URL!,
  process.env.SUPABASE_SERVICE_ROLE_KEY!,
  {
    auth: {
      autoRefreshToken: false,
      persistSession: false,
    },
    db: {
      schema: 'public', // 다시 public 뷰 기준으로
    },
  },
);
```

**검증 결과:**
- ✅ Public 뷰가 실제로 존재함
- ✅ 기존 코드 대부분이 public 뷰를 통해 작동했을 가능성 높음
- ✅ 가장 빠른 해결책

**주의사항:**
- 다른 프로젝트(hdd 등)와 테이블 이름 충돌 가능성 있음
- 하지만 현재는 `vibememory` 프로젝트만 사용 중이므로 문제 없을 것으로 예상

### 해결책 2: 헬퍼 함수 생성 ✅ **실행 가능**

**제안된 코드:**
```typescript
// lib/db/projects.ts
import { supabaseAdmin } from '@/lib/supabase';
import { getSystemUserFromSupabase } from '@/lib/system-user'; // 수정: system-user

export async function getProjectForSystemUser(projectId: string) {
  const systemUser = await getSystemUserFromSupabase();

  const { data, error } = await supabaseAdmin
    .from('projects')          // 기본 스키마: public (뷰)
    .select('*')
    .eq('id', projectId)
    .eq('owner_id', systemUser.id)
    .single();

  return { project: data, error };
}
```

**검증 결과:**
- ✅ `getSystemUserFromSupabase` 함수가 실제로 존재함
- ✅ 함수 시그니처가 제안과 일치함
- ✅ 모든 API에서 사용 가능

**개선 제안:**
- 에러 로깅 추가
- 타입 안전성 강화

### 해결책 3: 테스트 엔드포인트 ✅ **실행 가능**

**제안된 코드는 정확하지만, import 경로 수정 필요:**
```typescript
// app/api/test/project-check/route.ts
import { NextRequest, NextResponse } from 'next/server';
import { supabaseAdmin } from '@/lib/supabase';
import { getSystemUserFromSupabase } from '@/lib/system-user'; // 수정: system-user
```

**검증 결과:**
- ✅ 모든 함수가 실제로 존재함
- ✅ 즉시 실행 가능
- ✅ 디버깅에 매우 유용

---

## 🔍 추가 발견 사항

### 1. 현재 코드의 일관성 문제

현재 코드베이스를 보면:
- 일부 파일은 `.schema('vibememory')` 명시
- 일부 파일은 기본 스키마(`vibememory`)에 의존
- 일부 파일은 `.schema('public')` 사용

이런 혼용이 문제의 원인일 수 있습니다.

### 2. get_user_projects RPC의 내부 로직 확인 필요

해결책.md에서 언급한 대로, `get_user_projects` RPC가 내부적으로 어떤 조건으로 프로젝트를 필터링하는지 확인이 필요합니다:

```sql
-- 예상되는 RPC 내부 로직
SELECT * FROM public.projects 
WHERE owner_id = p_owner_id 
   OR shared_with @> ARRAY[p_owner_id];
```

만약 RPC가 `shared_with` 같은 추가 조건을 사용한다면, 직접 쿼리와 결과가 다를 수 있습니다.

### 3. 실제 데이터 확인 필요

해결책.md의 제안대로 테스트 엔드포인트를 만들어서:
1. 프로젝트가 실제로 존재하는지
2. `owner_id`가 시스템 사용자 ID와 일치하는지
3. Public 뷰와 vibememory 테이블의 결과가 다른지

확인하는 것이 가장 중요합니다.

---

## 📋 수정된 해결책 제안

### 즉시 실행 가능한 단계

#### Step 1: 테스트 엔드포인트 생성 (우선)

```typescript
// app/api/test/project-check/route.ts
import { NextRequest, NextResponse } from 'next/server';
import { supabaseAdmin } from '@/lib/supabase';
import { getSystemUserFromSupabase } from '@/lib/system-user'; // 수정됨

export async function GET(req: NextRequest) {
  const { searchParams } = new URL(req.url);
  const projectId = searchParams.get('projectId');
  if (!projectId) {
    return NextResponse.json({ error: 'projectId is required' }, { status: 400 });
  }

  const systemUser = await getSystemUserFromSupabase();

  const results: any = {};

  // 1) public 뷰
  results.public_view = await supabaseAdmin
    .schema('public')
    .from('projects')
    .select('id, owner_id, project_name')
    .eq('id', projectId)
    .maybeSingle();

  // 2) vibememory 테이블
  results.vibememory_table = await supabaseAdmin
    .schema('vibememory')
    .from('projects')
    .select('id, owner_id, project_name')
    .eq('id', projectId)
    .maybeSingle();

  // 3) 시스템 사용자 owner 필터 적용
  results.vibememory_with_owner = await supabaseAdmin
    .schema('vibememory')
    .from('projects')
    .select('id, owner_id, project_name')
    .eq('id', projectId)
    .eq('owner_id', systemUser?.id)
    .maybeSingle();

  // 4) public 뷰 + owner 필터
  results.public_with_owner = await supabaseAdmin
    .schema('public')
    .from('projects')
    .select('id, owner_id, project_name')
    .eq('id', projectId)
    .eq('owner_id', systemUser?.id)
    .maybeSingle();

  // 5) get_user_projects RPC 결과
  if (systemUser) {
    const { data: rpcProjects } = await supabaseAdmin
      .schema('public')
      .rpc('get_user_projects', {
        p_owner_id: systemUser.id,
      });
    results.rpc_projects = rpcProjects?.find((p: any) => p.id === projectId) || null;
  }

  results.systemUser = { id: systemUser?.id, email: systemUser?.email };

  return NextResponse.json(results);
}
```

#### Step 2: 테스트 결과 확인 후 결정

테스트 엔드포인트 결과에 따라:

**케이스 A: Public 뷰는 되는데 vibememory 테이블은 안 됨**
→ Public 뷰로 전환 (해결책 1)

**케이스 B: Owner 필터를 빼면 되는데, 걸면 안 됨**
→ 헬퍼 함수에서 owner 필터 로직 수정

**케이스 C: RPC는 되는데 직접 쿼리는 안 됨**
→ RPC 내부 로직 확인 및 헬퍼 함수에서 RPC 사용

#### Step 3: 헬퍼 함수 생성 (해결책 2)

테스트 결과에 맞춰 헬퍼 함수를 생성:

```typescript
// lib/db/projects.ts
import { supabaseAdmin } from '@/lib/supabase';
import { getSystemUserFromSupabase } from '@/lib/system-user';

export async function getProjectForSystemUser(projectId: string) {
  const systemUser = await getSystemUserFromSupabase();
  if (!systemUser) {
    return { project: null, error: { message: '시스템 사용자를 찾을 수 없습니다.' } };
  }

  // 테스트 결과에 따라 public 또는 vibememory 사용
  const { data, error } = await supabaseAdmin
    .schema('public') // 또는 'vibememory'
    .from('projects')
    .select('*')
    .eq('id', projectId)
    .eq('owner_id', systemUser.id)
    .single();

  if (error) {
    console.error('[getProjectForSystemUser] Error:', {
      projectId,
      ownerId: systemUser.id,
      error,
    });
  }

  return { project: data, error };
}
```

---

## ✅ 최종 검토 결과

### 해결책.md의 강점

1. ✅ **문제 진단이 정확함**: 리스트 vs 상세 조회 차이를 정확히 파악
2. ✅ **원인 분석이 합리적**: owner_id 불일치 가능성을 우선순위로 제시
3. ✅ **해결책이 실행 가능**: 모든 제안이 실제 코드베이스에서 실행 가능
4. ✅ **단계별 접근 제시**: 빠른 해결 → 근본 해결 순서가 적절

### 수정이 필요한 부분

1. ⚠️ **Import 경로**: `@/lib/systemUser` → `@/lib/system-user`
2. ⚠️ **테스트 엔드포인트 개선**: RPC 결과도 비교에 포함
3. ⚠️ **헬퍼 함수 개선**: 에러 로깅 및 타입 안전성 강화

### 권장 실행 순서

1. **즉시**: 테스트 엔드포인트 생성 및 실행
2. **결과 확인 후**: Public 뷰로 전환 또는 헬퍼 함수 생성
3. **장기**: 모든 API에서 헬퍼 함수 사용으로 통일

---

## 📝 결론

해결책.md는 **전반적으로 매우 정확하고 실행 가능한 해결책**을 제시하고 있습니다. 다만:

1. Import 경로 수정 필요
2. 테스트 엔드포인트를 먼저 실행하여 실제 원인 확인 권장
3. 테스트 결과에 따라 해결책 선택

이 순서로 진행하면 문제를 빠르게 해결할 수 있을 것입니다.

---

**검토 완료일**: 2025-01-XX  
**검토자**: AI Assistant  
**다음 단계**: 테스트 엔드포인트 생성 및 실행
