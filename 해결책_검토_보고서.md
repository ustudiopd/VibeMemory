# í•´ê²°ì±….md ê²€í†  ë³´ê³ ì„œ

## ğŸ“‹ ê°œìš”

ì´ ë¬¸ì„œëŠ” `í•´ê²°ì±….md`ì—ì„œ ì œì•ˆëœ ì›¹í›… ê°œì„  ì‚¬í•­ë“¤ì„ í˜„ì¬ êµ¬í˜„ê³¼ ë¹„êµí•˜ì—¬ ê²€í† í•œ ë³´ê³ ì„œì…ë‹ˆë‹¤.

**ê²€í†  ì¼ì**: 2025-01-XX  
**ê²€í†  ëŒ€ìƒ**: `app/api/github/webhook/route.ts` ë° ê´€ë ¨ ì½”ë“œ

---

## âœ… í˜„ì¬ êµ¬í˜„ ìƒíƒœ

### 1. HMAC ì„œëª… ê²€ì¦

**í˜„ì¬ ìƒíƒœ**: âœ… **ì´ë¯¸ ì˜¬ë°”ë¥´ê²Œ êµ¬í˜„ë¨**

**ì½”ë“œ ìœ„ì¹˜**: `app/api/github/webhook/route.ts:22-33`

```typescript
const payload = await request.text();  // âœ… ì›ë¬¸ ì½ê¸°
if (!verifySignature(payload, signature)) {  // âœ… ì›ë¬¸ìœ¼ë¡œ ê²€ì¦
  return NextResponse.json({ error: 'Invalid signature' }, { status: 401 });
}
const event = JSON.parse(payload);  // âœ… í†µê³¼ í›„ íŒŒì‹±
```

**ê²€í†  ê²°ê³¼**: 
- `req.text()`ë¡œ ì›ë¬¸ì„ ë¨¼ì € ì½ê³  ìˆìŒ
- HMAC ê²€ì¦ í›„ `JSON.parse()` í˜¸ì¶œ
- **í•´ê²°ì±….md ì œì•ˆì‚¬í•­ê³¼ ì¼ì¹˜**

**ê°œì„  í•„ìš”**: ì—†ìŒ

---

### 2. Idempotency ë³´ì¥ (ì¤‘ë³µ ì²˜ë¦¬ ë°©ì§€)

**í˜„ì¬ ìƒíƒœ**: âŒ **êµ¬í˜„ë˜ì§€ ì•ŠìŒ**

**ë¬¸ì œì **:
- `x-github-delivery` í—¤ë”ë¥¼ ì‚¬ìš©í•˜ì§€ ì•ŠìŒ
- GitHubì˜ Redeliver ê¸°ëŠ¥ìœ¼ë¡œ ì¸í•œ ì¤‘ë³µ ì²˜ë¦¬ ê°€ëŠ¥
- ë™ì¼í•œ ì›¹í›…ì´ ì—¬ëŸ¬ ë²ˆ ì‹¤í–‰ë  ìˆ˜ ìˆìŒ

**ì œì•ˆëœ í•´ê²°ì±…**:
```sql
CREATE TABLE IF NOT EXISTS vibememory.webhook_deliveries (
  delivery_id text PRIMARY KEY,
  event text not null,
  received_at timestamptz default now(),
  processed_at timestamptz
);
```

**êµ¬í˜„ í•„ìš”**:
1. `webhook_deliveries` í…Œì´ë¸” ìƒì„±
2. ì›¹í›… ìˆ˜ì‹  ì‹œ `x-github-delivery` í—¤ë” í™•ì¸
3. ì¤‘ë³µ í™•ì¸ í›„ ì²˜ë¦¬ ë˜ëŠ” ì¦‰ì‹œ 200 ë°˜í™˜

**ìš°ì„ ìˆœìœ„**: ğŸ”´ **ë†’ìŒ** (ë³´ì•ˆ/ì •í•©ì„±)

---

### 3. ë¸Œëœì¹˜ í•„í„°ë§

**í˜„ì¬ ìƒíƒœ**: âŒ **êµ¬í˜„ë˜ì§€ ì•ŠìŒ**

**ë¬¸ì œì **:
- ëª¨ë“  ë¸Œëœì¹˜ì˜ push ì´ë²¤íŠ¸ë¥¼ ì²˜ë¦¬
- ë¶ˆí•„ìš”í•œ ì¸ë±ì‹± ë°œìƒ ê°€ëŠ¥
- ê¸°ë³¸ ë¸Œëœì¹˜ê°€ ì•„ë‹Œ ë¸Œëœì¹˜ë„ ì²˜ë¦¬

**ì œì•ˆëœ í•´ê²°ì±…**:
```typescript
if (payload.ref !== 'refs/heads/main') {
  return new Response('skip non-default branch', { status: 200 });
}
```

**êµ¬í˜„ í•„ìš”**:
1. `event.ref` í•„ë“œ í™•ì¸
2. ê¸°ë³¸ ë¸Œëœì¹˜(`main` ë˜ëŠ” `master`)ë§Œ ì²˜ë¦¬
3. ë‹¤ë¥¸ ë¸Œëœì¹˜ëŠ” 200 ë°˜í™˜ í›„ ìŠ¤í‚µ

**ìš°ì„ ìˆœìœ„**: ğŸŸ¡ **ì¤‘ê°„** (ì„±ëŠ¥ ìµœì í™”)

---

### 4. ëŸ°íƒ€ì„ ì„¤ì •

**í˜„ì¬ ìƒíƒœ**: âŒ **ëŸ°íƒ€ì„ ì„¤ì • ì—†ìŒ**

**ë¬¸ì œì **:
- Edge ëŸ°íƒ€ì„ì´ ê¸°ë³¸ì¼ ìˆ˜ ìˆìŒ
- `crypto` ëª¨ë“ˆ ì‚¬ìš© ì‹œ Node.js ëŸ°íƒ€ì„ í•„ìš”
- Service Role Key ì‚¬ìš© ì‹œ Node.js ê¶Œì¥

**ì œì•ˆëœ í•´ê²°ì±…**:
```typescript
export const runtime = 'nodejs';
export const maxDuration = 60;
```

**êµ¬í˜„ í•„ìš”**:
- `app/api/github/webhook/route.ts`ì— ëŸ°íƒ€ì„ ì„¤ì • ì¶”ê°€

**ìš°ì„ ìˆœìœ„**: ğŸ”´ **ë†’ìŒ** (ì•ˆì •ì„±)

---

### 5. ë¹ ë¥¸ ACK + ë¹„ë™ê¸° ì²˜ë¦¬

**í˜„ì¬ ìƒíƒœ**: âŒ **ë™ê¸° ì²˜ë¦¬ ì¤‘**

**ë¬¸ì œì **:
- ì›¹í›… ì—”ë“œí¬ì¸íŠ¸ì—ì„œ ëª¨ë“  ì‘ì—…ì„ ë™ê¸°ì ìœ¼ë¡œ ì²˜ë¦¬
- Vercel Serverless ì œì•½ (10-60ì´ˆ íƒ€ì„ì•„ì›ƒ)
- ë¶€í•˜ ìŠ¤íŒŒì´í¬ ì‹œ íƒ€ì„ì•„ì›ƒ ê°€ëŠ¥

**ì œì•ˆëœ í•´ê²°ì±…**:
1. ì›¹í›… ì—”ë“œí¬ì¸íŠ¸: ë¹ ë¥¸ ACK (200 OK) + ì‘ì—… íì— ë“±ë¡
2. ë³„ë„ ì›Œì»¤: Vercel Cron ë˜ëŠ” ìˆ˜ë™ íŠ¸ë¦¬ê±°ë¡œ ì‘ì—… ì²˜ë¦¬

**êµ¬í˜„ í•„ìš”**:
1. `webhook_jobs` í…Œì´ë¸” ìƒì„±
2. ì›¹í›… ì—”ë“œí¬ì¸íŠ¸ ìˆ˜ì • (ë¹ ë¥¸ ACK)
3. ì›Œì»¤ ë¼ìš°íŠ¸ ìƒì„± (`/api/cron/process-webhook-jobs`)

**ìš°ì„ ìˆœìœ„**: ğŸŸ¡ **ì¤‘ê°„** (ì‹ ë¢°ì„± í–¥ìƒ)

---

### 6. GitHub API ì¬ì‹œë„/ìŠ¤ë¡œí‹€ë§

**í˜„ì¬ ìƒíƒœ**: âš ï¸ **ë¶€ë¶„ êµ¬í˜„**

**í˜„ì¬ ìƒí™©**:
- `lib/utils/retry.ts`ì— ì¬ì‹œë„ ìœ í‹¸ë¦¬í‹° ì¡´ì¬
- ì›¹í›… ì½”ë“œì—ì„œ ì‚¬ìš©í•˜ì§€ ì•ŠìŒ
- `getFileContentWithSha()` í˜¸ì¶œ ì‹œ ì¬ì‹œë„ ì—†ìŒ

**ì œì•ˆëœ í•´ê²°ì±…**:
```typescript
async function withRetry<T>(fn: () => Promise<T>, max=3) { ... }
```

**êµ¬í˜„ í•„ìš”**:
1. GitHub API í˜¸ì¶œì— ì¬ì‹œë„ ë¡œì§ ì¶”ê°€
2. 429/5xx ì—ëŸ¬ì— ëŒ€í•œ ì§€ìˆ˜ ë°±ì˜¤í”„ ì ìš©
3. Octokit throttle í”ŒëŸ¬ê·¸ì¸ ê³ ë ¤

**ìš°ì„ ìˆœìœ„**: ğŸŸ¡ **ì¤‘ê°„** (ì‹ ë¢°ì„± í–¥ìƒ)

---

### 7. íŒŒì¼ ì„¸íŠ¸ ê³„ì‚° ì •í™•ë„

**í˜„ì¬ ìƒíƒœ**: âš ï¸ **ê¸°ë³¸ êµ¬í˜„ë§Œ ìˆìŒ**

**í˜„ì¬ êµ¬í˜„**:
```typescript
const modifiedFiles = event.commits
  .flatMap((commit: any) => commit.modified || [])
  .filter((path: string) => path.endsWith('.md'));
```

**ë¬¸ì œì **:
- ì¤‘ë³µ íŒŒì¼ ê²½ë¡œ ê°€ëŠ¥
- í° pushì˜ ê²½ìš° ëˆ„ë½ ê°€ëŠ¥
- ìˆœì„œ ë³´ì¥ ì—†ìŒ

**ì œì•ˆëœ í•´ê²°ì±…**:
1. ì¤‘ë³µ ì œê±° ë° ì •ë ¬
2. Git Compare APIë¡œ ìµœì¢… ë³€ê²½ íŒŒì¼ ì¬í™•ì¸

**êµ¬í˜„ í•„ìš”**:
1. `Set`ì„ ì‚¬ìš©í•œ ì¤‘ë³µ ì œê±°
2. Git Compare API í†µí•© (ì„ íƒì )

**ìš°ì„ ìˆœìœ„**: ğŸŸ¢ **ë‚®ìŒ** (ì •í™•ë„ í–¥ìƒ)

---

### 8. RAG ì²­í¬ ì •ë¦¬ ë°°ì¹˜

**í˜„ì¬ ìƒíƒœ**: âš ï¸ **ë§ˆí‚¹ë§Œ êµ¬í˜„, ì •ë¦¬ ì—†ìŒ**

**í˜„ì¬ êµ¬í˜„**:
- ìˆ˜ì • ì‹œ `is_current = false`ë¡œ ë§ˆí‚¹
- ì˜¤ë˜ëœ ì²­í¬ ì •ë¦¬ ì—†ìŒ

**ë¬¸ì œì **:
- `is_current = false` ì²­í¬ê°€ ëˆ„ì ë¨
- ë²¡í„° ì¸ë±ìŠ¤ í¬ê¸° ì¦ê°€

**ì œì•ˆëœ í•´ê²°ì±…**:
- ì•¼ê°„ ë°°ì¹˜ë¡œ ì˜¤ë˜ëœ ì²­í¬ ì‚­ì œ ë˜ëŠ” ì•„ì¹´ì´ë¸Œ

**êµ¬í˜„ í•„ìš”**:
1. Cron ì‘ì—… ìƒì„± (`/api/cron/cleanup-old-chunks`)
2. `is_current = false`ì´ê³  ì˜¤ë˜ëœ ì²­í¬ ì‚­ì œ

**ìš°ì„ ìˆœìœ„**: ğŸŸ¢ **ë‚®ìŒ** (ì„±ëŠ¥ ìµœì í™”)

---

### 9. ìƒê´€ê´€ê³„ ID (Log Correlation)

**í˜„ì¬ ìƒíƒœ**: âŒ **êµ¬í˜„ë˜ì§€ ì•ŠìŒ**

**í˜„ì¬ ë¡œê·¸**:
```typescript
console.log(`[WEBHOOK] Processing push event for ${repoOwner}/${repoName}`);
```

**ë¬¸ì œì **:
- Delivery ID, Project ID, Job IDê°€ ë¡œê·¸ì— í¬í•¨ë˜ì§€ ì•ŠìŒ
- ë°°í¬ í™˜ê²½ì—ì„œ ì›ì¸ ì¶”ì  ì–´ë ¤ì›€

**ì œì•ˆëœ í•´ê²°ì±…**:
```typescript
const logContext = { deliveryId, projectId, jobName };
console.log(`[WEBHOOK] Processing push event`, logContext);
```

**êµ¬í˜„ í•„ìš”**:
1. ëª¨ë“  ë¡œê·¸ì— ì»¨í…ìŠ¤íŠ¸ ì •ë³´ ì¶”ê°€
2. êµ¬ì¡°í™”ëœ ë¡œê¹… í˜•ì‹ ì‚¬ìš©

**ìš°ì„ ìˆœìœ„**: ğŸŸ¡ **ì¤‘ê°„** (ìš´ì˜ í’ˆì§ˆ)

---

### 10. ì—ëŸ¬ í‘œì¤€í™” & ìƒíƒœ ì „íŒŒ

**í˜„ì¬ ìƒíƒœ**: âš ï¸ **ê¸°ë³¸ êµ¬í˜„ë§Œ ìˆìŒ**

**í˜„ì¬ êµ¬í˜„**:
- ì—ëŸ¬ ë°œìƒ ì‹œ `500` ë°˜í™˜
- ë¡œê·¸ì— ì—ëŸ¬ ê¸°ë¡

**ì œì•ˆëœ í•´ê²°ì±…**:
- `webhook_jobs.status='error'` ì €ì¥
- ì—ëŸ¬ ì •ë³´ë¥¼ êµ¬ì¡°í™”í•˜ì—¬ ì €ì¥
- ëŒ€ì‹œë³´ë“œì—ì„œ í™•ì¸ ê°€ëŠ¥í•˜ë„ë¡

**êµ¬í˜„ í•„ìš”**:
1. ì—ëŸ¬ ì •ë³´ êµ¬ì¡°í™”
2. ìƒíƒœ ì €ì¥ ë¡œì§ ì¶”ê°€
3. ëŒ€ì‹œë³´ë“œ UI (í–¥í›„)

**ìš°ì„ ìˆœìœ„**: ğŸŸ¡ **ì¤‘ê°„** (ìš´ì˜ í’ˆì§ˆ)

---

## ğŸ“Š ìš°ì„ ìˆœìœ„ë³„ ê°œì„  ì‚¬í•­ ìš”ì•½

### ğŸ”´ ë†’ì€ ìš°ì„ ìˆœìœ„ (Must-Fix)

1. **Idempotency ë³´ì¥**
   - `webhook_deliveries` í…Œì´ë¸” ìƒì„±
   - `x-github-delivery` í—¤ë” í™•ì¸
   - ì¤‘ë³µ ì²˜ë¦¬ ë°©ì§€

2. **ëŸ°íƒ€ì„ ì„¤ì •**
   - `export const runtime = 'nodejs'` ì¶”ê°€
   - `export const maxDuration = 60` ì¶”ê°€

### ğŸŸ¡ ì¤‘ê°„ ìš°ì„ ìˆœìœ„ (ì‹ ë¢°ì„±/ìš´ì˜ í–¥ìƒ)

3. **ë¸Œëœì¹˜ í•„í„°ë§**
   - ê¸°ë³¸ ë¸Œëœì¹˜ë§Œ ì²˜ë¦¬
   - ë‹¤ë¥¸ ë¸Œëœì¹˜ëŠ” ìŠ¤í‚µ

4. **ë¹ ë¥¸ ACK + ë¹„ë™ê¸° ì²˜ë¦¬**
   - ì‘ì—… í ì‹œìŠ¤í…œ êµ¬ì¶•
   - ì›Œì»¤ ë¼ìš°íŠ¸ ìƒì„±

5. **GitHub API ì¬ì‹œë„**
   - ì¬ì‹œë„ ìœ í‹¸ë¦¬í‹° ì ìš©
   - ì§€ìˆ˜ ë°±ì˜¤í”„ êµ¬í˜„

6. **ìƒê´€ê´€ê³„ ID**
   - êµ¬ì¡°í™”ëœ ë¡œê¹…
   - ì»¨í…ìŠ¤íŠ¸ ì •ë³´ ì¶”ê°€

7. **ì—ëŸ¬ í‘œì¤€í™”**
   - ì—ëŸ¬ ì •ë³´ êµ¬ì¡°í™”
   - ìƒíƒœ ì €ì¥

### ğŸŸ¢ ë‚®ì€ ìš°ì„ ìˆœìœ„ (ì„±ëŠ¥ ìµœì í™”)

8. **íŒŒì¼ ì„¸íŠ¸ ê³„ì‚° ì •í™•ë„**
   - ì¤‘ë³µ ì œê±°
   - Git Compare API í†µí•© (ì„ íƒì )

9. **RAG ì²­í¬ ì •ë¦¬ ë°°ì¹˜**
   - ì•¼ê°„ ë°°ì¹˜ ì‘ì—…
   - ì˜¤ë˜ëœ ì²­í¬ ì‚­ì œ

---

## ğŸ” ìƒì„¸ ê²€í†  ê²°ê³¼

### 1. HMAC ê²€ì¦ (âœ… ì™„ë£Œ)

**í˜„ì¬ ì½”ë“œ**:
```typescript:22:41:app/api/github/webhook/route.ts
const payload = await request.text();
if (!verifySignature(payload, signature)) {
  return NextResponse.json({ error: 'Invalid signature' }, { status: 401 });
}
const event = JSON.parse(payload);
```

**ê²€í†  ê²°ê³¼**: 
- âœ… ì›ë¬¸(`req.text()`)ìœ¼ë¡œ HMAC ê²€ì¦
- âœ… ê²€ì¦ í†µê³¼ í›„ `JSON.parse()` í˜¸ì¶œ
- âœ… `crypto.timingSafeEqual()` ì‚¬ìš©

**ê²°ë¡ **: **ì´ë¯¸ ì˜¬ë°”ë¥´ê²Œ êµ¬í˜„ë˜ì–´ ìˆìŒ. ê°œì„  ë¶ˆí•„ìš”.**

---

### 2. Idempotency (âŒ ë¯¸êµ¬í˜„)

**í˜„ì¬ ì½”ë“œ**: `x-github-delivery` í—¤ë”ë¥¼ ì‚¬ìš©í•˜ì§€ ì•ŠìŒ

**ì œì•ˆëœ êµ¬í˜„**:
```typescript
// 1. Delivery ID ì¶”ì¶œ
const deliveryId = request.headers.get('x-github-delivery') || '';

// 2. ì¤‘ë³µ í™•ì¸
const { data: existing } = await supabaseAdmin
  .from('webhook_deliveries')
  .select('delivery_id')
  .eq('delivery_id', deliveryId)
  .maybeSingle();

if (existing) {
  console.log(`[WEBHOOK] Duplicate delivery: ${deliveryId}`);
  return NextResponse.json({ message: 'duplicate delivery' }, { status: 200 });
}

// 3. Delivery ê¸°ë¡
await supabaseAdmin
  .from('webhook_deliveries')
  .insert({ delivery_id: deliveryId, event: eventType });
```

**í•„ìš”í•œ í…Œì´ë¸”**:
```sql
CREATE TABLE IF NOT EXISTS vibememory.webhook_deliveries (
  delivery_id text PRIMARY KEY,
  event text not null,
  received_at timestamptz default now(),
  processed_at timestamptz,
  project_id uuid,
  status text default 'pending' -- pending|processing|done|error
);
```

**ìš°ì„ ìˆœìœ„**: ğŸ”´ **ë†’ìŒ**

---

### 3. ë¸Œëœì¹˜ í•„í„°ë§ (âŒ ë¯¸êµ¬í˜„)

**í˜„ì¬ ì½”ë“œ**: ë¸Œëœì¹˜ í™•ì¸ ì—†ìŒ

**ì œì•ˆëœ êµ¬í˜„**:
```typescript
// ê¸°ë³¸ ë¸Œëœì¹˜ í™•ì¸
const defaultBranch = repository.default_branch || 'main';
const ref = event.ref; // ì˜ˆ: 'refs/heads/main'

if (ref !== `refs/heads/${defaultBranch}`) {
  console.log(`[WEBHOOK] Skipping non-default branch: ${ref}`);
  return NextResponse.json(
    { message: 'skip non-default branch' },
    { status: 200 }
  );
}
```

**ìš°ì„ ìˆœìœ„**: ğŸŸ¡ **ì¤‘ê°„**

---

### 4. ëŸ°íƒ€ì„ ì„¤ì • (âŒ ë¯¸êµ¬í˜„)

**í˜„ì¬ ì½”ë“œ**: ëŸ°íƒ€ì„ ì„¤ì • ì—†ìŒ

**ì œì•ˆëœ êµ¬í˜„**:
```typescript
// app/api/github/webhook/route.ts ìƒë‹¨ì— ì¶”ê°€
export const runtime = 'nodejs';
export const maxDuration = 60;
```

**ì´ìœ **:
- `crypto` ëª¨ë“ˆ ì‚¬ìš© (Node.js í•„ìš”)
- Service Role Key ì‚¬ìš© (Node.js ê¶Œì¥)
- ê¸´ ì²˜ë¦¬ ì‹œê°„ (íŒŒì¼ ì²˜ë¦¬, ì„ë² ë”© ë“±)

**ìš°ì„ ìˆœìœ„**: ğŸ”´ **ë†’ìŒ**

---

### 5. ë¹ ë¥¸ ACK + ë¹„ë™ê¸° ì²˜ë¦¬ (âŒ ë¯¸êµ¬í˜„)

**í˜„ì¬ êµ¬ì¡°**: ë™ê¸° ì²˜ë¦¬

**ì œì•ˆëœ êµ¬ì¡°**:

**ì›¹í›… ì—”ë“œí¬ì¸íŠ¸** (ë¹ ë¥¸ ACK):
```typescript
// 1. ê²€ì¦ ë° ì¤‘ë³µ í™•ì¸
// 2. ì‘ì—… íì— ë“±ë¡
await supabaseAdmin
  .from('webhook_jobs')
  .insert({
    delivery_id: deliveryId,
    project_id: projectId,
    payload: event,
    status: 'pending',
  });

// 3. ì¦‰ì‹œ 200 ë°˜í™˜
return NextResponse.json({ message: 'Webhook queued' }, { status: 200 });
```

**ì›Œì»¤ ë¼ìš°íŠ¸** (`/api/cron/process-webhook-jobs`):
```typescript
// 1. pending ì‘ì—… ì¡°íšŒ
// 2. claim_jobìœ¼ë¡œ ì ê¸ˆ íšë“
// 3. íŒŒì¼ ì²˜ë¦¬
// 4. ìƒíƒœ ì—…ë°ì´íŠ¸ (done/error)
```

**í•„ìš”í•œ í…Œì´ë¸”**:
```sql
CREATE TABLE vibememory.webhook_jobs (
  id uuid primary key default gen_random_uuid(),
  delivery_id text not null unique,
  project_id uuid not null,
  payload jsonb not null,
  status text not null default 'pending',
  error_json jsonb,
  created_at timestamptz default now(),
  updated_at timestamptz default now()
);
```

**ìš°ì„ ìˆœìœ„**: ğŸŸ¡ **ì¤‘ê°„** (í˜„ì¬ êµ¬ì¡°ë„ ì‘ë™í•˜ì§€ë§Œ ê°œì„  ê¶Œì¥)

---

### 6. GitHub API ì¬ì‹œë„ (âš ï¸ ë¶€ë¶„ êµ¬í˜„)

**í˜„ì¬ ìƒí™©**:
- `lib/utils/retry.ts`ì— ì¬ì‹œë„ ìœ í‹¸ë¦¬í‹° ì¡´ì¬
- ì›¹í›…ì—ì„œ ì‚¬ìš©í•˜ì§€ ì•ŠìŒ

**ì œì•ˆëœ êµ¬í˜„**:
```typescript
import { retryWithBackoff } from '@/lib/utils/retry';

// GitHub API í˜¸ì¶œì— ì¬ì‹œë„ ì ìš©
const { content, sha } = await retryWithBackoff(
  () => getFileContentWithSha(accessToken, repoOwner, repoName, filePath),
  {
    maxRetries: 3,
    initialDelay: 1000,
    onRetry: (attempt, error) => {
      console.warn(`[WEBHOOK] Retrying getFileContentWithSha (attempt ${attempt})`, error);
    },
  }
);
```

**ìš°ì„ ìˆœìœ„**: ğŸŸ¡ **ì¤‘ê°„**

---

### 7. íŒŒì¼ ì„¸íŠ¸ ê³„ì‚° ì •í™•ë„ (âš ï¸ ê¸°ë³¸ êµ¬í˜„)

**í˜„ì¬ ì½”ë“œ**:
```typescript
const modifiedFiles = event.commits
  .flatMap((commit: any) => commit.modified || [])
  .filter((path: string) => path.endsWith('.md'));
```

**ê°œì„  ì œì•ˆ**:
```typescript
// ì¤‘ë³µ ì œê±° ë° ì •ë ¬
const modifiedFiles = Array.from(new Set(
  event.commits
    .flatMap((commit: any) => commit.modified || [])
    .filter((path: string) => path.endsWith('.md'))
)).sort();
```

**ìš°ì„ ìˆœìœ„**: ğŸŸ¢ **ë‚®ìŒ**

---

### 8. RAG ì²­í¬ ì •ë¦¬ ë°°ì¹˜ (âš ï¸ ë§ˆí‚¹ë§Œ êµ¬í˜„)

**í˜„ì¬ êµ¬í˜„**:
- `is_current = false`ë¡œ ë§ˆí‚¹ë§Œ ìˆ˜í–‰
- ì˜¤ë˜ëœ ì²­í¬ ì •ë¦¬ ì—†ìŒ

**ì œì•ˆëœ êµ¬í˜„**:
```typescript
// app/api/cron/cleanup-old-chunks/route.ts
// 7ì¼ ì´ìƒ ëœ is_current=false ì²­í¬ ì‚­ì œ
await supabaseAdmin
  .from('repo_file_chunks')
  .delete()
  .eq('is_current', false)
  .lt('updated_at', new Date(Date.now() - 7 * 24 * 60 * 60 * 1000).toISOString());
```

**ìš°ì„ ìˆœìœ„**: ğŸŸ¢ **ë‚®ìŒ**

---

### 9. ìƒê´€ê´€ê³„ ID (âŒ ë¯¸êµ¬í˜„)

**í˜„ì¬ ë¡œê·¸**:
```typescript
console.log(`[WEBHOOK] Processing push event for ${repoOwner}/${repoName}`);
```

**ê°œì„  ì œì•ˆ**:
```typescript
// ì»¨í…ìŠ¤íŠ¸ ê°ì²´ ìƒì„±
const logContext = {
  deliveryId: request.headers.get('x-github-delivery'),
  projectId,
  jobName,
  repoOwner,
  repoName,
};

// ëª¨ë“  ë¡œê·¸ì— ì»¨í…ìŠ¤íŠ¸ í¬í•¨
console.log(`[WEBHOOK] Processing push event`, logContext);
console.log(`[WEBHOOK] Files to process`, { ...logContext, fileCount: modifiedFiles.length });
```

**ìš°ì„ ìˆœìœ„**: ğŸŸ¡ **ì¤‘ê°„**

---

### 10. ì—ëŸ¬ í‘œì¤€í™” (âš ï¸ ê¸°ë³¸ êµ¬í˜„)

**í˜„ì¬ êµ¬í˜„**:
```typescript
catch (error) {
  console.error('[WEBHOOK] Error processing webhook:', error);
  return NextResponse.json({ error: 'Internal server error' }, { status: 500 });
}
```

**ê°œì„  ì œì•ˆ**:
```typescript
catch (error) {
  const errorInfo = {
    message: error instanceof Error ? error.message : 'Unknown error',
    stack: error instanceof Error ? error.stack : undefined,
    deliveryId,
    projectId,
  };
  
  // ì—ëŸ¬ ì •ë³´ ì €ì¥
  if (deliveryId) {
    await supabaseAdmin
      .from('webhook_jobs')
      .update({ status: 'error', error_json: errorInfo })
      .eq('delivery_id', deliveryId);
  }
  
  console.error('[WEBHOOK] Error processing webhook:', errorInfo);
  return NextResponse.json({ error: 'Internal server error' }, { status: 500 });
}
```

**ìš°ì„ ìˆœìœ„**: ğŸŸ¡ **ì¤‘ê°„**

---

## ğŸ“ êµ¬í˜„ ê³„íš

### Phase 1: í•„ìˆ˜ ìˆ˜ì • (Must-Fix)

1. **ëŸ°íƒ€ì„ ì„¤ì • ì¶”ê°€**
   - `app/api/github/webhook/route.ts`ì— `runtime = 'nodejs'` ì¶”ê°€
   - `maxDuration = 60` ì¶”ê°€

2. **Idempotency êµ¬í˜„**
   - `webhook_deliveries` í…Œì´ë¸” ìƒì„± (ë§ˆì´ê·¸ë ˆì´ì…˜)
   - `x-github-delivery` í—¤ë” í™•ì¸
   - ì¤‘ë³µ ì²˜ë¦¬ ë°©ì§€ ë¡œì§ ì¶”ê°€

**ì˜ˆìƒ ì‹œê°„**: 1-2ì‹œê°„

### Phase 2: ì‹ ë¢°ì„± í–¥ìƒ

3. **ë¸Œëœì¹˜ í•„í„°ë§**
   - ê¸°ë³¸ ë¸Œëœì¹˜ í™•ì¸ ë¡œì§ ì¶”ê°€

4. **ìƒê´€ê´€ê³„ ID**
   - ë¡œê·¸ ì»¨í…ìŠ¤íŠ¸ ê°ì²´ ìƒì„±
   - ëª¨ë“  ë¡œê·¸ì— ì»¨í…ìŠ¤íŠ¸ ì¶”ê°€

5. **GitHub API ì¬ì‹œë„**
   - `retryWithBackoff` ì ìš©
   - ì—ëŸ¬ ì²˜ë¦¬ ê°œì„ 

**ì˜ˆìƒ ì‹œê°„**: 2-3ì‹œê°„

### Phase 3: ì„±ëŠ¥ ìµœì í™” (ì„ íƒì )

6. **ë¹ ë¥¸ ACK + ë¹„ë™ê¸° ì²˜ë¦¬**
   - `webhook_jobs` í…Œì´ë¸” ìƒì„±
   - ì›Œì»¤ ë¼ìš°íŠ¸ êµ¬í˜„
   - ì›¹í›… ì—”ë“œí¬ì¸íŠ¸ ìˆ˜ì •

7. **íŒŒì¼ ì„¸íŠ¸ ê³„ì‚° ì •í™•ë„**
   - ì¤‘ë³µ ì œê±°
   - Git Compare API í†µí•© (ì„ íƒì )

8. **RAG ì²­í¬ ì •ë¦¬ ë°°ì¹˜**
   - Cron ì‘ì—… ìƒì„±
   - ì˜¤ë˜ëœ ì²­í¬ ì‚­ì œ ë¡œì§

**ì˜ˆìƒ ì‹œê°„**: 4-6ì‹œê°„

---

## ğŸ¯ ê¶Œì¥ êµ¬í˜„ ìˆœì„œ

### ì¦‰ì‹œ êµ¬í˜„ (ì´ë²ˆ ì£¼)

1. âœ… ëŸ°íƒ€ì„ ì„¤ì • ì¶”ê°€
2. âœ… Idempotency êµ¬í˜„
3. âœ… ë¸Œëœì¹˜ í•„í„°ë§

### ë‹¤ìŒ ë‹¨ê³„ (ë‹¤ìŒ ì£¼)

4. ìƒê´€ê´€ê³„ ID
5. GitHub API ì¬ì‹œë„
6. ì—ëŸ¬ í‘œì¤€í™”

### í–¥í›„ ê°œì„  (ì„ íƒì )

7. ë¹ ë¥¸ ACK + ë¹„ë™ê¸° ì²˜ë¦¬
8. íŒŒì¼ ì„¸íŠ¸ ê³„ì‚° ì •í™•ë„
9. RAG ì²­í¬ ì •ë¦¬ ë°°ì¹˜

---

## ğŸ“Š í˜„ì¬ vs ì œì•ˆ ë¹„êµí‘œ

| í•­ëª© | í˜„ì¬ ìƒíƒœ | ì œì•ˆ ìƒíƒœ | ìš°ì„ ìˆœìœ„ |
|------|----------|----------|---------|
| HMAC ê²€ì¦ | âœ… ì˜¬ë°”ë¦„ | âœ… ìœ ì§€ | - |
| Idempotency | âŒ ì—†ìŒ | âœ… êµ¬í˜„ í•„ìš” | ğŸ”´ ë†’ìŒ |
| ë¸Œëœì¹˜ í•„í„°ë§ | âŒ ì—†ìŒ | âœ… êµ¬í˜„ í•„ìš” | ğŸŸ¡ ì¤‘ê°„ |
| ëŸ°íƒ€ì„ ì„¤ì • | âŒ ì—†ìŒ | âœ… ì¶”ê°€ í•„ìš” | ğŸ”´ ë†’ìŒ |
| ë¹ ë¥¸ ACK | âŒ ë™ê¸° ì²˜ë¦¬ | âœ… ë¹„ë™ê¸° ê¶Œì¥ | ğŸŸ¡ ì¤‘ê°„ |
| API ì¬ì‹œë„ | âš ï¸ ë¶€ë¶„ | âœ… ì™„ì „ êµ¬í˜„ | ğŸŸ¡ ì¤‘ê°„ |
| íŒŒì¼ ì„¸íŠ¸ ì •í™•ë„ | âš ï¸ ê¸°ë³¸ | âœ… ê°œì„  ê¶Œì¥ | ğŸŸ¢ ë‚®ìŒ |
| ì²­í¬ ì •ë¦¬ | âš ï¸ ë§ˆí‚¹ë§Œ | âœ… ë°°ì¹˜ ì •ë¦¬ | ğŸŸ¢ ë‚®ìŒ |
| ìƒê´€ê´€ê³„ ID | âŒ ì—†ìŒ | âœ… ì¶”ê°€ í•„ìš” | ğŸŸ¡ ì¤‘ê°„ |
| ì—ëŸ¬ í‘œì¤€í™” | âš ï¸ ê¸°ë³¸ | âœ… êµ¬ì¡°í™” í•„ìš” | ğŸŸ¡ ì¤‘ê°„ |

---

## ğŸ”§ ì½”ë“œ íŒ¨ì¹˜ ì˜ˆì‹œ

### íŒ¨ì¹˜ 1: ëŸ°íƒ€ì„ ì„¤ì • + Idempotency + ë¸Œëœì¹˜ í•„í„°ë§

```typescript
// app/api/github/webhook/route.ts ìƒë‹¨
export const runtime = 'nodejs';
export const maxDuration = 60;

export async function POST(request: NextRequest) {
  // 1. Delivery ID ì¶”ì¶œ
  const deliveryId = request.headers.get('x-github-delivery') || '';
  const signature = request.headers.get('x-hub-signature-256');
  const eventType = request.headers.get('x-github-event') || '';
  
  // 2. ì›ë¬¸ ì½ê¸° ë° HMAC ê²€ì¦
  const payload = await request.text();
  if (!signature || !verifySignature(payload, signature)) {
    return NextResponse.json({ error: 'Invalid signature' }, { status: 401 });
  }
  
  const event = JSON.parse(payload);
  
  // 3. Idempotency í™•ì¸
  if (deliveryId) {
    const { data: existing } = await supabaseAdmin
      .from('webhook_deliveries')
      .select('delivery_id')
      .eq('delivery_id', deliveryId)
      .maybeSingle();
    
    if (existing) {
      console.log(`[WEBHOOK] Duplicate delivery: ${deliveryId}`);
      return NextResponse.json({ message: 'duplicate delivery' }, { status: 200 });
    }
    
    // Delivery ê¸°ë¡
    await supabaseAdmin
      .from('webhook_deliveries')
      .insert({ delivery_id: deliveryId, event: eventType });
  }
  
  // 4. ì´ë²¤íŠ¸ íƒ€ì… í™•ì¸
  if (eventType !== 'push') {
    return NextResponse.json({ message: 'Event ignored' }, { status: 200 });
  }
  
  // 5. ë¸Œëœì¹˜ í•„í„°ë§
  const defaultBranch = event.repository?.default_branch || 'main';
  const ref = event.ref || '';
  
  if (ref !== `refs/heads/${defaultBranch}`) {
    console.log(`[WEBHOOK] Skipping non-default branch: ${ref}`);
    return NextResponse.json(
      { message: 'skip non-default branch' },
      { status: 200 }
    );
  }
  
  // ... ë‚˜ë¨¸ì§€ ì²˜ë¦¬ ë¡œì§
}
```

---

## ğŸ“š ì°¸ê³  ìë£Œ

- [GitHub Webhooks Guide](https://docs.github.com/en/webhooks)
- [Vercel Serverless Functions](https://vercel.com/docs/functions)
- [Supabase RPC Functions](https://supabase.com/docs/guides/database/functions)

---

**ì‘ì„±ì¼**: 2025-01-XX  
**ê²€í† ì**: AI Assistant  
**ë²„ì „**: 1.0.0
