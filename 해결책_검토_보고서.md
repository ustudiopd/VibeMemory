# 해결책.md 검토 보고서

**작성일**: 2025-01-XX  
**검토 대상**: `해결책.md` - 프로젝트 만들기(아이디어 생성) 기능 구현 플랜 검토·보강안  
**현재 구현 상태**: v1 완료, v1.1 부분 완료

---

## 📊 전체 평가

**전체적인 평가**: ⭐⭐⭐⭐☆ (4/5)

`해결책.md`의 제안사항은 대부분 타당하고 실용적입니다. 현재 구현 상태와 비교했을 때, **핵심 기능은 이미 구현되어 있으나**, 몇 가지 중요한 보강 사항이 누락되어 있습니다.

---

## ✅ 구현 완료된 항목

### 1. 스키마 기본 구조 ✅

**제안사항**:
- `project_type` ENUM 생성
- `repo_*` 필드 nullable 변경
- 체크 제약 (`projects_github_requires_repo_url`)
- `project_type` 인덱스

**현재 상태**: ✅ **완료**
- `migrations/create_idea_project_tables.sql`에 모두 구현됨
- 체크 제약도 정상 작동

**코드 위치**:
```sql
-- migrations/create_idea_project_tables.sql:1-38
CREATE TYPE vibememory.project_type AS ENUM ('github', 'idea');
ALTER TABLE vibememory.projects ADD COLUMN project_type ...;
ALTER TABLE vibememory.projects ALTER COLUMN repo_owner DROP NOT NULL;
-- 체크 제약 및 인덱스 모두 구현됨
```

### 2. API 플로우 ✅

**제안사항**:
- `POST /api/projects/create`에서 `project_type='idea'`면 스캔/ingestion_runs 생략

**현재 상태**: ✅ **완료**
- `app/api/projects/create/route.ts`에서 구현됨
- 아이디어 프로젝트 생성 시 `ingestion_runs`, `scan_progress` 생성하지 않음

**코드 위치**:
```typescript
// app/api/projects/create/route.ts:98-99
// 아이디어 프로젝트는 ingestion_runs, scan_progress 생성하지 않음
// project_analysis도 생성하지 않음 (선택적)
```

### 3. 챗봇 RAG 구현 ✅ (v1.1 수준)

**제안사항**:
- v1.1: `project_doc_chunks`(pgvector) 추가해 소형 RAG 활성화

**현재 상태**: ✅ **v1.1 수준으로 완료**
- `idea_project_chunks` 테이블이 이미 구현되어 있음
- `search_idea_project_chunks_rrf` RPC 함수로 RAG 검색 구현
- 챗봇 API에서 `project_type`에 따라 다른 RPC 함수 호출

**코드 위치**:
```typescript
// app/api/projects/[id]/chat/route.ts:82-99
if (project.project_type === 'idea') {
  const { data: ideaSearchResults } = await supabaseAdmin.rpc(
    'search_idea_project_chunks_rrf',
    { ... }
  );
}
```

### 4. UI 조건부 렌더링 ✅

**제안사항**:
- 아이디어 타입: 진행률/파일 탭은 "스캔 불필요" 안내
- 대시보드에 "GitHub / 아이디어" 배지

**현재 상태**: ✅ **완료**
- `app/dashboard/projects/[id]/page.tsx`에서 `project_type`에 따라 탭 조건부 렌더링
- 대시보드에 프로젝트 타입 태그 표시 (`app/dashboard/page.tsx`)

**코드 위치**:
```typescript
// app/dashboard/projects/[id]/page.tsx
// project_type에 따라 tabs 배열 동적 생성
// idea 타입일 때 IdeaNoteTab 렌더링
```

---

## ⚠️ 누락된 항목 (중요)

### 1. 부분 유니크 제약 (Partial Unique Index) ❌

**제안사항**:
```sql
-- github만 (owner_id, repo_owner, repo_name) 유니크
CREATE UNIQUE INDEX IF NOT EXISTS uq_projects_github
  ON vibememory.projects (owner_id, repo_owner, repo_name)
  WHERE project_type='github';

-- idea만 (owner_id, project_name) 유니크
CREATE UNIQUE INDEX IF NOT EXISTS uq_projects_idea
  ON vibememory.projects (owner_id, project_name)
  WHERE project_type='idea';
```

**현재 상태**: ❌ **누락**
- 마이그레이션 파일에 부분 유니크 인덱스가 없음
- 중복 프로젝트 생성 방지가 DB 레벨에서 보장되지 않음

**영향도**: 🔴 **높음**
- 같은 사용자가 동일한 GitHub 리포지토리를 여러 번 가져올 수 있음
- 같은 사용자가 동일한 이름의 아이디어 프로젝트를 여러 개 만들 수 있음
- 데이터 무결성 문제 발생 가능

**권장 조치**: 즉시 추가 필요

### 2. 아이디어 문서 CRUD API (선택 사항) ⚠️

**제안사항**:
- `/api/projects/:id/docs*` 엔드포인트 (POST, PATCH, GET, DELETE)
- v1.1에서 `:docId/embeddings:refresh` 추가

**현재 상태**: ⚠️ **부분 구현**
- 파일 업로드: `/api/projects/[id]/idea/files` (POST) ✅
- 파일 목록 조회: `/api/projects/[id]/idea/files` (GET) ✅
- 파일 수정/삭제: ❌ 없음
- 재임베딩 엔드포인트: ❌ 없음

**영향도**: 🟡 **중간**
- 현재는 파일 업로드만 가능하고, 수정/삭제가 불가능
- 파일 내용 변경 시 재임베딩이 자동으로 되지 않음

**권장 조치**: v1.1에서 추가 고려

### 3. 아이디어 → GitHub 전환 API (옵션) ❌

**제안사항**:
- `/api/projects/:id/attach-github`
- GitHub 연결 시 `project_type='github'`로 전환 + webhook 등록 + 스캔 큐 투입

**현재 상태**: ❌ **미구현**

**영향도**: 🟢 **낮음** (옵션 기능)
- 아이디어 프로젝트를 GitHub 프로젝트로 업그레이드하는 기능
- 현재는 수동으로 새로 생성해야 함

**권장 조치**: 향후 추가 고려

---

## 📝 세부 검토

### 1. 스키마 보강안 검토

#### ✅ 잘 구현된 부분
- ENUM 타입 생성 (안전한 방식으로 `DO $$ BEGIN ... EXCEPTION` 사용)
- 체크 제약으로 데이터 무결성 보장
- 인덱스로 조회 성능 최적화

#### ❌ 누락된 부분
- **부분 유니크 인덱스**: 가장 중요한 누락 사항
  - GitHub 프로젝트 중복 방지
  - 아이디어 프로젝트 중복 방지

**권장 마이그레이션**:
```sql
-- migrations/add_partial_unique_indexes.sql
-- GitHub 프로젝트 중복 방지
CREATE UNIQUE INDEX IF NOT EXISTS uq_projects_github
  ON vibememory.projects (owner_id, repo_owner, repo_name)
  WHERE project_type = 'github';

-- 아이디어 프로젝트 중복 방지
CREATE UNIQUE INDEX IF NOT EXISTS uq_projects_idea
  ON vibememory.projects (owner_id, project_name)
  WHERE project_type = 'idea' AND project_name IS NOT NULL;
```

### 2. 아이디어 문서 설계 검토

#### ✅ v1.1 수준으로 이미 구현됨
- `idea_project_files` 테이블: 파일 메타데이터 저장 ✅
- `idea_project_chunks` 테이블: 벡터 임베딩 저장 ✅
- RAG 검색: `search_idea_project_chunks_rrf` RPC 함수 ✅

#### ⚠️ 개선 가능한 부분
- **문서 타입 구분**: `해결책.md`에서 제안한 `doc_type['brief'|'tech'|'product']`가 없음
  - 현재는 파일명으로만 구분
  - 문서 타입별 관리가 어려움

**권장 개선**:
```sql
-- idea_project_files 테이블에 doc_type 컬럼 추가
ALTER TABLE vibememory.idea_project_files
ADD COLUMN IF NOT EXISTS doc_type text CHECK (doc_type IN ('brief', 'tech', 'product'));
```

### 3. API/플로우 검토

#### ✅ 잘 구현된 부분
- 프로젝트 생성 시 `project_type`에 따라 분기 처리
- 아이디어 프로젝트는 스캔 관련 테이블 생성하지 않음
- 챗봇 API에서 `project_type`에 따라 다른 RPC 함수 호출

#### ⚠️ 개선 가능한 부분
- **기본 문서 자동 생성**: 제안사항 중 "(선택) 생성 직후 `brief/tech` 2개 기본 문서 자동 생성"이 없음
  - 사용자가 처음부터 빈 프로젝트로 시작
  - 템플릿 제공 시 사용성 향상 가능

### 4. 프런트/UX 검토

#### ✅ 잘 구현된 부분
- 대시보드에 프로젝트 타입 태그 표시
- 프로젝트 상세 페이지에서 조건부 탭 렌더링
- 아이디어 프로젝트는 `IdeaNoteTab` 컴포넌트 사용

#### ⚠️ 개선 가능한 부분
- **진행률 탭**: 아이디어 프로젝트일 때 "스캔 불필요" 안내가 명확하지 않을 수 있음
- **파일 탭**: 아이디어 프로젝트일 때 빈 상태 안내가 필요할 수 있음

### 5. RLS·보안 검토

#### ✅ 잘 구현된 부분
- `projects` 테이블 RLS 정책: owner 기반 ✅
- `idea_project_files` 테이블 RLS 정책: owner 기반 ✅
- `idea_project_chunks` 테이블 RLS 정책: owner 기반 ✅

#### ⚠️ 확인 필요
- **입력 검증**: 이름 길이·금지문자·내용 길이 제한이 API 레벨에서 구현되어 있는지 확인 필요
- **XSS 방지**: 마크다운 렌더링 시 `rehype-sanitize` 사용 여부 확인 필요

---

## 🎯 우선순위별 권장 조치사항

### 🔴 즉시 조치 필요 (높은 우선순위)

1. **부분 유니크 인덱스 추가**
   - GitHub 프로젝트 중복 방지
   - 아이디어 프로젝트 중복 방지
   - 데이터 무결성 보장

2. **입력 검증 강화**
   - 프로젝트 이름 길이 제한
   - 금지 문자 검증
   - 파일 크기 제한 확인

### 🟡 단기 개선 (중간 우선순위)

3. **아이디어 문서 CRUD 완성**
   - 파일 수정 API
   - 파일 삭제 API
   - 재임베딩 엔드포인트

4. **문서 타입 구분 추가**
   - `idea_project_files`에 `doc_type` 컬럼 추가
   - brief/tech/product 구분

5. **기본 문서 템플릿 제공**
   - 프로젝트 생성 시 brief/tech 템플릿 자동 생성

### 🟢 장기 개선 (낮은 우선순위)

6. **아이디어 → GitHub 전환 기능**
   - `/api/projects/:id/attach-github` 엔드포인트
   - 프로젝트 타입 전환 로직

7. **UI/UX 개선**
   - 진행률 탭 안내 메시지 명확화
   - 파일 탭 빈 상태 안내

---

## 📋 체크리스트 (해결책.md 7장 기준)

### ✅ 완료된 항목
- [x] 기존 `projects`의 unique/NOT NULL 제약이 새 제약과 충돌하지 않음 (마이그레이션 완료)
- [x] 대시보드·상세 페이지에서 아이디어 타입의 진행률/파일 탭 호출을 건너뜀 (조건부 렌더링)
- [x] 챗봇에서 아이디어 문서 컨텍스트 사용 (RAG 검색 구현)

### ❌ 미완료 항목
- [ ] 부분 유니크 인덱스 추가 (중복 방지)
- [ ] 입력 검증 강화 (이름 길이, 금지 문자 등)
- [ ] 아이디어 문서 CRUD 완성 (수정/삭제 API)
- [ ] 문서 타입 구분 (`doc_type` 컬럼)
- [ ] 기본 문서 템플릿 자동 생성

---

## 💡 추가 제안사항

### 1. 마이그레이션 안전성 강화

현재 마이그레이션은 잘 작성되어 있으나, 부분 유니크 인덱스 추가 시 기존 데이터 중복 확인이 필요합니다:

```sql
-- 기존 중복 데이터 확인
SELECT owner_id, repo_owner, repo_name, COUNT(*)
FROM vibememory.projects
WHERE project_type = 'github'
GROUP BY owner_id, repo_owner, repo_name
HAVING COUNT(*) > 1;

SELECT owner_id, project_name, COUNT(*)
FROM vibememory.projects
WHERE project_type = 'idea' AND project_name IS NOT NULL
GROUP BY owner_id, project_name
HAVING COUNT(*) > 1;
```

### 2. 문서 타입 자동 감지

파일 업로드 시 파일명이나 내용을 분석하여 `doc_type`을 자동으로 설정하는 기능:

```typescript
// 파일명 패턴으로 doc_type 추론
const detectDocType = (filename: string, content: string): 'brief' | 'tech' | 'product' | null => {
  const lowerFilename = filename.toLowerCase();
  if (lowerFilename.includes('brief') || lowerFilename.includes('개요')) return 'brief';
  if (lowerFilename.includes('tech') || lowerFilename.includes('기술')) return 'tech';
  if (lowerFilename.includes('product') || lowerFilename.includes('제품')) return 'product';
  return null;
};
```

### 3. 챗봇 시스템 프롬프트 개선

현재 챗봇은 일반적인 RAG 검색을 사용하지만, 아이디어 프로젝트의 경우 더 창의적인 프롬프트가 필요할 수 있습니다:

```typescript
// app/api/projects/[id]/chat/route.ts
const systemPrompt = project.project_type === 'idea'
  ? `당신은 사용자의 아이디어를 구체적인 명세서로 만들어주는 프로덕트 매니저입니다.
     - 사용자의 아이디어를 분석하고 구체화합니다.
     - 기술적 실현 가능성을 검토합니다.
     - 사용자 경험을 고려한 기능 제안을 합니다.`
  : `당신은 제공된 '컨텍스트'만을 기반으로 답변하는 AI 비서입니다.
     - 컨텍스트에 답변이 없으면 "제공된 정보에 해당 내용이 없습니다."라고 말하십시오.`;
```

---

## 📊 종합 평가

### 강점
1. ✅ **핵심 기능 완성도 높음**: 스키마, API, UI 모두 잘 구현됨
2. ✅ **RAG 검색 구현**: v1.1 수준으로 이미 완료
3. ✅ **조건부 로직**: `project_type`에 따른 분기 처리가 잘 되어 있음

### 약점
1. ❌ **데이터 무결성**: 부분 유니크 인덱스 누락으로 중복 방지 불가
2. ⚠️ **문서 관리**: CRUD 기능이 불완전 (수정/삭제 없음)
3. ⚠️ **사용성**: 기본 템플릿이나 문서 타입 구분이 없음

### 결론

`해결책.md`의 제안사항은 대부분 타당하며, 현재 구현 상태는 **v1 완료, v1.1 부분 완료** 수준입니다. 

**가장 시급한 개선 사항은 부분 유니크 인덱스 추가**입니다. 이를 통해 데이터 무결성을 DB 레벨에서 보장할 수 있습니다.

나머지 개선 사항들은 단계적으로 진행하면 됩니다.

---

**검토자**: AI Assistant  
**검토 일시**: 2025-01-XX  
**다음 검토 예정**: 부분 유니크 인덱스 추가 후


