# 해결책.md 프로젝트 만들기 기능 구현 플랜 검토 리포트

**작성일**: 2025-01-XX  
**검토 대상**: `해결책.md` - 프로젝트 만들기 및 아이디어 인큐베이팅 기능 구현 플랜

---

## 📋 검토 개요

`해결책.md`에 제시된 플랜은 GitHub 리포지토리 없이 '아이디어' 타입 프로젝트를 생성하고, 파일 업로드 및 AI 챗봇을 통해 명세서로 발전시키는 기능을 구현하는 것을 목표로 합니다.

---

## ✅ 현재 프로젝트 구조 분석

### 1. 데이터베이스 스키마 현황

**현재 상태**:
- `projects` 테이블에 `project_type` ENUM이 **아직 구현되지 않음**
- GitHub 관련 필드 (`repo_owner`, `repo_name`, `repo_url`)는 현재 `NOT NULL` 제약 조건이 있음
- `repo_file_chunks` 테이블이 이미 존재하며 RAG 검색 인프라가 구축되어 있음
- `search_project_chunks_rrf` RPC 함수가 프로젝트별 검색을 지원

**참고 문서**: `프로젝트_만들기_기능_플랜.md`에 상세한 마이그레이션 계획이 이미 수립되어 있음

### 2. 백엔드 API 현황

**현재 상태**:
- `POST /api/projects/create` API가 **아직 구현되지 않음**
- `GET /api/projects`는 GitHub 프로젝트만 반환 (수정 필요)
- `GET /api/projects/[id]`는 GitHub 프로젝트 기준으로 동작 (수정 필요)
- 챗봇 API (`POST /api/projects/[id]/chat`)는 이미 프로젝트별 RAG 검색을 지원

### 3. 프론트엔드 UI 현황

**현재 상태**:
- `/dashboard/create` 페이지가 **아직 구현되지 않음**
- 프로젝트 상세 페이지 (`/dashboard/projects/[id]`)에 탭 구조가 이미 존재:
  - `overview`: 프로젝트 개요
  - `idea`: 아이디어 탭 (현재는 GitHub 프로젝트용)
  - `progress`: 진행 상황
  - `chat`: 챗봇
- 챗봇 UI (`ChatInterface`)가 이미 구현되어 있음

---

## 🔍 플랜 검토 및 수정 제안

### ✅ 1단계: 기술 기반 구축

#### 1.1. 데이터베이스 스키마 변경

**플랜 내용**:
- `project_type` ENUM 추가 (`'github' | 'idea'`)
- GitHub 관련 필드 nullable 변경
- `idea_project_files`, `idea_project_chunks` 테이블 생성

**검토 결과**: ✅ **적절함**

**수정 제안**:
1. **`idea_project_chunks` 테이블 설계 개선**:
   - 현재 플랜: `content TEXT` (NOT NULL 없음)
   - 제안: `content TEXT NOT NULL` 추가
   - 현재 플랜: `token_count INT` (nullable)
   - 제안: `token_count INT` 유지 (선택적)
   - 현재 플랜: `embedding VECTOR(1536)` (nullable)
   - 제안: `embedding VECTOR(1536)` 유지 (임베딩 전까지는 NULL)

2. **인덱스 추가**:
   ```sql
   -- idea_project_chunks 인덱스
   CREATE INDEX idx_idea_project_chunks_project_id 
     ON vibememory.idea_project_chunks(project_id);
   CREATE INDEX idx_idea_project_chunks_file_id 
     ON vibememory.idea_project_chunks(file_id);
   CREATE INDEX idx_idea_project_chunks_embedding 
     ON vibememory.idea_project_chunks 
     USING hnsw(embedding vector_cosine_ops) 
     WITH (m = 16, ef_construction = 64)
     WHERE embedding IS NOT NULL;
   ```

3. **FTS (Full-Text Search) 지원**:
   - `idea_project_chunks`에 `fts TSVECTOR` 컬럼 추가하여 기존 RAG 검색과 일관성 유지
   ```sql
   ALTER TABLE vibememory.idea_project_chunks
   ADD COLUMN fts TSVECTOR 
   GENERATED ALWAYS AS (to_tsvector('english', content)) STORED;
   
   CREATE INDEX idx_idea_project_chunks_fts 
     ON vibememory.idea_project_chunks USING GIN(fts);
   ```

4. **RLS 정책 추가**:
   ```sql
   ALTER TABLE vibememory.idea_project_files ENABLE ROW LEVEL SECURITY;
   CREATE POLICY ipf_select ON vibememory.idea_project_files
     FOR SELECT USING (
       EXISTS (
         SELECT 1 FROM vibememory.projects p 
         WHERE p.id = project_id AND p.owner_id = auth.uid()
       )
     );
   -- INSERT, UPDATE, DELETE 정책도 동일하게 추가
   
   ALTER TABLE vibememory.idea_project_chunks ENABLE ROW LEVEL SECURITY;
   CREATE POLICY ipc_select ON vibememory.idea_project_chunks
     FOR SELECT USING (
       EXISTS (
         SELECT 1 FROM vibememory.projects p 
         WHERE p.id = project_id AND p.owner_id = auth.uid()
       )
     );
   -- INSERT, UPDATE, DELETE 정책도 동일하게 추가
   ```

#### 1.2. 백엔드 API 구현

**플랜 내용**:
- `POST /api/projects/create` 생성
- `GET /api/projects` 수정
- `GET /api/projects/[id]` 수정

**검토 결과**: ✅ **적절함**

**수정 제안**:
1. **`POST /api/projects/create` 구현 시 주의사항**:
   - `project_type`이 `'idea'`인 경우 `ingestion_runs` 생성하지 않음 (✅ 플랜에 명시됨)
   - `scan_progress` 생성하지 않음 (✅ 플랜에 명시됨)
   - **추가**: `project_analysis` 레코드도 생성하지 않음 (아이디어 프로젝트는 AI 분석 불필요)

2. **`GET /api/projects/[id]` 수정 시**:
   - `project_type`에 따라 반환 데이터 구분
   - 아이디어 프로젝트인 경우 `progress`, `repo_files` 등 GitHub 관련 데이터 제외

#### 1.3. 프론트엔드 UI (기반)

**플랜 내용**:
- `/dashboard/create` 페이지 생성
- `/dashboard` 페이지에 '프로젝트 만들기' 버튼 추가

**검토 결과**: ✅ **적절함**

---

### ✅ 2단계: 아이디어 인큐베이팅 기능 구현

#### 2.1. 프론트엔드: "아이디어 노트" 탭

**플랜 내용**:
- `project_type === 'idea'`일 경우 조건부 렌더링
- GitHub 기반 탭 숨김, "아이디어 노트" 탭 활성화

**검토 결과**: ⚠️ **수정 필요**

**현재 프로젝트 상세 페이지 구조**:
- 이미 `TabType = 'overview' | 'idea' | 'progress' | 'chat'` 타입이 정의되어 있음
- `activeTab` 상태로 탭 전환 관리

**수정 제안**:
1. **조건부 탭 렌더링 로직**:
   ```typescript
   // project_type에 따라 탭 목록 동적 생성
   const availableTabs = project?.project_type === 'idea' 
     ? ['overview', 'idea', 'chat']  // progress 제외
     : ['overview', 'idea', 'progress', 'chat'];
   ```

2. **"아이디어 노트" 탭 내용**:
   - 현재 `idea` 탭이 이미 존재하지만 내용이 비어있을 수 있음
   - 플랜의 "아이디어 캔버스"와 "디벨롭 챗봇"을 이 탭에 구현

#### 2.2. "아이디어 노트" 탭 상세 기능

##### 1. 아이디어 캔버스 (파일 업로드)

**플랜 내용**:
- 파일 업로드 API (`POST /api/projects/[id]/idea/upload`)
- `idea_project_files`에 메타데이터 저장
- 비동기 임베딩 (청킹 → `idea_project_chunks` 저장)

**검토 결과**: ✅ **적절함**

**수정 제안**:
1. **파일 업로드 API 경로**:
   - 플랜: `POST /api/projects/[id]/idea/upload`
   - 제안: `POST /api/projects/[id]/idea/files` (RESTful 규칙 준수)

2. **임베딩 로직 재사용**:
   - 기존 `lib/rag.ts`의 `chunkText()` 함수 재사용 가능
   - 기존 `lib/rag.ts`의 `embedText()` 함수 재사용 가능
   - 임베딩 작업은 비동기로 처리 (업로드 즉시 반환, 백그라운드 처리)

3. **Storage 버킷**:
   - 기존 `project-screenshots` 버킷과 유사하게 `idea-project-files` 버킷 생성
   - 또는 기존 Storage 구조 활용 (경로: `idea-files/{project_id}/{file_id}/{filename}`)

##### 2. 디벨롭 챗봇 (AI 어시스턴트)

**플랜 내용**:
- 아이디어를 명세서로 발전시키는 AI 챗봇
- RAG 컨텍스트: `idea_project_chunks` 검색 + 대화 기록
- AI 모델: `gpt-5-mini`

**검토 결과**: ⚠️ **수정 필요**

**현재 챗봇 구조**:
- `POST /api/projects/[id]/chat`는 `search_project_chunks_rrf` RPC를 사용
- 이 RPC는 `repo_file_chunks`만 검색 (GitHub 프로젝트 전용)

**수정 제안**:
1. **새로운 RPC 함수 생성**:
   ```sql
   CREATE OR REPLACE FUNCTION vibememory.search_idea_project_chunks_rrf(
     p_project_id uuid,
     p_query_text text,
     p_query_vec float8[],
     p_limit int DEFAULT 8
   )
   RETURNS TABLE (
     chunk_id uuid,
     file_path text,
     content text,
     fts_rank real,
     vector_similarity real,
     rrf_score real
   )
   LANGUAGE plpgsql SECURITY DEFINER AS $$
   BEGIN
     RETURN QUERY
     WITH base AS (
       SELECT 
         c.id AS chunk_id, 
         f.file_name AS file_path, 
         c.content, 
         c.embedding, 
         c.fts
       FROM vibememory.idea_project_chunks c
       JOIN vibememory.idea_project_files f ON f.id = c.file_id
       WHERE f.project_id = p_project_id
     ),
     -- FTS 및 벡터 검색 로직 (기존 search_project_chunks_rrf와 동일)
     ...
   END $$;
   ```

2. **챗봇 API 수정**:
   ```typescript
   // app/api/projects/[id]/chat/route.ts
   // project_type 확인
   const { data: project } = await supabaseAdmin
     .from('projects')
     .select('project_type')
     .eq('id', projectId)
     .single();
   
   // project_type에 따라 다른 RPC 함수 호출
   if (project?.project_type === 'idea') {
     const { data: searchResults } = await supabaseAdmin.rpc(
       'search_idea_project_chunks_rrf',
       { ... }
     );
   } else {
     const { data: searchResults } = await supabaseAdmin.rpc(
       'search_project_chunks_rrf',
       { ... }
     );
   }
   ```

3. **시스템 프롬프트**:
   - 플랜의 시스템 프롬프트 적용: "당신은 사용자의 아이디어를 구체적인 명세서로 만들어주는 프로덕트 매니저입니다..."
   - `project_type === 'idea'`일 때만 이 프롬프트 사용

##### 3. 명세서 생성 (AI 합성)

**플랜 내용**:
- `POST /api/projects/[id]/idea/synthesize` API
- 컨텍스트: `idea_project_files` 텍스트 + 챗봇 대화 기록
- AI 모델: `gpt-5-mini`

**검토 결과**: ✅ **적절함**

**수정 제안**:
1. **명세서 저장 위치**:
   - 플랜: `specification.md` 파일로 생성
   - 제안: `project_analysis.specification` 컬럼에 저장 (또는 별도 `project_specifications` 테이블)
   - 또는 `idea_project_files`에 `specification.md` 파일로 저장

2. **컨텍스트 수집**:
   - `idea_project_files`의 모든 파일 내용 읽기
   - `chat_sessions` 및 `chat_messages`에서 대화 기록 조회
   - 최대 토큰 수 제한 (예: 8000 토큰)

##### 4. Cursor로 내보내기 (Handoff)

**플랜 내용**:
- 생성된 `specification.md`를 기반으로 Cursor용 프롬프트 생성
- 모달 창에 표시, 복사 가능

**검토 결과**: ✅ **적절함**

**수정 제안**:
1. **프롬프트 템플릿**:
   ```typescript
   const cursorPrompt = `다음 명세서를 기반으로 프로젝트를 생성해주세요:

   ${specificationContent}

   요구사항:
   - 위 명세서의 모든 기능을 구현해주세요
   - 코드 스타일은 명확하고 유지보수 가능하게 작성해주세요
   - 필요한 의존성과 설정 파일을 포함해주세요
   `;
   ```

2. **UI 구현**:
   - 프로젝트 상세 페이지 "아이디어 노트" 탭에 "Cursor로 내보내기" 버튼 추가
   - 클릭 시 모달 창 열림
   - 프롬프트 텍스트 표시 및 복사 버튼 제공

---

## 🚨 주요 이슈 및 해결 방안

### 이슈 1: RAG 검색 로직 중복

**문제**: 
- GitHub 프로젝트용 `search_project_chunks_rrf`와 아이디어 프로젝트용 `search_idea_project_chunks_rrf`가 거의 동일한 로직

**해결 방안**:
- 옵션 A: 두 개의 RPC 함수를 별도로 유지 (명확성)
- 옵션 B: 통합 RPC 함수 생성 (코드 중복 제거)
  ```sql
   CREATE OR REPLACE FUNCTION vibememory.search_project_chunks_rrf_unified(
     p_project_id uuid,
     p_query_text text,
     p_query_vec float8[],
     p_limit int DEFAULT 8,
     p_project_type text DEFAULT 'github'  -- 'github' | 'idea'
   )
   ```

**권장**: 옵션 A (명확성과 유지보수성)

### 이슈 2: 챗봇 세션 타이틀 생성

**문제**:
- 아이디어 프로젝트는 `repo_name`이 없어서 세션 타이틀 생성 로직 수정 필요

**해결 방안**:
```typescript
// app/api/projects/[id]/chat/session/route.ts
const { data: project } = await supabaseAdmin
  .from('projects')
  .select('project_name, repo_name, project_type')
  .eq('id', projectId)
  .single();

const sessionTitle = title || (
  project?.project_type === 'idea'
    ? `${project.project_name} - ${new Date().toLocaleDateString('ko-KR')}`
    : `${project.repo_name} - ${new Date().toLocaleDateString('ko-KR')}`
);
```

### 이슈 3: 프로젝트 상세 페이지 조건부 렌더링

**문제**:
- 현재 프로젝트 상세 페이지가 GitHub 프로젝트 기준으로 구현됨
- 아이디어 프로젝트인 경우 일부 섹션 숨김 필요

**해결 방안**:
- `project.project_type` 확인 후 조건부 렌더링
- 예: `progress` 탭, `FileListPane` 컴포넌트 등

---

## 📝 구현 우선순위 및 단계

### Phase 1: 기술 기반 구축 (필수)
1. ✅ 데이터베이스 마이그레이션
   - `project_type` ENUM 추가
   - GitHub 필드 nullable 변경
   - `idea_project_files`, `idea_project_chunks` 테이블 생성
   - 인덱스 및 RLS 정책 추가
2. ✅ 백엔드 API 구현
   - `POST /api/projects/create`
   - `GET /api/projects` 수정
   - `GET /api/projects/[id]` 수정
3. ✅ 프론트엔드 기반 UI
   - `/dashboard/create` 페이지
   - 대시보드에 만들기 버튼 추가

### Phase 2: 아이디어 노트 탭 구현 (필수)
1. ✅ 파일 업로드 기능
   - `POST /api/projects/[id]/idea/files` API
   - 비동기 임베딩 로직
   - 파일 목록 UI
2. ✅ 디벨롭 챗봇
   - `search_idea_project_chunks_rrf` RPC 함수 생성
   - 챗봇 API 수정 (project_type 분기)
   - 시스템 프롬프트 적용

### Phase 3: 명세서 생성 및 핸드오프 (권장)
1. ✅ 명세서 생성 API
   - `POST /api/projects/[id]/idea/synthesize`
   - 컨텍스트 수집 및 AI 합성
2. ✅ Cursor 내보내기
   - 프롬프트 템플릿 생성
   - 모달 UI 구현

---

## ✅ 최종 검토 결과

### 장점
1. ✅ 기존 프로젝트 구조와 잘 통합됨
2. ✅ RAG 검색 인프라 재사용 가능
3. ✅ 챗봇 UI 재사용 가능
4. ✅ 단계별 구현이 명확함

### 개선 사항
1. ⚠️ `idea_project_chunks` 테이블에 FTS 지원 추가 필요
2. ⚠️ RLS 정책 명시 필요
3. ⚠️ 챗봇 API의 project_type 분기 로직 추가 필요
4. ⚠️ 프로젝트 상세 페이지 조건부 렌더링 로직 추가 필요

### 결론
**플랜은 전반적으로 적절하며, 위 수정 사항을 반영하면 구현 가능합니다.**

---

## 📚 참고 문서
- `프로젝트_만들기_기능_플랜.md`: 데이터베이스 스키마 변경 상세 계획
- `해결책.md`: 원본 플랜 문서
- `plan.md`: 프로젝트 전체 아키텍처
- `memory_bank/activeContext.md`: 현재 작업 상황

