# í•´ê²°ì±….md ê²€í†  ë¦¬í¬íŠ¸

> **ê²€í† ì¼**: 2025-01-16  
> **ê²€í†  ëŒ€ìƒ**: `í•´ê²°ì±….md` - ì•„ì´ë””ì–´ íŒŒì¼ ì—…ë¡œë“œ 400 ì—ëŸ¬ í•´ê²° ë°©ì•ˆ  
> **í˜„ì¬ ì½”ë“œë² ì´ìŠ¤**: VibeMemory (Next.js 16.0.3)

---

## âœ… ì „ì²´ í‰ê°€

**í‰ê°€**: â­â­â­â­â­ (5/5)

í•´ê²°ì±…ì€ **ë§¤ìš° ì˜ ì‘ì„±**ë˜ì–´ ìˆìœ¼ë©°, ë¬¸ì œì˜ í•µì‹¬ ì›ì¸(MIME íƒ€ì… ë¶ˆì¼ì¹˜)ì„ ì •í™•íˆ íŒŒì•…í•˜ê³  ìˆìŠµë‹ˆë‹¤. ì œì•ˆëœ í•´ê²° ë°©ì•ˆë“¤ì´ ì‹¤ìš©ì ì´ê³  ì¦‰ì‹œ ì ìš© ê°€ëŠ¥í•©ë‹ˆë‹¤.

---

## ğŸ“‹ ì„¸ë¶€ ê²€í† 

### 1. MIME íƒ€ì… ì •ê·œí™” í•¨ìˆ˜ âœ… **í•µì‹¬ í•´ê²°ì±…**

**ì œì•ˆ ë‚´ìš©**:
```typescript
function normalizeMime(filename: string, fallback?: string) {
  const ext = path.extname(filename).toLowerCase()
  if (ext === '.md') return 'text/markdown; charset=utf-8'
  if (ext === '.txt') return 'text/plain; charset=utf-8'
  return fallback || 'text/plain; charset=utf-8'
}
```

**í˜„ì¬ ì½”ë“œ ìƒíƒœ**:
- âŒ **ì—†ìŒ** - ì´ í•¨ìˆ˜ê°€ í˜„ì¬ ì½”ë“œì— ì—†ìŒ
- í˜„ì¬ëŠ” `file.type || 'text/plain'`ë¡œ ì²˜ë¦¬í•˜ì—¬ ë¸Œë¼ìš°ì €ê°€ ê°ì§€í•œ MIME íƒ€ì…ì„ ê·¸ëŒ€ë¡œ ì‚¬ìš©

**ê²€í†  ì˜ê²¬**:
- âœ… **ì¦‰ì‹œ ì ìš© í•„ìš”** - ì´ê²Œ ê°€ì¥ ì¤‘ìš”í•œ í•´ê²°ì±…
- âœ… `charset=utf-8` ì¶”ê°€ëŠ” ì¢‹ì€ ê´€í–‰
- âš ï¸ **ì£¼ì˜**: `path.extname`ì€ Node.js ë‚´ì¥ ëª¨ë“ˆì´ë¯€ë¡œ `import path from 'node:path'` í•„ìš”

**ì ìš© ì‹œ ìˆ˜ì • ì‚¬í•­**:
```typescript
// í˜„ì¬ ì½”ë“œ (route.ts:194)
const uploadedPath = await uploadIdeaFile(projectId, fileId, file.name, fileBuffer, file.type);

// ìˆ˜ì • í›„
const normalizedMimeType = normalizeMime(file.name, file.type);
const uploadedPath = await uploadIdeaFile(projectId, fileId, file.name, fileBuffer, normalizedMimeType);
```

---

### 2. ë²„í‚· ìƒì„± ë¡œì§ ê°œì„  âœ… **ì¤‘ìš”**

**ì œì•ˆ ë‚´ìš©**:
```typescript
// ì´ë¯¸ ì¡´ì¬(409)ë„ ì„±ê³µ ì·¨ê¸‰
if (!createErr || createErr?.message?.includes('already exists') || (createErr as any)?.statusCode === 409) {
  return true
}
```

**í˜„ì¬ ì½”ë“œ ìƒíƒœ** (`lib/storage.ts:455-460`):
```typescript
if (createError) {
  console.error(`[STORAGE] Error creating bucket:`, createError);
  // ... ì—ëŸ¬ ì²˜ë¦¬ í›„ false ë°˜í™˜
  return false;
}
```

**ê²€í†  ì˜ê²¬**:
- âœ… **ì ìš© í•„ìš”** - "already exists" ì—ëŸ¬ë¥¼ ì„±ê³µìœ¼ë¡œ ì²˜ë¦¬í•˜ë©´ ë™ì‹œì„± ë¬¸ì œ í•´ê²°
- âœ… ìŠ¤í¬ë¦°ìƒ· ë²„í‚· ë¡œì§(`lib/storage.ts:245`)ì—ë„ ë™ì¼í•œ íŒ¨í„´ì´ ìˆìŒ - ì¼ê´€ì„± ìœ ì§€

**ì ìš© ìœ„ì¹˜**: `lib/storage.ts:429-475` (ensureIdeaFilesBucketExists í•¨ìˆ˜)

---

### 3. ë²„í‚· allowed_mime_types í™•ì¥ âœ… **ê¶Œì¥**

**ì œì•ˆ ë‚´ìš©**:
```typescript
allowedMimeTypes: ['text/markdown', 'text/plain', 'text/x-markdown', 'application/x-markdown']
```

**í˜„ì¬ ì½”ë“œ ìƒíƒœ** (`lib/storage.ts:452`):
```typescript
allowedMimeTypes: ['text/markdown', 'text/plain']
```

**ê²€í†  ì˜ê²¬**:
- âœ… **ì ìš© ê¶Œì¥** - ë‹¤ì–‘í•œ í™˜ê²½ì—ì„œ `.md` íŒŒì¼ì˜ MIME íƒ€ì…ì´ ë‹¤ë¥¼ ìˆ˜ ìˆìŒ
- âš ï¸ **ì£¼ì˜**: ê¸°ì¡´ ë²„í‚·ì€ Dashboardì—ì„œ ìˆ˜ë™ìœ¼ë¡œ ì—…ë°ì´íŠ¸ í•„ìš”

**ì ìš© ë°©ë²•**:
1. ì½”ë“œ ìˆ˜ì •: `lib/storage.ts:452` ì—…ë°ì´íŠ¸
2. ê¸°ì¡´ ë²„í‚· ì—…ë°ì´íŠ¸: Supabase Dashboard ë˜ëŠ” Storage API `updateBucket` ì‚¬ìš©

---

### 4. contentType ëª…ì‹œì  ì„¤ì • âœ… **ì ìš© í•„ìš”**

**ì œì•ˆ ë‚´ìš©**:
```typescript
const { error } = await supabaseAdmin.storage
  .from(IDEA_FILES_BUCKET_NAME)
  .upload(storagePath, buffer, {
    contentType,           // â† ë°˜ë“œì‹œ ëª…ì‹œ
    upsert: true,
    cacheControl: '3600',
  })
```

**í˜„ì¬ ì½”ë“œ ìƒíƒœ** (`lib/storage.ts:528-531`):
```typescript
.upload(storagePath, fileBuffer, {
  contentType: mimeType || 'text/plain',
  upsert: true,
})
```

**ê²€í†  ì˜ê²¬**:
- âœ… **ì´ë¯¸ ì ìš©ë¨** - contentTypeì€ ëª…ì‹œë˜ì–´ ìˆìŒ
- âœ… `cacheControl` ì¶”ê°€ëŠ” ì„±ëŠ¥ ê°œì„ ì— ë„ì›€
- âš ï¸ **ê°œì„  í•„ìš”**: `mimeType || 'text/plain'` ëŒ€ì‹  ì •ê·œí™”ëœ MIME íƒ€ì… ì‚¬ìš©

---

### 5. ì½”ë“œ êµ¬ì¡° ì°¨ì´ì  âš ï¸ **ì£¼ì˜ í•„ìš”**

#### 5.1 params íƒ€ì… ì°¨ì´

**ì œì•ˆ ì½”ë“œ**:
```typescript
export async function POST(req: NextRequest, { params }: { params: { id: string } })
```

**í˜„ì¬ ì½”ë“œ**:
```typescript
export async function POST(
  request: NextRequest,
  { params }: { params: Promise<{ id: string }> }
)
```

**ê²€í†  ì˜ê²¬**:
- âš ï¸ **Next.js ë²„ì „ ì°¨ì´** - Next.js 15+ì—ì„œëŠ” `params`ê°€ `Promise`ë¡œ ë³€ê²½ë¨
- âœ… **í˜„ì¬ ì½”ë“œê°€ ì˜¬ë°”ë¦„** - Next.js 16.0.3ì—ì„œëŠ” `await params` í•„ìš”
- âš ï¸ **í•´ê²°ì±… ì½”ë“œ ìˆ˜ì • í•„ìš”**: `const projectId = params.id` â†’ `const { id: projectId } = await params`

#### 5.2 Import ê²½ë¡œ ì°¨ì´

**ì œì•ˆ ì½”ë“œ**:
```typescript
import { supabaseAdmin } from '@/lib/supabaseAdmin'
import { IDEA_FILES_BUCKET_NAME } from '@/lib/constants'
```

**í˜„ì¬ ì½”ë“œ**:
```typescript
import { supabaseAdmin } from '@/lib/supabase'
// IDEA_FILES_BUCKET_NAMEì€ lib/storage.tsì— ì •ì˜ë¨
```

**ê²€í†  ì˜ê²¬**:
- âœ… **í˜„ì¬ êµ¬ì¡° ìœ ì§€ ê¶Œì¥** - `@/lib/supabase`ê°€ ì˜¬ë°”ë¥¸ ê²½ë¡œ
- âœ… `IDEA_FILES_BUCKET_NAME`ì€ `lib/storage.ts`ì— ì´ë¯¸ ì •ì˜ë˜ì–´ ìˆìŒ (export í•„ìš” ì‹œ ì¶”ê°€)

#### 5.3 runtime ì„¤ì •

**ì œì•ˆ ì½”ë“œ**:
```typescript
export const runtime = 'nodejs' // â† Edgeë³´ë‹¤ Node ê¶Œì¥
```

**í˜„ì¬ ì½”ë“œ**:
- âŒ **ì—†ìŒ** - ê¸°ë³¸ê°’ ì‚¬ìš©

**ê²€í†  ì˜ê²¬**:
- âœ… **ì¶”ê°€ ê¶Œì¥** - Buffer ì²˜ë¦¬ ì•ˆì •ì„±ì„ ìœ„í•´ Node.js ëŸ°íƒ€ì„ ëª…ì‹œ
- âš ï¸ **ì£¼ì˜**: Next.js 16ì—ì„œëŠ” ê¸°ë³¸ê°’ì´ ì´ë¯¸ Node.jsì¼ ìˆ˜ ìˆìœ¼ë‚˜, ëª…ì‹œí•˜ëŠ” ê²ƒì´ ì¢‹ìŒ

---

### 6. ì„œëª… ì—…ë¡œë“œ URL ë°©ì‹ (ë°©ì•ˆ 2) ğŸ’¡ **ì¥ê¸° ê°œì„ ì•ˆ**

**ì œì•ˆ ë‚´ìš©**: ì„œë²„ì—ì„œ íŒŒì¼ ë°”ë””ë¥¼ ì²˜ë¦¬í•˜ì§€ ì•Šê³ , ì„œëª…ëœ URLì„ ë°œê¸‰í•˜ì—¬ í´ë¼ì´ì–¸íŠ¸ê°€ ì§ì ‘ ì—…ë¡œë“œ

**ê²€í†  ì˜ê²¬**:
- âœ… **ìš°ìˆ˜í•œ ì•„ì´ë””ì–´** - Vercel ëŸ°íƒ€ì„ ì œí•œ íšŒí”¼, MIME íƒ€ì… ë¬¸ì œ í•´ì†Œ
- âš ï¸ **êµ¬í˜„ ë³µì¡ë„**: í´ë¼ì´ì–¸íŠ¸ ì½”ë“œ ìˆ˜ì • í•„ìš”
- ğŸ’¡ **ìš°ì„ ìˆœìœ„**: ë°©ì•ˆ 1 ì ìš© í›„ì—ë„ ë¬¸ì œê°€ ì§€ì†ë˜ë©´ ê³ ë ¤

**í˜„ì¬ ì ìš© í•„ìš”ì„±**: âš ï¸ **ë‚®ìŒ** (ë°©ì•ˆ 1ë¡œ í•´ê²° ê°€ëŠ¥í•  ê²ƒìœ¼ë¡œ ì˜ˆìƒ)

---

## ğŸ”§ ì¦‰ì‹œ ì ìš© ê°€ëŠ¥í•œ ìˆ˜ì • ì‚¬í•­

### ìš°ì„ ìˆœìœ„ 1: MIME íƒ€ì… ì •ê·œí™” í•¨ìˆ˜ ì¶”ê°€

**íŒŒì¼**: `app/api/projects/[id]/idea/files/route.ts`

```typescript
import path from 'node:path';

function normalizeMimeType(filename: string, fallback?: string): string {
  const ext = path.extname(filename).toLowerCase();
  if (ext === '.md') return 'text/markdown; charset=utf-8';
  if (ext === '.txt') return 'text/plain; charset=utf-8';
  return fallback || 'text/plain; charset=utf-8';
}

// POST í•¨ìˆ˜ ë‚´ë¶€ì—ì„œ ì‚¬ìš©
const normalizedMimeType = normalizeMimeType(file.name, file.type);
const uploadedPath = await uploadIdeaFile(projectId, fileId, file.name, fileBuffer, normalizedMimeType);
```

### ìš°ì„ ìˆœìœ„ 2: ë²„í‚· ìƒì„± ë¡œì§ ê°œì„ 

**íŒŒì¼**: `lib/storage.ts` (ensureIdeaFilesBucketExists í•¨ìˆ˜)

```typescript
if (createError) {
  // ì´ë¯¸ ì¡´ì¬í•˜ëŠ” ê²½ìš° ì„±ê³µìœ¼ë¡œ ì²˜ë¦¬
  if (createError.message?.includes('already exists') || (createError as any)?.statusCode === 409) {
    console.log(`[STORAGE] Bucket already exists, marking as exists`);
    ideaFilesBucketExists = true;
    ideaFilesBucketChecked = true;
    return true;
  }
  
  console.error(`[STORAGE] Error creating bucket:`, createError);
  // ... ê¸°ì¡´ ì—ëŸ¬ ì²˜ë¦¬
}
```

### ìš°ì„ ìˆœìœ„ 3: ë²„í‚· allowed_mime_types í™•ì¥

**íŒŒì¼**: `lib/storage.ts` (ë²„í‚· ìƒì„± ì‹œ)

```typescript
allowedMimeTypes: ['text/markdown', 'text/plain', 'text/x-markdown', 'application/x-markdown']
```

**ê¸°ì¡´ ë²„í‚· ì—…ë°ì´íŠ¸**: Supabase Dashboardì—ì„œ ìˆ˜ë™ ì—…ë°ì´íŠ¸ ë˜ëŠ” Storage API ì‚¬ìš©

### ìš°ì„ ìˆœìœ„ 4: uploadIdeaFile í•¨ìˆ˜ì—ì„œ ì •ê·œí™”ëœ MIME íƒ€ì… ì‚¬ìš©

**íŒŒì¼**: `lib/storage.ts` (uploadIdeaFile í•¨ìˆ˜)

```typescript
// í˜„ì¬: contentType: mimeType || 'text/plain'
// ìˆ˜ì •: ì´ë¯¸ ì •ê·œí™”ëœ MIME íƒ€ì…ì´ ì „ë‹¬ë˜ë¯€ë¡œ ê·¸ëŒ€ë¡œ ì‚¬ìš©
.upload(storagePath, fileBuffer, {
  contentType: mimeType || 'text/plain; charset=utf-8',
  upsert: true,
  cacheControl: '3600', // ì¶”ê°€ ê¶Œì¥
})
```

---

## ğŸ“Š ì ìš© ìš°ì„ ìˆœìœ„

| ìš°ì„ ìˆœìœ„ | í•­ëª© | ë‚œì´ë„ | ì˜ˆìƒ íš¨ê³¼ | ì ìš© ì‹œê°„ |
|---------|------|--------|----------|----------|
| ğŸ”´ **1** | MIME íƒ€ì… ì •ê·œí™” í•¨ìˆ˜ | ë‚®ìŒ | ë§¤ìš° ë†’ìŒ | 10ë¶„ |
| ğŸŸ  **2** | ë²„í‚· ìƒì„± ë¡œì§ ê°œì„  | ë‚®ìŒ | ì¤‘ê°„ | 5ë¶„ |
| ğŸŸ¡ **3** | allowed_mime_types í™•ì¥ | ë‚®ìŒ | ë†’ìŒ | 5ë¶„ |
| ğŸŸ¢ **4** | cacheControl ì¶”ê°€ | ë§¤ìš° ë‚®ìŒ | ë‚®ìŒ | 1ë¶„ |
| ğŸ’¡ **5** | ì„œëª… ì—…ë¡œë“œ URL ë°©ì‹ | ë†’ìŒ | ë§¤ìš° ë†’ìŒ | 2-3ì‹œê°„ |

---

## âœ… ê²€í†  ê²°ë¡ 

### ê°•ì 
1. âœ… **ë¬¸ì œ ì›ì¸ ì •í™•íˆ íŒŒì•…** - MIME íƒ€ì… ë¶ˆì¼ì¹˜ê°€ í•µì‹¬
2. âœ… **ì‹¤ìš©ì ì¸ í•´ê²°ì±…** - ì¦‰ì‹œ ì ìš© ê°€ëŠ¥í•œ ì½”ë“œ ì œê³µ
3. âœ… **ê³¼ê±° ì‚¬ë¡€ ë°˜ì˜** - ìŠ¤í¬ë¦°ìƒ· ë²„í‚· ì´ìŠˆ ê²½í—˜ ë°˜ì˜
4. âœ… **ë‹¨ê³„ë³„ ì ‘ê·¼** - ìµœì†Œ ìˆ˜ì • â†’ ê¶Œì¥ ê°œì„  â†’ ì¥ê¸° ê°œì„ 

### ê°œì„  ì œì•ˆ
1. âš ï¸ **Next.js 16 í˜¸í™˜ì„±** - `params`ê°€ `Promise`ì¸ ì  ë°˜ì˜ í•„ìš”
2. âš ï¸ **Import ê²½ë¡œ** - ì‹¤ì œ í”„ë¡œì íŠ¸ êµ¬ì¡°ì— ë§ê²Œ ìˆ˜ì • í•„ìš”
3. âœ… **í˜„ì¬ ì½”ë“œ êµ¬ì¡° ìœ ì§€** - ê¸°ì¡´ íŒ¨í„´ê³¼ ì¼ê´€ì„± ìœ ì§€

### ìµœì¢… ê¶Œì¥ ì‚¬í•­
1. **ì¦‰ì‹œ ì ìš©**: ìš°ì„ ìˆœìœ„ 1-3 í•­ëª© ì ìš©
2. **í…ŒìŠ¤íŠ¸**: ì ìš© í›„ íŒŒì¼ ì—…ë¡œë“œ í…ŒìŠ¤íŠ¸
3. **ëª¨ë‹ˆí„°ë§**: ì„œë²„ ë¡œê·¸ì—ì„œ HTTP 400 ì—ëŸ¬ ì‚¬ë¼ì¡ŒëŠ”ì§€ í™•ì¸
4. **ì¥ê¸° ê°œì„ **: ë¬¸ì œê°€ ì§€ì†ë˜ë©´ ì„œëª… ì—…ë¡œë“œ URL ë°©ì‹ ê³ ë ¤

---

## ğŸ”— ê´€ë ¨ íŒŒì¼

- `app/api/projects/[id]/idea/files/route.ts` - API ë¼ìš°íŠ¸
- `lib/storage.ts` - Storage ê´€ë ¨ í•¨ìˆ˜
- `components/IdeaNoteTab.tsx` - í´ë¼ì´ì–¸íŠ¸ ì»´í¬ë„ŒíŠ¸
- `í•´ê²°ì±….md` - ì›ë³¸ í•´ê²°ì±… ë¬¸ì„œ

---

**ê²€í† ì**: AI Assistant  
**ê²€í† ì¼**: 2025-01-16  
**ìƒíƒœ**: âœ… **ê²€í†  ì™„ë£Œ - ì¦‰ì‹œ ì ìš© ê¶Œì¥**
