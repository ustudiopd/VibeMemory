# 해결책.md 검토 리포트

## 검토 개요
`해결책.md`에 명시된 챗봇 구현 명세를 현재 프로젝트 상태와 비교하여, 구현 현황과 차이점을 분석합니다.

---

## 1. 데이터베이스 설계 (2장)

### 명세 요구사항
- `vibememory.chat_sessions` 테이블
- `vibememory.chat_messages` 테이블
- RLS 정책 적용
- 인덱스 생성

### 현재 상태
❌ **미구현**
- `chat_sessions` 테이블 없음
- `chat_messages` 테이블 없음
- 관련 마이그레이션 파일 없음

### 영향도
**높음** - 세션/메시지 저장 기능이 없어 대화 이력이 유지되지 않습니다.

---

## 2. 검색 RPC (3장)

### 명세 요구사항
- `vibememory.search_project_chunks_rrf` 함수 (프로젝트 범위 RRF 검색)

### 현재 상태
⚠️ **부분 구현**
- `vibememory.hybrid_search_rrf` 함수는 존재함 (전체 프로젝트 검색)
- `p_project_id` 파라미터를 받아 프로젝트 필터링 가능
- 하지만 명세서의 `search_project_chunks_rrf` 전용 함수는 없음

### 현재 구현 (`hybrid_search_rrf`)
```typescript
// app/api/projects/[id]/chat/route.ts:115
const { data: searchResults, error: searchError } = await supabaseAdmin.rpc(
  'hybrid_search_rrf',
  {
    p_query_text: userMessage,
    p_query_embedding: queryEmbedding,
    p_project_id: projectId,  // 프로젝트 필터링 가능
    p_limit: 10,
    p_memory_bank_weight: 1.2,
  }
);
```

### 영향도
**낮음** - 현재 `hybrid_search_rrf`가 프로젝트 필터링을 지원하므로 기능적으로는 동일합니다. 다만 명세서의 전용 함수를 만들면 코드 가독성이 향상됩니다.

---

## 3. API 명세 (4장)

### 3.1 세션 관리 API

#### 명세 요구사항
- `POST /api/projects/[projectId]/chat/session` - 새 세션 생성
- `GET /api/projects/[projectId]/chat/sessions` - 세션 목록 조회
- `GET /api/projects/[projectId]/chat/sessions/[sessionId]/messages` - 메시지 조회

#### 현재 상태
❌ **미구현**
- 세션 관련 API 엔드포인트 없음
- 현재는 세션 없이 바로 메시지 전송

### 3.2 채팅 API

#### 명세 요구사항
- `POST /api/projects/[projectId]/chat` - SSE 스트리밍
- 이벤트: `token`, `sources`, `done`
- `fetchEventSource` 사용 (POST 본문 지원)

#### 현재 상태
⚠️ **부분 구현**
- `POST /api/projects/[id]/chat` 엔드포인트 존재
- `streamText` + `toTextStreamResponse()` 사용
- 하지만 `fetchEventSource` 대신 `DefaultChatTransport` + `useChat` 사용
- `sources` 이벤트 없음 (출처 정보 미전송)
- 메시지 저장 기능 없음

#### 현재 구현
```typescript
// components/ChatInterface.tsx:18
const { messages, sendMessage, status, error } = useChat({
  transport: new DefaultChatTransport({
    api: apiEndpoint,
    body: {
      projectId: projectId || null,
    },
  }),
});
```

#### 문제점
- `DefaultChatTransport`와 `toTextStreamResponse()` 호환성 문제로 현재 작동하지 않음
- 명세서에서 권장하는 `fetchEventSource` 방식과 다름

### 영향도
**높음** - 현재 챗봇이 작동하지 않는 주요 원인입니다.

---

## 4. 프롬프트 엔지니어링 (5장)

### 명세 요구사항
- SYSTEM 프롬프트: 근거 중심, 출처 인용, 불확실성 명시
- ASSISTANT 프롬프트: 컨텍스트 주입, 규칙 명시
- 출력 형식: 핵심 요약 + 참고 섹션

### 현재 상태
⚠️ **부분 구현**
- 기본적인 SYSTEM 프롬프트는 있음
- 하지만 명세서의 상세한 프롬프트 구조와 다름
- 출처 인용 형식이 없음
- 참고 섹션 형식이 없음

#### 현재 프롬프트
```typescript
// app/api/projects/[id]/chat/route.ts:181
const systemPrompt = `당신은 프로젝트 문서를 기반으로 질문에 답변하는 AI 비서입니다.

**답변 규칙:**
1. 제공된 컨텍스트를 우선적으로 사용하여 답변하세요.
2. 컨텍스트에서 관련 정보를 찾아 자연스럽게 설명하세요.
3. 컨텍스트에 정확한 답변이 없을 때만 "제공된 정보에 해당 내용이 없습니다."라고 말하세요.
4. 답변은 한국어로 작성하세요.
5. 가능하면 컨텍스트의 내용을 인용하거나 요약하여 답변하세요.`;
```

### 영향도
**중간** - 기본 기능은 작동하지만, 명세서의 상세한 프롬프트를 적용하면 품질이 향상됩니다.

---

## 5. UI/UX (6장)

### 명세 요구사항
- 세션 사이드바 (최근 n개, 검색 가능)
- 메시지 영역 (스트리밍)
- 출처 핀 (파일경로 클릭 시 GitHub 원문/Storage 링크)
- 상태 배너 (인덱싱 상태 표시)

### 현재 상태
⚠️ **부분 구현**
- 기본 메시지 영역 있음
- 스트리밍 UI 있음
- 하지만 세션 사이드바 없음
- 출처 표시 기능 없음
- 상태 배너는 ProgressBanner에 있지만 챗봇 화면과 연동 안 됨

### 영향도
**중간** - 기본 기능은 있지만, 명세서의 고급 UI 기능이 없습니다.

---

## 6. 운영/신뢰성 (7장)

### 6.1 SSE 구현 방식

#### 명세 요구사항
- `fetchEventSource` 사용 (POST 본문 지원)
- `EventSource` (GET 전용) 사용 금지

#### 현재 상태
⚠️ **부분 구현**
- `ProgressBanner`에서는 `fetchEventSource` 사용 ✅
- `ChatInterface`에서는 `DefaultChatTransport` 사용 ❌
- 명세서와 다른 방식으로 인해 호환성 문제 발생

### 6.2 벡터 삽입/검색 호환성

#### 명세 요구사항
- `float8[]` → `vector(1536)` 변환 안정화
- 차원 검증 추가

#### 현재 상태
✅ **구현됨**
- `insert_repo_file_chunks` RPC에서 변환 처리
- `hybrid_search_rrf`에서 `float8[]` 파라미터 사용

### 6.3 재스캔 409/작업 잠금

#### 명세 요구사항
- `claim_job` 호출 순서/잠금 해제 타이밍 조정
- `ingestion_runs` 생성까지 동기 보장

#### 현재 상태
✅ **구현됨**
- `force_claim_job` RPC 추가
- 재스캔 시 잠금 강제 해제 로직 구현

### 6.4 진행/상태 API

#### 명세 요구사항
- `get_project_progress` + `scan_progress`로 UI에 상시 표출

#### 현재 상태
✅ **구현됨**
- `get_project_progress` RPC 존재
- `ProgressBanner` 컴포넌트에서 사용

---

## 7. 보안/RLS/권한 (8장)

### 명세 요구사항
- 모든 챗 세션/메시지는 `owner_id=auth.uid()` RLS 정책
- 프로젝트 소유 확인 후에만 세션 생성/질의 허용

### 현재 상태
⚠️ **부분 구현**
- 프로젝트 소유 확인은 구현됨 ✅
- 하지만 세션/메시지 테이블이 없어 RLS 적용 불가 ❌

---

## 8. 구현 순서 (10장)

### 명세서 권장 순서
1. DB: 스키마 + RLS, RPC 적용
2. API: 세션/메시지 CRUD → `/chat` 스트리밍
3. 프롬프트: 템플릿 적용
4. UI: 세션 사이드바/출처 핀/상태 배너
5. 신뢰성: 409/float8[]/로깅/크론
6. 테스트: 시나리오 완료

### 현재 진행 상황
- ✅ 1단계: DB 스키마 (기본 테이블) - 완료
- ❌ 1단계: DB 스키마 (챗봇 테이블) - 미완료
- ⚠️ 2단계: API - 부분 완료 (채팅 API는 있지만 세션 API 없음)
- ⚠️ 3단계: 프롬프트 - 부분 완료
- ⚠️ 4단계: UI - 부분 완료
- ✅ 5단계: 신뢰성 - 대부분 완료
- ❌ 6단계: 테스트 - 미완료

---

## 주요 차이점 요약

| 항목 | 명세서 | 현재 구현 | 상태 |
|------|--------|----------|------|
| 세션/메시지 테이블 | `chat_sessions`, `chat_messages` | 없음 | ❌ 미구현 |
| 검색 RPC | `search_project_chunks_rrf` | `hybrid_search_rrf` (프로젝트 필터링 지원) | ⚠️ 부분 구현 |
| 세션 API | `/chat/session`, `/chat/sessions` | 없음 | ❌ 미구현 |
| 채팅 API | `POST /chat` (SSE, `fetchEventSource`) | `POST /chat` (`DefaultChatTransport`) | ⚠️ 부분 구현 (작동 안 함) |
| 프롬프트 | 상세한 템플릿 (출처 인용, 참고 섹션) | 기본 프롬프트 | ⚠️ 부분 구현 |
| UI | 세션 사이드바, 출처 핀 | 기본 메시지 영역만 | ⚠️ 부분 구현 |
| 메시지 저장 | DB에 저장 | 저장 안 함 | ❌ 미구현 |
| 출처 표시 | `sources` 이벤트 | 없음 | ❌ 미구현 |

---

## 우선순위별 권장 사항

### 🔴 긴급 (챗봇 작동 필수)
1. **SSE 구현 방식 변경**
   - `DefaultChatTransport` → `fetchEventSource`로 변경
   - 또는 `toTextStreamResponse()` 호환성 문제 해결
   - 현재 챗봇이 작동하지 않는 주요 원인

2. **메시지 형식 변환 문제 해결**
   - `convertToModelMessages()` 사용 시 에러 발생
   - `UIMessage[]` → `ModelMessage[]` 변환 로직 수정 필요

### 🟡 중요 (기능 완성도 향상)
3. **세션/메시지 테이블 생성**
   - 대화 이력 저장 기능
   - 세션 관리 API 구현

4. **출처 표시 기능**
   - `sources` 이벤트 추가
   - UI에 출처 핀 표시

5. **프롬프트 개선**
   - 명세서의 상세한 프롬프트 템플릿 적용
   - 출처 인용 형식 추가

### 🟢 선택 (UX 개선)
6. **세션 사이드바**
   - 최근 세션 목록
   - 세션 검색 기능

7. **상태 배너 연동**
   - 챗봇 화면에 인덱싱 상태 표시

---

## 결론

`해결책.md`는 현재 프로젝트 구조와 잘 맞는 명세서입니다. 하지만 실제 구현은 약 50% 정도만 완료되었으며, 특히 **세션/메시지 저장 기능**과 **SSE 스트리밍 방식**에서 차이가 있습니다.

**가장 시급한 문제**는 현재 챗봇이 작동하지 않는 것입니다. 이는 `DefaultChatTransport`와 `toTextStreamResponse()`의 호환성 문제로 보입니다. 명세서에서 권장하는 `fetchEventSource` 방식으로 변경하거나, 현재 방식의 호환성 문제를 해결해야 합니다.

**다음 단계**로는 세션/메시지 테이블 생성과 관련 API 구현이 필요합니다. 이를 통해 대화 이력을 저장하고 관리할 수 있게 됩니다.

