# í•´ê²°ì±….md ê²€í†  ë¦¬í¬íŠ¸

**ì‘ì„±ì¼**: 2025-11-15  
**ê²€í†  ëŒ€ìƒ**: `í•´ê²°ì±….md` - A, B, C ë°©ì•ˆ ì ìš© ì§€ì¹¨

---

## ğŸ“‹ ê²€í†  ìš”ì•½

ì œì‹œëœ **A, B, C ë°©ì•ˆ**ì€ Vercel íƒ€ì„ì•„ì›ƒ ë¬¸ì œë¥¼ í•´ê²°í•˜ëŠ” **íƒ€ë‹¹í•˜ê³  ì‹¤í˜„ ê°€ëŠ¥í•œ ì ‘ê·¼**ì…ë‹ˆë‹¤. ë‹¤ë§Œ ëª‡ ê°€ì§€ **ê¸°ìˆ ì  ë³´ì™„ ì‚¬í•­**ê³¼ **êµ¬í˜„ ì‹œ ì£¼ì˜ì **ì´ ìˆìŠµë‹ˆë‹¤.

**ì „ì²´ í‰ê°€**: â­â­â­â­ (4/5) - ì‹¤í˜„ ê°€ëŠ¥í•˜ë©° íš¨ê³¼ì ì´ì§€ë§Œ, ì¼ë¶€ ê¸°ìˆ ì  ì„¸ë¶€ì‚¬í•­ ë³´ì™„ í•„ìš”

---

## âœ… ê²€í†  ê²°ê³¼: ê° ë°©ì•ˆë³„ í‰ê°€

### [C] ë°±ê·¸ë¼ìš´ë“œ ì¡ ë¶„ë¦¬ (Vercel Cron) - â­â­â­â­

#### âœ… ì¥ì 
1. **íƒ€ì„ì•„ì›ƒ ë¬¸ì œ ì™„ì „ í•´ê²°**: Import APIê°€ ì¦‰ì‹œ ì‘ë‹µí•˜ë¯€ë¡œ 300ì´ˆ ì œí•œ íšŒí”¼
2. **ê¸°ì¡´ ì¸í”„ë¼ í™œìš©**: `ingestion_runs` í…Œì´ë¸”ì´ ì´ë¯¸ ì¡´ì¬í•˜ì—¬ ìƒíƒœ ê´€ë¦¬ ê°€ëŠ¥
3. **í™•ì¥ì„±**: ì—¬ëŸ¬ í”„ë¡œì íŠ¸ë¥¼ ìˆœì°¨ì ìœ¼ë¡œ ì²˜ë¦¬ ê°€ëŠ¥
4. **ì—ëŸ¬ ë³µêµ¬**: ì‹¤íŒ¨í•œ ì‘ì—…ì„ ì¬ì‹œë„í•˜ê¸° ì‰¬ì›€

#### âš ï¸ ë³´ì™„ í•„ìš” ì‚¬í•­

**1. ë°ì´í„°ë² ì´ìŠ¤ ìŠ¤í‚¤ë§ˆ í™•ì¸ í•„ìš”**
```typescript
// ì œì•ˆ: projects í…Œì´ë¸”ì— scan_status ì»¬ëŸ¼ ì¶”ê°€
// í˜„ì¬: ingestion_runs í…Œì´ë¸”ì˜ status ì‚¬ìš© ê°€ëŠ¥
```

**í˜„ì¬ ìƒíƒœ**:
- âœ… `ingestion_runs` í…Œì´ë¸” ì¡´ì¬ (`status`, `phase` ì»¬ëŸ¼)
- â“ `projects` í…Œì´ë¸”ì— `scan_status` ì»¬ëŸ¼ ì¡´ì¬ ì—¬ë¶€ ë¶ˆëª…
- âœ… `scan_progress` í…Œì´ë¸” ì¡´ì¬

**ê¶Œì¥ ì‚¬í•­**:
- `projects` í…Œì´ë¸”ì— `scan_status` ì»¬ëŸ¼ì„ ì¶”ê°€í•˜ëŠ” ëŒ€ì‹ , **`ingestion_runs` í…Œì´ë¸”ì„ í™œìš©**
- ê°€ì¥ ìµœê·¼ `ingestion_runs`ì˜ `status`ë¥¼ ê¸°ì¤€ìœ¼ë¡œ PENDING/PROCESSING íŒë‹¨

**2. Vercel Cron ì„¤ì •**
```json
// vercel.json (í˜„ì¬ ì—†ìŒ - ìƒì„± í•„ìš”)
{
  "crons": [
    {
      "path": "/api/cron/scan-worker",
      "schedule": "* * * * *"  // 1ë¶„ë§ˆë‹¤
    }
  ]
}
```

**ì£¼ì˜ì‚¬í•­**:
- Vercel Cronì€ **Pro í”Œëœ ì´ìƒ**ì—ì„œë§Œ ì‚¬ìš© ê°€ëŠ¥ (ë¬´ë£Œ í”Œëœ ì œí•œ)
- Cron Job ì‹¤í–‰ ì‹œê°„ ì œí•œ: **ìµœëŒ€ 60ì´ˆ** (Vercel Pro ê¸°ì¤€)
- 60ì´ˆ ë‚´ì— ì™„ë£Œë˜ì§€ ì•Šìœ¼ë©´ ë‹¤ìŒ Cron ì‹¤í–‰ ì‹œ ì¬ì‹œë„ í•„ìš”

**3. ì½”ë“œ ìˆ˜ì • ì‚¬í•­**

**í˜„ì¬ ì½”ë“œ** (`app/api/projects/import/route.ts:219`):
```typescript
// ë¹„ë™ê¸°ë¡œ ì‹¤í–‰ (íƒ€ì„ì•„ì›ƒ ìœ„í—˜)
runInitialScan(project.id, systemUser.githubAccessToken, repo_owner, repo_name).catch(...);
```

**ì œì•ˆëœ ë³€ê²½**:
```typescript
// ingestion_runsì— PENDING ìƒíƒœë¡œ ìƒì„±
const { data: newRun } = await supabaseAdmin
  .from('ingestion_runs')
  .insert({
    project_id: project.id,
    phase: 'indexing',
    status: 'pending',  // 'running' ëŒ€ì‹  'pending'
  });
```

**âš ï¸ ë¬¸ì œì **:
- `ingestion_runs.status`ëŠ” í˜„ì¬ `'running' | 'completed' | 'failed'`ë§Œ í—ˆìš©í•  ìˆ˜ ìˆìŒ
- ìŠ¤í‚¤ë§ˆ í™•ì¸ í•„ìš”: `'pending'` ìƒíƒœ ì¶”ê°€ ë˜ëŠ” ë³„ë„ í”Œë˜ê·¸ í•„ìš”

**4. Cron Worker êµ¬í˜„ ì‹œ ì£¼ì˜ì‚¬í•­**

**ì œì•ˆëœ ì½”ë“œì˜ ë¬¸ì œì **:
```typescript
// í•´ê²°ì±….mdì˜ ì˜ˆì‹œ ì½”ë“œ
const { data: project } = await supabaseAdmin
  .from('projects')
  .select('id, name, repo_url, owner_id')  // âŒ 'name' ì»¬ëŸ¼ ì—†ìŒ
  .eq('scan_status', 'PENDING');  // âŒ 'scan_status' ì»¬ëŸ¼ ì—†ì„ ìˆ˜ ìˆìŒ
```

**ìˆ˜ì • í•„ìš”**:
```typescript
// ingestion_runs ê¸°ì¤€ìœ¼ë¡œ PENDING ì‘ì—… ì°¾ê¸°
const { data: pendingRun } = await supabaseAdmin
  .from('ingestion_runs')
  .select('id, project_id, projects!inner(repo_owner, repo_name, owner_id)')
  .eq('status', 'pending')  // ë˜ëŠ” ë³„ë„ í”Œë˜ê·¸
  .order('created_at', { ascending: true })
  .limit(1)
  .single();
```

**5. runInitialScan í•¨ìˆ˜ ìˆ˜ì • í•„ìš”**

í˜„ì¬ `runInitialScan`ì€ `runId`ë¥¼ ì„ íƒì ìœ¼ë¡œ ë°›ì§€ë§Œ, Cron Workerì—ì„œëŠ” **ë°˜ë“œì‹œ `runId`ë¥¼ ì „ë‹¬**í•´ì•¼ í•©ë‹ˆë‹¤.

```typescript
// ìˆ˜ì • í•„ìš”: runInitialScanì´ runIdë¥¼ í•„ìˆ˜ë¡œ ë°›ë„ë¡
export async function runInitialScan(
  projectId: string,
  accessToken: string,
  repoOwner: string,
  repoName: string,
  runId: string  // í•„ìˆ˜ë¡œ ë³€ê²½
) {
  // ...
}
```

---

### [A] SSE 55ì´ˆ ë¡¤ë§ ìŠ¤íŠ¸ë¦¼ - â­â­â­

#### âœ… ì¥ì 
1. **íƒ€ì„ì•„ì›ƒ íšŒí”¼**: 55ì´ˆë§ˆë‹¤ ì¬ì—°ê²°í•˜ì—¬ 300ì´ˆ ì œí•œ íšŒí”¼
2. **ì‹¤ì‹œê°„ ì—…ë°ì´íŠ¸**: í´ë¼ì´ì–¸íŠ¸ê°€ ì§€ì†ì ìœ¼ë¡œ ì§„í–‰ ìƒí™© ìˆ˜ì‹ 
3. **ìë™ ì¬ì—°ê²°**: í´ë¼ì´ì–¸íŠ¸ ì¸¡ì—ì„œ ìë™ìœ¼ë¡œ ì¬ì—°ê²° ì²˜ë¦¬

#### âš ï¸ ë³´ì™„ í•„ìš” ì‚¬í•­

**1. Edge Runtime ì œì•½ì‚¬í•­**

**ì œì•ˆëœ ì½”ë“œ**:
```typescript
export const runtime = 'edge';  // âš ï¸ ë¬¸ì œ ê°€ëŠ¥ì„±
```

**ë¬¸ì œì **:
- Edge Runtimeì—ì„œëŠ” **Node.js API ì‚¬ìš© ë¶ˆê°€**
- `@supabase/supabase-js`ëŠ” Node.js í™˜ê²½ì—ì„œ ìµœì í™”ë¨
- Edge Runtimeì—ì„œ Supabase ì‚¬ìš© ì‹œ ì œí•œì‚¬í•­:
  - `fetch` APIë§Œ ì‚¬ìš© ê°€ëŠ¥ (âœ… ê°€ëŠ¥)
  - í™˜ê²½ ë³€ìˆ˜ ì ‘ê·¼ ê°€ëŠ¥ (âœ… ê°€ëŠ¥)
  - í•˜ì§€ë§Œ ì¼ë¶€ Supabase ê¸°ëŠ¥ ì œí•œ ê°€ëŠ¥

**í•´ê²° ë°©ì•ˆ**:
```typescript
// ì˜µì…˜ 1: Node.js Runtime ìœ ì§€ (ê¶Œì¥)
export const runtime = 'nodejs';  // ë˜ëŠ” ìƒëµ (ê¸°ë³¸ê°’)

// ì˜µì…˜ 2: Edge Runtime ì‚¬ìš© ì‹œ Supabase REST API ì§ì ‘ í˜¸ì¶œ
// (ë³µì¡ë„ ì¦ê°€, ê¶Œì¥í•˜ì§€ ì•ŠìŒ)
```

**2. í˜„ì¬ ì½”ë“œì™€ì˜ í˜¸í™˜ì„±**

**í˜„ì¬ ì½”ë“œ** (`app/api/projects/[id]/progress/stream/route.ts`):
- âœ… ì´ë¯¸ SSE ìŠ¤íŠ¸ë¦¼ êµ¬í˜„ë¨
- âœ… `ReadableStream` ì‚¬ìš©
- âŒ íƒ€ì„ì•„ì›ƒ ì œí•œ ì—†ìŒ (ë¬´í•œ ë£¨í”„ ê°€ëŠ¥)
- âŒ 55ì´ˆ ë¡¤ë§ ë¡œì§ ì—†ìŒ

**ì œì•ˆëœ ê°œì„ **:
```typescript
// 55ì´ˆ í›„ ìë™ ì¢…ë£Œ ë¡œì§ ì¶”ê°€
const endAt = Date.now() + 55_000;
while (Date.now() < endAt) {
  // ì§„í–‰ ìƒíƒœ ì¡°íšŒ ë° ì „ì†¡
  await new Promise(r => setTimeout(r, 2000));
}
controller.close();  // 55ì´ˆ í›„ ì¢…ë£Œ
```

**3. í•˜íŠ¸ë¹„íŠ¸ (Heartbeat) ì¶”ê°€**

ì œì•ˆëœ ì½”ë“œì˜ í•˜íŠ¸ë¹„íŠ¸ëŠ” ì¢‹ì€ ì•„ì´ë””ì–´ì…ë‹ˆë‹¤:
```typescript
const hb = setInterval(() => controller.enqueue(enc.encode(':\n\n')), 15000);
```

**í˜„ì¬ ì½”ë“œì— ì¶”ê°€ í•„ìš”**: âœ… ê¶Œì¥

---

### [B] UI ì¤‘ë³µ ìš”ì²­ ì œê±° - â­â­â­â­â­

#### âœ… ì™„ë²½í•œ ì œì•ˆ

**í˜„ì¬ ìƒíƒœ**:
- âœ… `ProgressBanner` ì»´í¬ë„ŒíŠ¸ê°€ ì´ë¯¸ `fetchEventSource` ì‚¬ìš©
- âœ… SSE ìë™ ì¬ì—°ê²° ë¡œì§ êµ¬í˜„ë¨
- âš ï¸ ì´ˆê¸° ë¡œë“œ ì‹œ í´ë§ API í˜¸ì¶œ (`/api/projects/${projectId}/progress`)

**ì œì•ˆëœ ê°œì„ **:
```typescript
// í˜„ì¬: ì´ˆê¸° ë¡œë“œ ì‹œ í´ë§ (components/ProgressBanner.tsx:43-78)
useEffect(() => {
  const fetchInitialProgress = async () => {
    const response = await fetch(`/api/projects/${projectId}/progress`);
    // ...
  };
  fetchInitialProgress();
}, [projectId]);

// ì œì•ˆ: ì œê±°í•˜ê³  SSEë§Œ ì‚¬ìš©
// (SSE ì—°ê²° ì‹œ ì´ˆê¸° ìƒíƒœë¥¼ ì¦‰ì‹œ ì „ì†¡í•˜ë¯€ë¡œ ë¶ˆí•„ìš”)
```

**í‰ê°€**: âœ… **ì™„ë²½í•œ ì œì•ˆ** - ì´ˆê¸° í´ë§ ì œê±°ë¡œ ì¤‘ë³µ ìš”ì²­ ì™„ì „ ì œê±°

---

## ğŸ”§ êµ¬ì²´ì  ìˆ˜ì • ì‚¬í•­

### 1. ë°ì´í„°ë² ì´ìŠ¤ ìŠ¤í‚¤ë§ˆ í™•ì¸ ë° ìˆ˜ì •

**í™•ì¸ í•„ìš”**:
```sql
-- ingestion_runs í…Œì´ë¸”ì˜ status ì»¬ëŸ¼ íƒ€ì… í™•ì¸
SELECT column_name, data_type, column_default
FROM information_schema.columns
WHERE table_schema = 'vibememory'
  AND table_name = 'ingestion_runs'
  AND column_name = 'status';
```

**í•„ìš” ì‹œ ë§ˆì´ê·¸ë ˆì´ì…˜**:
```sql
-- 'pending' ìƒíƒœ ì¶”ê°€ (ENUMì¸ ê²½ìš°)
ALTER TYPE ingestion_status ADD VALUE IF NOT EXISTS 'pending';

-- ë˜ëŠ” TEXT íƒ€ì…ì¸ ê²½ìš° ë³„ë„ ìˆ˜ì • ë¶ˆí•„ìš”
```

### 2. vercel.json ìƒì„±

```json
{
  "crons": [
    {
      "path": "/api/cron/scan-worker",
      "schedule": "* * * * *"
    }
  ]
}
```

**ì£¼ì˜**: Vercel Pro í”Œëœ í•„ìš” (ë¬´ë£Œ í”Œëœì—ì„œëŠ” Cron ì‚¬ìš© ë¶ˆê°€)

### 3. Cron Worker êµ¬í˜„ ìˆ˜ì •ì•ˆ

```typescript
// app/api/cron/scan-worker/route.ts
import { NextRequest, NextResponse } from 'next/server';
import { supabaseAdmin } from '@/lib/supabase';
import { runInitialScan } from '@/lib/runInitialScan';
import { getSystemUser, getSystemUserFromSupabase } from '@/lib/system-user';

export const dynamic = 'force-dynamic';

export async function GET(request: NextRequest) {
  // Cron Secret ê²€ì¦ (ë³´ì•ˆ)
  const authHeader = request.headers.get('authorization');
  if (authHeader !== `Bearer ${process.env.CRON_SECRET}`) {
    return NextResponse.json({ error: 'Unauthorized' }, { status: 401 });
  }

  // PENDING ìƒíƒœì˜ ingestion_run ì°¾ê¸°
  const { data: pendingRun, error: findError } = await supabaseAdmin
    .from('ingestion_runs')
    .select(`
      id,
      project_id,
      projects!inner(
        repo_owner,
        repo_name,
        owner_id
      )
    `)
    .eq('status', 'pending')  // ë˜ëŠ” ë³„ë„ í”Œë˜ê·¸
    .order('created_at', { ascending: true })
    .limit(1)
    .maybeSingle();

  if (findError || !pendingRun) {
    return NextResponse.json({ message: 'No pending jobs.' });
  }

  const project = pendingRun.projects;
  if (!project || Array.isArray(project)) {
    return NextResponse.json({ error: 'Invalid project data' }, { status: 500 });
  }

  // PROCESSING ìƒíƒœë¡œ ë³€ê²½
  await supabaseAdmin
    .from('ingestion_runs')
    .update({ status: 'running' })
    .eq('id', pendingRun.id);

  try {
    // ì‹œìŠ¤í…œ ì‚¬ìš©ì ì •ë³´ ê°€ì ¸ì˜¤ê¸°
    const systemUser = getSystemUser();
    if (!systemUser?.githubAccessToken) {
      throw new Error('GitHub Access Token not available');
    }

    // ì‹¤ì œ ìŠ¤ìº” ì‹¤í–‰
    await runInitialScan(
      pendingRun.project_id,
      systemUser.githubAccessToken,
      project.repo_owner,
      project.repo_name,
      pendingRun.id  // runId ì „ë‹¬
    );

    // ì™„ë£Œ ìƒíƒœëŠ” runInitialScan ë‚´ë¶€ì—ì„œ ì—…ë°ì´íŠ¸ë¨
    return NextResponse.json({ 
      message: `Project ${project.repo_name} processed successfully.` 
    });
  } catch (error) {
    // ì‹¤íŒ¨ ìƒíƒœ ì—…ë°ì´íŠ¸
    await supabaseAdmin
      .from('ingestion_runs')
      .update({ 
        status: 'failed',
        finished_at: new Date().toISOString()
      })
      .eq('id', pendingRun.id);

    console.error('Cron worker error:', error);
    return NextResponse.json(
      { error: `Failed to process project: ${error instanceof Error ? error.message : 'Unknown error'}` },
      { status: 500 }
    );
  }
}
```

### 4. Import API ìˆ˜ì •

```typescript
// app/api/projects/import/route.ts ìˆ˜ì •
// runInitialScan í˜¸ì¶œ ë¶€ë¶„ ë³€ê²½

// ê¸°ì¡´ (219-223ì¤„):
// runInitialScan(project.id, systemUser.githubAccessToken, repo_owner, repo_name).catch(...);

// ë³€ê²½:
// ingestion_runsì— PENDING ìƒíƒœë¡œ ìƒì„±
const { data: newRun, error: runError } = await supabaseAdmin
  .from('ingestion_runs')
  .insert({
    project_id: project.id,
    phase: 'indexing',
    status: 'pending',  // 'running' ëŒ€ì‹  'pending'
  })
  .select()
  .single();

if (runError) {
  console.error('[IMPORT] Error creating pending ingestion run:', runError);
  // ì—ëŸ¬ê°€ ë°œìƒí•´ë„ í”„ë¡œì íŠ¸ ìƒì„±ì€ ì„±ê³µìœ¼ë¡œ ì²˜ë¦¬
}
```

### 5. SSE Stream API ìˆ˜ì •

```typescript
// app/api/projects/[id]/progress/stream/route.ts
// 55ì´ˆ ë¡¤ë§ ë¡œì§ ì¶”ê°€

export async function GET(
  request: NextRequest,
  { params }: { params: Promise<{ id: string }> }
) {
  const { id: projectId } = await params;
  
  // ... (ê¸°ì¡´ ì¸ì¦ ë¡œì§)

  const stream = new ReadableStream({
    async start(controller) {
      const encoder = new TextEncoder();
      const sendEvent = (event: string, data: any) => {
        const message = `event: ${event}\ndata: ${JSON.stringify(data)}\n\n`;
        controller.enqueue(encoder.encode(message));
      };

      // ì¦‰ì‹œ ì—°ê²° ì•Œë¦¼
      sendEvent('ready', { ok: true });

      // í•˜íŠ¸ë¹„íŠ¸ (15ì´ˆë§ˆë‹¤)
      const hb = setInterval(() => {
        controller.enqueue(encoder.encode(':\n\n'));
      }, 15000);

      // 55ì´ˆ ë™ì•ˆë§Œ ì‹¤í–‰
      const endAt = Date.now() + 55_000;
      
      while (Date.now() < endAt) {
        try {
          // ì§„í–‰ ìƒíƒœ ì¡°íšŒ
          const { data: latestRun } = await supabaseAdmin
            .from('ingestion_runs')
            .select('*')
            .eq('project_id', projectId)
            .order('created_at', { ascending: false })
            .limit(1)
            .maybeSingle();

          if (latestRun) {
            const { data: progressData } = await supabaseAdmin.rpc('get_project_progress', {
              p_project_id: projectId,
            });

            sendEvent('phase', {
              phase: latestRun.phase,
              status: latestRun.status,
            });

            if (progressData) {
              sendEvent('counters', {
                md_total: progressData.P1?.total_md || 0,
                md_indexed: progressData.P1?.indexed_md || 0,
                chunk_total: progressData.P2?.embedded_chunks || 0,
                review_done: progressData.P3?.core_done || 0,
                review_total: progressData.P3?.core_total || 4,
              });
            }

            // ì™„ë£Œ ë˜ëŠ” ì‹¤íŒ¨ ì‹œ ì¡°ê¸° ì¢…ë£Œ
            if (latestRun.status === 'completed' || latestRun.status === 'failed') {
              sendEvent('done', {
                status: latestRun.status,
                phase: latestRun.phase,
              });
              break;
            }
          }
        } catch (error) {
          console.error('Error in SSE stream:', error);
        }

        // 2ì´ˆ ëŒ€ê¸°
        await new Promise(resolve => setTimeout(resolve, 2000));
      }

      // 55ì´ˆ ê²½ê³¼ ë˜ëŠ” ì™„ë£Œ ì‹œ ì •ë¦¬
      clearInterval(hb);
      sendEvent('done', { message: 'Stream ended' });
      controller.close();
    },
  });

  return new Response(stream, {
    headers: {
      'Content-Type': 'text/event-stream',
      'Cache-Control': 'no-cache',
      'Connection': 'keep-alive',
    },
  });
}
```

### 6. ProgressBanner ì»´í¬ë„ŒíŠ¸ ìˆ˜ì •

```typescript
// components/ProgressBanner.tsx
// ì´ˆê¸° í´ë§ ì œê±°, SSEë§Œ ì‚¬ìš©

export default function ProgressBanner({ projectId }: ProgressBannerProps) {
  // ... (ê¸°ì¡´ state)

  // âŒ ì œê±°: ì´ˆê¸° í´ë§ ë¡œì§ (43-78ì¤„)
  // useEffect(() => {
  //   const fetchInitialProgress = async () => { ... };
  //   fetchInitialProgress();
  // }, [projectId]);

  // âœ… ìœ ì§€: SSE ì—°ê²° ë¡œì§ (80-136ì¤„)
  useEffect(() => {
    // ... (ê¸°ì¡´ SSE ì—°ê²° ë¡œì§)
    // 'done' ì´ë²¤íŠ¸ ìˆ˜ì‹  ì‹œ ì¬ì—°ê²°í•˜ì§€ ì•Šë„ë¡ ìˆ˜ì •
    onmessage(event) {
      if (event.event === 'done') {
        setPhase(data);
        setIsConnected(false);
        closed = true;  // ì¬ì—°ê²° ë°©ì§€
        if (abortController) {
          abortController.abort();
        }
        return;
      }
      // ... (ê¸°ì¡´ ë¡œì§)
    },
  }, [projectId]);
}
```

---

## âš ï¸ ì ì¬ì  ë¬¸ì œì  ë° í•´ê²° ë°©ì•ˆ

### 1. Vercel Cron í”Œëœ ì œí•œ

**ë¬¸ì œ**: Vercel ë¬´ë£Œ í”Œëœì—ì„œëŠ” Cron Job ì‚¬ìš© ë¶ˆê°€

**í•´ê²° ë°©ì•ˆ**:
- **ì˜µì…˜ A**: Vercel Pro í”Œëœ ì‚¬ìš© (ê¶Œì¥)
- **ì˜µì…˜ B**: ì™¸ë¶€ Cron ì„œë¹„ìŠ¤ ì‚¬ìš© (GitHub Actions, cron-job.org ë“±)
- **ì˜µì…˜ C**: ì‚¬ìš©ì ìš”ì²­ ì‹œ ìˆ˜ë™ íŠ¸ë¦¬ê±° API ì œê³µ

### 2. Cron Job ì‹¤í–‰ ì‹œê°„ ì œí•œ

**ë¬¸ì œ**: Vercel Cronì€ ìµœëŒ€ 60ì´ˆ ì‹¤í–‰ ì‹œê°„ ì œí•œ

**í•´ê²° ë°©ì•ˆ**:
- `runInitialScan`ì´ 60ì´ˆ ë‚´ì— ì™„ë£Œë˜ì§€ ì•Šì„ ìˆ˜ ìˆìŒ
- **ì²´í¬í¬ì¸íŠ¸ íŒ¨í„´**: ì‘ì—…ì„ ì—¬ëŸ¬ ë‹¨ê³„ë¡œ ë‚˜ëˆ„ì–´ ê° ë‹¨ê³„ ì™„ë£Œ ì‹œ ìƒíƒœ ì—…ë°ì´íŠ¸
- ë‹¤ìŒ Cron ì‹¤í–‰ ì‹œ ì´ì–´ì„œ ì§„í–‰

### 3. Edge Runtime ì œì•½ì‚¬í•­

**ë¬¸ì œ**: Edge Runtimeì—ì„œ Supabase ì‚¬ìš© ì‹œ ì œí•œ ê°€ëŠ¥

**í•´ê²° ë°©ì•ˆ**:
- **Node.js Runtime ìœ ì§€** (ê¶Œì¥): íƒ€ì„ì•„ì›ƒ ë¬¸ì œëŠ” 55ì´ˆ ë¡¤ë§ìœ¼ë¡œ í•´ê²°
- Edge Runtime ì‚¬ìš© ì‹œ: Supabase REST API ì§ì ‘ í˜¸ì¶œ (ë³µì¡ë„ ì¦ê°€)

### 4. ë™ì‹œì„± ì œì–´

**ë¬¸ì œ**: ì—¬ëŸ¬ Cron ì‹¤í–‰ì´ ë™ì‹œì— ê°™ì€ ì‘ì—…ì„ ì²˜ë¦¬í•  ìˆ˜ ìˆìŒ

**í•´ê²° ë°©ì•ˆ**:
- âœ… `job_locks` í…Œì´ë¸” í™œìš© (ì´ë¯¸ êµ¬í˜„ë¨)
- Cron Workerì—ì„œë„ `claim_job` RPC ì‚¬ìš©

```typescript
// Cron Workerì— ì¶”ê°€
const jobName = `scan:${pendingRun.project_id}`;
const { data: claimResult } = await supabaseAdmin.rpc('claim_job', {
  p_job_name: jobName,
  p_duration: '1 hour',
});

if (!claimResult) {
  return NextResponse.json({ message: 'Job already claimed' });
}
```

---

## ğŸ“Š êµ¬í˜„ ìš°ì„ ìˆœìœ„

### Phase 1: ì¦‰ì‹œ ì ìš© ê°€ëŠ¥ (High Impact, Low Risk)

1. âœ… **[B] UI ì¤‘ë³µ ìš”ì²­ ì œê±°**
   - ì´ˆê¸° í´ë§ ì œê±°
   - ì˜ˆìƒ ì‹œê°„: 30ë¶„
   - ìœ„í—˜ë„: ë‚®ìŒ

2. âœ… **[A] SSE 55ì´ˆ ë¡¤ë§ ìŠ¤íŠ¸ë¦¼**
   - íƒ€ì„ì•„ì›ƒ ë°©ì§€ ë¡œì§ ì¶”ê°€
   - ì˜ˆìƒ ì‹œê°„: 1ì‹œê°„
   - ìœ„í—˜ë„: ë‚®ìŒ

### Phase 2: ì‹ ì¤‘í•œ ê²€í†  í›„ ì ìš© (High Impact, Medium Risk)

3. âš ï¸ **[C] ë°±ê·¸ë¼ìš´ë“œ ì¡ ë¶„ë¦¬**
   - ë°ì´í„°ë² ì´ìŠ¤ ìŠ¤í‚¤ë§ˆ í™•ì¸ í•„ìš”
   - Vercel Cron í”Œëœ í™•ì¸ í•„ìš”
   - ì˜ˆìƒ ì‹œê°„: 2-3ì‹œê°„
   - ìœ„í—˜ë„: ì¤‘ê°„

---

## ğŸ¯ ìµœì¢… ê¶Œì¥ ì‚¬í•­

### ì¦‰ì‹œ ì ìš© (Phase 1)

1. **SSE 55ì´ˆ ë¡¤ë§ ìŠ¤íŠ¸ë¦¼ ì ìš©**
   - íƒ€ì„ì•„ì›ƒ ë¬¸ì œ í•´ê²°
   - ê¸°ì¡´ ì½”ë“œ ìˆ˜ì • ìµœì†Œí™”
   - ìœ„í—˜ë„ ë‚®ìŒ

2. **UI ì¤‘ë³µ ìš”ì²­ ì œê±°**
   - ì´ˆê¸° í´ë§ ì œê±°
   - ì„œë²„ ë¶€í•˜ ê°ì†Œ
   - ìœ„í—˜ë„ ë‚®ìŒ

### ê²€í†  í›„ ì ìš© (Phase 2)

3. **ë°±ê·¸ë¼ìš´ë“œ ì¡ ë¶„ë¦¬**
   - Vercel Pro í”Œëœ í™•ì¸
   - ë°ì´í„°ë² ì´ìŠ¤ ìŠ¤í‚¤ë§ˆ í™•ì¸ ë° ìˆ˜ì •
   - í…ŒìŠ¤íŠ¸ í™˜ê²½ì—ì„œ ì¶©ë¶„í•œ ê²€ì¦ í›„ ì ìš©

---

## ğŸ“ ì¶”ê°€ ì œì•ˆ

### ëŒ€ì•ˆ: Vercel Cron ëŒ€ì‹  ì¦‰ì‹œ ì‹¤í–‰ í

Vercel Pro í”Œëœì´ ì—†ëŠ” ê²½ìš°, **ì¦‰ì‹œ ì‹¤í–‰ í íŒ¨í„´** ì‚¬ìš©:

```typescript
// app/api/projects/import/route.ts
// runInitialScanì„ ì¦‰ì‹œ ì‹¤í–‰í•˜ë˜, íƒ€ì„ì•„ì›ƒ ê±±ì • ì—†ì´

// ì˜µì…˜: Vercelì˜ Background Functions í™œìš©
// (Next.js 15+ì—ì„œ ì§€ì›)
```

í•˜ì§€ë§Œ ì´ ë°©ë²•ë„ Vercel Pro í”Œëœì´ í•„ìš”í•  ìˆ˜ ìˆìœ¼ë¯€ë¡œ, **SSE 55ì´ˆ ë¡¤ë§ë§Œìœ¼ë¡œë„ ì¶©ë¶„íˆ ë¬¸ì œ í•´ê²° ê°€ëŠ¥**í•©ë‹ˆë‹¤.

---

## âœ… ê²°ë¡ 

ì œì‹œëœ í•´ê²°ì±…ì€ **íƒ€ë‹¹í•˜ê³  ì‹¤í˜„ ê°€ëŠ¥**í•©ë‹ˆë‹¤. íŠ¹íˆ:

1. âœ… **[B] UI ì¤‘ë³µ ìš”ì²­ ì œê±°**: ì¦‰ì‹œ ì ìš© ê¶Œì¥
2. âœ… **[A] SSE 55ì´ˆ ë¡¤ë§**: ì¦‰ì‹œ ì ìš© ê¶Œì¥
3. âš ï¸ **[C] ë°±ê·¸ë¼ìš´ë“œ ì¡ ë¶„ë¦¬**: í”Œëœ ë° ìŠ¤í‚¤ë§ˆ í™•ì¸ í›„ ì ìš©

**Phase 1ë§Œ ì ìš©í•´ë„ íƒ€ì„ì•„ì›ƒ ë¬¸ì œëŠ” ëŒ€ë¶€ë¶„ í•´ê²°**ë˜ë©°, Phase 2ëŠ” ì¶”ê°€ ì•ˆì •ì„±ê³¼ í™•ì¥ì„±ì„ ì œê³µí•©ë‹ˆë‹¤.
