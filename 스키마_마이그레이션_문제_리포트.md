# 스키마 마이그레이션 후 프로젝트 조회 실패 문제 리포트

> **작성일**: 2025-01-XX  
> **문제 발생 시점**: vibememory 스키마 명시적 사용으로 전환 후  
> **상태**: 🔴 **미해결**

---

## 📋 문제 요약

프로젝트 목록은 정상적으로 불러와지지만, 개별 프로젝트의 세부 정보(스크린샷, 분석 등)를 조회할 때 "프로젝트를 찾을 수 없습니다" 에러가 발생합니다.

---

## 🔍 증상

### 1. 정상 작동하는 기능
- ✅ 프로젝트 목록 조회 (`GET /api/projects`)
  - `get_user_projects` RPC 함수 사용 (public 스키마)
  - 프로젝트 목록이 정상적으로 표시됨

### 2. 실패하는 기능
- ❌ 스크린샷 조회 (`GET /api/projects/[id]/screenshots`)
  - 에러: "프로젝트를 찾을 수 없습니다."
  - 위치: `components/ScreenshotGallery.tsx:37`
  
- ❌ 프로젝트 분석 조회 (`GET /api/projects/[id]/analysis`)
  - 에러: 404
  - 위치: `app/dashboard/projects/[id]/page.tsx:386`

---

## 🔧 수정 내역

### 완료된 수정 사항

1. **`lib/supabase.ts`**
   - 기본 스키마를 `vibememory`로 설정
   ```typescript
   db: {
     schema: 'vibememory',
   }
   ```

2. **Public 래퍼 함수 호출 수정**
   - `hybrid_search_rrf` → `.schema('public').rpc()`
   - `claim_job` → `.schema('public').rpc()`
   - `get_project_progress` → `.schema('public').rpc()`
   - `get_user_projects` → `.schema('public').rpc()`

3. **주요 API 파일에 스키마 명시 추가**
   - `app/api/projects/route.ts`
   - `app/api/projects/[id]/screenshots/route.ts`
   - `app/api/projects/[id]/analysis/route.ts`
   - `app/api/projects/[id]/chat/route.ts`
   - `app/api/projects/[id]/comments/route.ts`
   - `app/api/projects/[id]/progress/route.ts`
   - `app/api/projects/[id]/route.ts`

---

## 🐛 문제 분석

### 가능한 원인

#### 1. 기본 스키마 설정이 제대로 작동하지 않음
- **증상**: 기본 스키마를 `vibememory`로 설정했지만, 일부 쿼리에서 적용되지 않을 수 있음
- **확인 필요**: Supabase JS 클라이언트의 `db: { schema }` 옵션이 모든 쿼리에 일관되게 적용되는지

#### 2. 프로젝트 조회 쿼리 실패
- **증상**: 프로젝트 목록에서는 보이지만, 개별 조회 시 찾을 수 없음
- **가능한 원인**:
  - `owner_id` 불일치
  - 프로젝트 ID 형식 문제
  - 스키마 접근 권한 문제

#### 3. Public 뷰와 실제 테이블 간 불일치
- **증상**: Public 뷰를 통해 목록은 조회되지만, 직접 테이블 접근 시 실패
- **가능한 원인**:
  - Public 뷰가 최신 상태가 아님
  - RLS 정책이 뷰와 테이블에서 다르게 작동

#### 4. 스키마 체이닝 문제
- **증상**: `.schema('vibememory')`를 명시했지만 여전히 실패
- **가능한 원인**:
  - Supabase 클라이언트 버전 문제
  - 스키마 체이닝이 제대로 작동하지 않음

---

## 🔬 디버깅 필요 사항

### 1. 서버 로그 확인
다음 정보를 확인해야 합니다:

```typescript
// app/api/projects/[id]/screenshots/route.ts에서 로그 출력
console.error('[SCREENSHOTS] Project not found:', {
  projectId,
  ownerId: user.id,
  error: projectError,
  errorCode: projectError?.code,        // 예: PGRST106, PGRST116
  errorMessage: projectError?.message,
});
```

**확인할 에러 코드:**
- `PGRST106`: 스키마를 찾을 수 없음
- `PGRST116`: 행을 찾을 수 없음 (정상적인 경우일 수도 있음)
- `PGRST205`: 관계를 찾을 수 없음

### 2. 데이터베이스 상태 확인

다음 쿼리로 실제 데이터 확인:

```sql
-- 프로젝트가 실제로 존재하는지 확인
SELECT id, owner_id, project_name, repo_name 
FROM vibememory.projects 
LIMIT 10;

-- 시스템 사용자 ID 확인
SELECT id, email 
FROM auth.users 
WHERE email = '시스템_사용자_이메일';

-- 프로젝트와 소유자 매칭 확인
SELECT p.id, p.owner_id, u.id as user_id, u.email
FROM vibememory.projects p
JOIN auth.users u ON p.owner_id = u.id
LIMIT 10;
```

### 3. 스키마 접근 권한 확인

```sql
-- vibememory 스키마 접근 권한 확인
SELECT schema_name, schema_owner
FROM information_schema.schemata
WHERE schema_name = 'vibememory';

-- public 뷰 상태 확인
SELECT viewname, definition
FROM pg_views
WHERE schemaname = 'public'
  AND viewname = 'projects';
```

---

## 💡 해결 방안

### 방안 1: 모든 쿼리에 명시적 스키마 지정 (진행 중)

현재 진행 중인 방법입니다. 모든 `.from()` 호출에 `.schema('vibememory')`를 추가합니다.

**장점:**
- 명시적이고 안전함
- 다른 프로젝트와의 충돌 방지

**단점:**
- 많은 파일 수정 필요
- 코드 중복

### 방안 2: Public 뷰를 통한 일관된 접근

모든 쿼리를 public 뷰를 통해 접근하도록 변경:

```typescript
// 기본 스키마를 public으로 설정
export const supabaseAdmin = createClient(
  process.env.NEXT_PUBLIC_SUPABASE_URL!,
  process.env.SUPABASE_SERVICE_ROLE_KEY!,
  {
    db: { schema: 'public' }  // public 뷰 사용
  }
);
```

**장점:**
- 코드 수정 최소화
- 기존 동작과 일치

**단점:**
- 다른 프로젝트와 테이블 이름 충돌 가능
- 뷰 성능 오버헤드 (미미함)

### 방안 3: 헬퍼 함수 사용

스키마를 명시하는 헬퍼 함수 생성:

```typescript
// lib/supabase-utils.ts
export function getVibememoryClient() {
  return supabaseAdmin.schema('vibememory');
}

// 사용
const { data } = await getVibememoryClient()
  .from('projects')
  .select('*');
```

**장점:**
- 명시적이고 재사용 가능
- 타입 안전성

**단점:**
- 모든 파일에서 함수 변경 필요

### 방안 4: 실제 데이터 확인 및 디버깅

1. 프로젝트가 실제로 데이터베이스에 존재하는지 확인
2. `owner_id`가 시스템 사용자 ID와 일치하는지 확인
3. 서버 로그에서 실제 에러 코드 확인

---

## 📝 다음 단계

### 즉시 확인 필요

1. **서버 콘솔 로그 확인**
   - 실제 에러 코드 (PGRST106, PGRST116 등)
   - 에러 메시지 상세 내용
   - 프로젝트 ID와 소유자 ID 값

2. **데이터베이스 직접 확인**
   - 프로젝트가 실제로 존재하는지
   - `owner_id`가 올바른지
   - 스키마 접근 권한이 있는지

3. **테스트 쿼리 실행**
   ```typescript
   // 테스트용 API 엔드포인트 생성
   // GET /api/test/project-check?projectId=xxx
   ```

### 권장 해결 순서

1. ✅ **서버 로그 확인** - 실제 에러 코드 파악
2. ✅ **데이터베이스 직접 확인** - 프로젝트 존재 여부 확인
3. ⚠️ **방안 2 시도** - Public 뷰를 통한 접근으로 임시 해결
4. 🔄 **방안 1 완료** - 모든 파일에 스키마 명시 (현재 진행 중)

---

## 🔍 추가 조사 필요 사항

### 1. Supabase 클라이언트 버전 확인

```json
// package.json
"@supabase/supabase-js": "버전"
```

일부 버전에서 `db: { schema }` 옵션이 제대로 작동하지 않을 수 있습니다.

### 2. 실제 프로젝트 데이터 확인

프로젝트 목록에서 보이는 프로젝트 ID를 사용하여 직접 조회 테스트:

```typescript
// 테스트 코드
const testProjectId = '목록에서_보이는_프로젝트_ID';
const { data, error } = await supabaseAdmin
  .schema('vibememory')
  .from('projects')
  .select('*')
  .eq('id', testProjectId)
  .single();

console.log('Test result:', { data, error });
```

### 3. RLS 정책 확인

Service Role Key를 사용하므로 RLS를 우회해야 하지만, 확인 필요:

```sql
-- RLS 정책 확인
SELECT schemaname, tablename, policyname, permissive, roles, cmd, qual
FROM pg_policies
WHERE schemaname = 'vibememory'
  AND tablename = 'projects';
```

---

## 📊 영향 범위

### 영향받는 기능
- ❌ 프로젝트 상세 페이지
- ❌ 스크린샷 갤러리
- ❌ 프로젝트 분석 조회
- ❌ 챗봇 세션 조회
- ❌ 프로젝트 댓글 조회

### 영향받지 않는 기능
- ✅ 프로젝트 목록 조회
- ✅ 프로젝트 생성
- ✅ 프로젝트 임포트

---

## 🎯 우선순위

1. **높음**: 서버 로그 확인 및 실제 에러 코드 파악
2. **높음**: 데이터베이스 직접 확인 (프로젝트 존재 여부)
3. **중간**: Public 뷰를 통한 임시 해결책 적용
4. **낮음**: 모든 파일에 스키마 명시 완료 (장기적 해결)

---

## 📌 참고 사항

- 기본 스키마 설정(`db: { schema: 'vibememory' }`)이 모든 쿼리에 일관되게 적용되는지 확인 필요
- Supabase JS 클라이언트 문서에서 스키마 설정 동작 방식 확인 필요
- Public 뷰가 최신 상태인지 확인 필요

### 기술 스택 정보

- **Supabase JS 버전**: `@supabase/supabase-js@^2.81.1`
- **Next.js 버전**: `16.0.3`
- **PostgreSQL 버전**: `17.6.1.044`

### Supabase JS 스키마 설정 동작

`@supabase/supabase-js@2.81.1` 버전에서 `db: { schema }` 옵션이 제대로 작동하는지 확인이 필요합니다. 일부 버전에서는 이 옵션이 모든 쿼리에 일관되게 적용되지 않을 수 있습니다.

---

## 🔧 즉시 시도할 수 있는 해결책

### 해결책 1: Public 뷰로 전환 (빠른 해결)

기본 스키마를 `public`으로 변경하여 public 뷰를 통해 접근:

```typescript
// lib/supabase.ts
export const supabaseAdmin = createClient(
  supabaseUrl || 'https://placeholder.supabase.co',
  supabaseServiceRoleKey || 'placeholder-service-role-key',
  {
    auth: {
      autoRefreshToken: false,
      persistSession: false,
    },
    db: {
      schema: 'public',  // public 뷰 사용
    },
  }
);
```

**장점:**
- 즉시 작동 가능
- 코드 수정 최소화

**단점:**
- 다른 프로젝트와 테이블 이름 충돌 가능성

### 해결책 2: 모든 쿼리에 명시적 스키마 지정 (완료 필요)

현재 진행 중인 방법을 완료:

- ✅ 주요 API 파일 수정 완료
- ⚠️ 나머지 API 파일들도 확인 및 수정 필요
- ⚠️ lib 파일들 확인 및 수정 필요

### 해결책 3: 테스트 엔드포인트 생성

디버깅을 위한 테스트 API 생성:

```typescript
// app/api/test/project-check/route.ts
export async function GET(request: NextRequest) {
  const { searchParams } = new URL(request.url);
  const projectId = searchParams.get('projectId');
  
  const user = await getSystemUserFromSupabase();
  
  // 다양한 방법으로 프로젝트 조회 시도
  const results = {
    withDefaultSchema: await supabaseAdmin.from('projects').select('*').eq('id', projectId).single(),
    withExplicitSchema: await supabaseAdmin.schema('vibememory').from('projects').select('*').eq('id', projectId).single(),
    withPublicView: await supabaseAdmin.schema('public').from('projects').select('*').eq('id', projectId).single(),
    user: { id: user?.id, email: user?.email },
  };
  
  return NextResponse.json(results);
}
```

---

**리포트 버전**: 1.1  
**최종 업데이트**: 2025-01-XX

